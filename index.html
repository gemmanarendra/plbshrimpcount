<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PLBShrimpCount V8.0</title>

<link rel="icon" type="image/jpeg" href="logo-plb.png">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;700&display=swap" rel="stylesheet">
<style>
/* --- [REVISI] VARIABEL AKAR & STANDAR (TEMA BIRU MODERN) --- */
:root {
  /* Palet Aksen Biru */
  --color-accent: #0D69C2; /* Biru PLB yang lebih kuat */
  --color-accent-light: #E7F0F8; /* Latar belakang/hover biru sangat muda */
  --color-accent-text: #FFFFFF; /* Teks di atas aksen (putih) */
  
  /* Palet UI Utama (Light) */
  --color-bg: #F4F7FA; /* Latar belakang body (putih kebiruan) */
  --color-card-bg: #FFFFFF; /* Latar kartu (putih bersih) */
  --color-tab-nav-bg: #EAF0F6; /* Latar navigasi tab */
  
  /* Palet Header */
  --color-header-bg: #0D69C2; /* Header biru solid */
  --color-header-text: #FFFFFF;
  --color-header-btn-bg: #0A5499; /* Tombol di header (lebih gelap) */
  --color-header-btn-text: #FFFFFF;
  
  /* Palet Teks */
  --color-text-main: #212529; /* Teks utama (hitam pekat) */
  --color-text-light: #5A6A7B; /* Teks sekunder (abu-abu kebiruan) */
  --color-text-lighter: #8A9BAB; /* Teks (mis. timestamp) */
  
  /* Palet Umum */
  --color-border: #DDE4EE; /* Border umum & input */
  --color-input-bg: #FFFFFF;
  --color-shadow: rgba(13, 105, 194, 0.1); /* Bayangan berbasis biru */
  --color-shadow-dark: rgba(13, 105, 194, 0.15);

  /* Palet Semantik (Peringatan, Sukses) */
  --color-text-sum: #198754; /* Hijau untuk sukses/total */
  --color-alert-text: #E65200; /* Oranye untuk peringatan */
  --color-delete-text: #DC3545;
  --color-tester-result-bg: #E8F5E9; /* Latar hijau muda */
  --color-tester-result-text: #1E6A21;
  --color-card-hitung-border: #c8e6c9;

  /* Metrik Desain */
  --font-main:'Poppins',sans-serif;
  --font-weight-thin:300;
  --radius-card: 12px;
  --radius-input: 8px;
  --shadow-card: 0 4px 12px var(--color-shadow);
  
  /* Variabel lama (disesuaikan atau tidak terpakai) */
  --color-header-bg1: var(--color-header-bg); /* Disesuaikan */
  --color-header-bg2: var(--color-header-bg); /* Disesuaikan */
  --color-card-tester: var(--color-accent-light); /* Disesuaikan */
  --color-card-hitung: var(--color-accent-light); /* Disesuaikan */
  --color-text-sj: var(--color-accent); /* Disesuaikan */
  --color-calc-bg: #4a4a4a;
  --color-calc-display: #e8f5f9;
  --color-calc-operator: #ff9500;
  --color-card-recap: #FAFCFE;
  --color-recap-label: var(--color-text-light);
  --color-recap-value: var(--color-text-main);
  --color-recap-border: var(--color-border);
  --color-card-tester-border: var(--color-border);
}

/* === [REVISI] Mode Gelap (TEMA BIRU MODERN) === */
body.dark-mode {
  /* Palet Aksen Biru (Dark) */
  --color-accent: #58A6FF; /* Biru muda yang cerah */
  --color-accent-light: #2A3B50; /* Latar biru tua */
  --color-accent-text: #FFFFFF; /* Teks di atas aksen (putih) */

  /* Palet UI Utama (Dark) */
  --color-bg: #0F172A; /* Latar body (biru sangat tua) */
  --color-card-bg: #1E293B; /* Latar kartu (biru tua) */
  --color-tab-nav-bg: #0F172A; /* Latar nav tab (sama dgn body) */
  
  /* Palet Header (Dark) */
  --color-header-bg: #1E293B; /* Header (sama dgn kartu) */
  --color-header-text: #F1F5F9;
  --color-header-btn-bg: #334155; /* Tombol di header (lebih cerah) */
  --color-header-btn-text: #F1F5F9;
  
  /* Palet Teks (Dark) */
  --color-text-main: #F1F5F9; /* Teks utama (putih kebiruan) */
  --color-text-light: #94A3B8; /* Teks sekunder */
  --color-text-lighter: #64748B; /* Teks timestamp */
  
  /* Palet Umum (Dark) */
  --color-border: #334155; /* Border */
  --color-input-bg: #283447;
  --color-shadow: rgba(0, 0, 0, 0.2);
  --color-shadow-dark: rgba(0, 0, 0, 0.3);

  /* Palet Semantik (Dark) */
  --color-text-sum: #6EE7B7; /* Hijau cerah */
  --color-alert-text: #FFAB40; /* Oranye cerah */
  --color-delete-text: #F87171;
  --color-tester-result-bg: #1C3A2A;
  --color-tester-result-text: #6EE7B7;
  --color-card-hitung-border: #2A462C;

  /* Variabel lama (disesuaikan) */
  --color-card-tester: var(--color-card-bg);
  --color-card-hitung: var(--color-card-bg);
  --color-text-sj: var(--color-accent);
  --color-calc-bg: #3a3a3a;
  --color-calc-display: #222;
  --color-card-recap: var(--color-card-bg);
  --color-recap-label: var(--color-text-light);
  --color-recap-value: var(--color-text-main);
  --color-recap-border: var(--color-border);
  --color-card-tester-border: var(--color-border);
}
/* === [AKHIR] Mode Gelap === */

*{box-sizing:border-box}

/* === [REVISI] KUNCI LAYOUT 1: HTML & BODY === */
html {
  height: 100dvh; 
}
body{
  margin:0;font-family:var(--font-main);
  font-weight:var(--font-weight-thin);
  background:var(--color-bg);color:var(--color-text-main);
  transition: background .3s, color .3s;
  font-size: 12px;
  display: flex;
  flex-direction: column;
  height: 100dvh; 
  overflow: hidden;
  align-items: center; /* <-- carousel selalu ditengah layar di mode mobile */
}
/* Animasi */
@keyframes fadeSlideIn{from{opacity:0;transform:translateY(25px)}to{opacity:1;transform:translateY(0)}}
@keyframes simpleFadeIn{from{opacity:0}to{opacity:1}}
@keyframes simpleFadeOut{from{opacity:1}to{opacity:0}}

/* [REVISI V6.3] Animasi Vault baru (Spring/Pop) */
@keyframes vaultIn {
  from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
  to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}
@keyframes vaultOut {
  from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
  to { opacity: 0; transform: translate(-50%, -50%) scale(0.95); }
}


header{opacity:0;transform:translateY(25px);transition:opacity .8s ease,transform .8s ease}
header.visible{opacity:1;transform:translateY(0)}

/* --- [REVISI] KUNCI LAYOUT 2: HEADER (DESAIN BIRU SOLID) --- */
.app-header{
  text-align:center;padding: 15px 15px 10px;
  border-radius:0 0 20px 20px;
  background: var(--color-header-bg);
  box-shadow: 0 4px 10px var(--color-shadow);
  position: relative;
  flex-shrink: 0;
  z-index: 100;
  width: 100%; /* <-- mode mobile */
}

.title{
    font-size:1.2em;
    margin:0;
    color: var(--color-header-text);
    font-weight: 700;
    white-space: nowrap; 
    overflow: hidden;    
    text-overflow: ellipsis; 
    padding: 0 30px; 
}
body.dark-mode .title { color: var(--color-header-text); }
body.dark-mode .title-pl,
body.dark-mode .title-b {
    color: inherit;
}
/* INI ADALAH WARNA PERUSAHAAN JANGAN DIGANTI */
.title-pl { color: #00008B; }
.title-b { color: #ADD8E6; }

.version{font-size:.45em;color:var(--color-header-text);vertical-align:super; opacity: 0.7;}
.build-badge{
  background: rgba(255,255,255,0.2);
  color:var(--color-header-text);
  font-size:.65em;border-radius:8px;padding:2px 6px;margin-left:6px; font-weight: 400;
}
.subtitle{font-size: .5em;color:var(--color-text-light);margin-top: 4px;font-style:italic; display: none; }
.sponsor{font-size: .4em;color:var(--color-text-lighter);margin-top: 2px; display: none; }
.sponsor b{color:var(--color-accent)}
.timestamp{font-size:.7em;color:#999}

.dark-mode-toggle {
    position: absolute;
    top: 50%; 
    transform: translateY(-50%); 
    right: 25px;
    background: var(--color-header-btn-bg); 
    color: var(--color-header-btn-text); 
    border: 0px solid var(--color-border);
    border-radius: 50%;
    width: 24px; 
    height: 24px; 
    cursor: pointer;
    font-size: 0.9em; 
    line-height: 1;
    box-shadow: 0 1px 3px var(--color-shadow);
    transition: transform 0.2s, background 0.3s; 
    
    display: flex;
    align-items: center;
    justify-content: center;
}
.dark-mode-toggle:hover {
    transform: translateY(-50%) scale(1.1); 
}

/* --- [REVISI] CARD UMUM & INPUT (GAYA MODERN) --- */
.card{
  background:var(--color-card-bg);
  border:1px solid var(--color-border);
  border-radius:var(--radius-card);
  padding:30px 20px; 
  margin:25px 0 0;
  box-shadow:var(--shadow-card);
  position:relative;
  transition: background .3s, border .3s;
}
.card h2{
    margin-top:0;
    color: var(--color-accent);
    font-size:1.05em;
    font-weight: 700; 
}
/* [REVISI V6.2] Tata letak H2 di card data (agar tombol rapi) */
.card-data h2 {
    color: var(--color-accent);
    font-weight: 700;
    font-size: 1.1em; /* Sedikit lebih kecil agar muat */
    margin-bottom: 20px;
    border-bottom: 1px dashed var(--color-border);
    padding-bottom: 10px;
    
    /* Flexbox untuk merapikan judul, badge, dan tombol */
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
}
.card-data h2 .title-text {
    flex-grow: 1; /* Ambil sisa ruang */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

label{
    display:block;
    margin-top:12px;
    font-size:.9em;
    font-weight: 400; 
    color: var(--color-text-light);
}
input,select{
  width:100%;padding: 10px 12px; 
  margin-top:4px;
  border:1px solid var(--color-border);
  border-radius:var(--radius-input); 
  font-size:.9em;font-family:var(--font-main);
  transition:.3s;
  background: var(--color-input-bg);
  color: var(--color-text-main);
  font-weight: 300;
}
input:focus,select:focus{
  outline:none;
  border-color:var(--color-accent);
  box-shadow: 0 0 0 3px var(--color-shadow); 
}
/* [BARU V6.2] Style untuk input yang dikunci (Final) */
input:disabled, select:disabled,
input:disabled + .input-unit {
    background: var(--color-bg) !important;
    color: var(--color-text-light) !important;
    opacity: 0.8;
    border-style: dashed;
    cursor: not-allowed;
}
/* [REVISI V6.3] Kunci tombol lebih jelas */
.card-project-btn:disabled,
.btn:disabled {
    opacity: 0.5 !important;
    cursor: not-allowed !important;
    transform: none !important;
    box-shadow: none !important;
}


.card-tester{background:var(--color-card-tester);}
.card-hitung{background:var(--color-card-hitung);}

.card-recap{
    background: var(--color-card-recap);
    border-color: var(--color-recap-border);
}
.card-recap h2 {
    color: var(--color-text-main);
    font-weight: 700;
}
.recap-section-title {
    font-size: 0.95em;
    font-weight: 700;
    color: var(--color-accent);
    margin-top: 20px;
    margin-bottom: 10px;
    border-bottom: 1px solid var(--color-recap-border);
    padding-bottom: 5px;
}
.recap-row, .recap-row-small {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    font-size: 0.9em;
    border-bottom: 1px dashed var(--color-recap-border);
}
.card-recap .recap-row:last-child { border-bottom: none; }
.recap-label {
    color: var(--color-recap-label);
    flex-basis: 40%;
    flex-shrink: 0;
}
.recap-value {
    color: var(--color-recap-value);
    font-weight: 700;
    text-align: right;
    flex-grow: 1;
}
.recap-row-small {
    font-size: 0.85em;
    padding: 4px 0;
}
.recap-value.final-result {
    font-size: 1.1em;
    color: var(--color-text-sum);
}
.recap-value.final-result-alert {
    font-size: 1.1em;
    color: var(--color-alert-text);
}

/* [REVISI] Tombol */
.actions-row{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
.btn{
  background: var(--color-accent-light); 
  border: 1px solid var(--color-accent-light);
  padding: 8px 12px; 
  border-radius: var(--radius-input); 
  cursor:pointer;
  font-size:.7em; 
  font-weight: 700;
  transition:.2s;
  color: var(--color-accent); 
}
body.dark-mode .btn {
  background: var(--color-accent-light);
  border-color: var(--color-accent-light);
  color: var(--color-accent-text);
}
.btn:hover{
    transform:translateY(-1px);
    opacity: 0.9;
}
.btn.primary{
    background:var(--color-accent);
    color:var(--color-accent-text);
    border-color:var(--color-accent);
}
body.dark-mode .btn.primary:hover { color: var(--color-accent-text); }
.time-stamp{
  position:absolute;bottom:8px;right:12px;
  font-size:.65em;color:var(--color-text-lighter);font-weight:300;opacity:.8
}

/* [REVISI V6.0] Tombol Save di Rekap */
.card-recap .actions-row {
    margin-top: 25px;
    border-top: 1px dashed var(--color-recap-border);
    padding-top: 15px;
    justify-content: space-around;
    flex-wrap: wrap; /* Izinkan wrap */
    gap: 10px; /* Tambah gap */
}
.card-recap .actions-row .btn {
    flex-grow: 1;
    flex-basis: 150px; /* Sedikit lebih kecil agar muat 3 */
    text-align: center;
    font-size: 0.8em; /* Sedikit lebih kecil */
    background: var(--color-card-bg);
    color: var(--color-accent);
    border: 1px solid var(--color-accent);
    font-weight: 700;
    padding: 10px 12px; /* Lebih tinggi */
}
body.dark-mode .card-recap .actions-row .btn {
    background: var(--color-card-recap);
    color: var(--color-accent);
    border-color: var(--color-accent);
}
.card-recap .actions-row .btn:hover {
    background: var(--color-accent-light);
    transform: translateY(-1px);
    color: var(--color-accent);
}
body.dark-mode .card-recap .actions-row .btn:hover {
    background: var(--color-accent-light);
    color: var(--color-accent-text);
}
/* Tombol Save Utama (Kuning) */
.card-recap .actions-row .btn.save-to-vault {
    background: #FFC107;
    border-color: #FFC107;
    color: #212529;
    font-size: 0.85em;
    flex-basis: 100%; /* Ambil 1 baris penuh */
}
.card-recap .actions-row .btn.save-to-vault:hover {
    background: #ffca2c;
    color: #212529;
}


/* --- [REVISI] KUNCI LAYOUT 3: CAROUSEL / SLIDE CONTAINER --- */
.carousel-wrapper {
    width: 100%; 
    max-width: 400px;
    margin: 0px auto 0;
    overflow: hidden;
    position: relative;
    border-radius: var(--radius-card);
    flex-grow: 1; 
}


.slide-track {
    display: flex;
    transition: transform 0.5s ease-in-out;
    height: 100%; 
}

.slide-item {
    min-width: 100%;
    max-width: 400px;
    flex-shrink: 0;
    padding: 0 15px; /* [V6.4] Ubah padding ke slide-item */
    height: 100%; 
    display: flex;
    flex-direction: column;
}

/* --- Sembunyikan kontrol lama --- */
.carousel-controls { display: none; }
.slide-nav-btn { display: none; }
#slideIndicator { display: none; }
.global-actions { display: none; }


/* --- [REVISI] PROJECT CONTROLS DI CARD 1 (GAYA BARU) --- */
.card-project-controls {
    position: relative;
    top: auto;
    right: auto;
    display: flex;
    gap: 6px;
    z-index: 50;
    flex-shrink: 0; /* [V6.2] Mencegah tombol mengecil */
}
.card-project-btn {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 1px solid var(--color-border);
    font-size: 0.8em;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 1px 3px var(--color-shadow);
    transition: transform 0.2s, opacity 0.2s, background 0.2s;
    line-height: 1;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-card-bg);
}
.card-project-btn:hover {
    transform: scale(1.1);
}
.add-btn {
    color: var(--color-accent);
}
.remove-btn {
    color: var(--color-delete-text);
}
.reset-btn {
    color: var(--color-alert-text);
}
body.dark-mode .card-project-btn {
    background: var(--color-input-bg);
    border-color: var(--color-border);
}

/* --- [REVISI] CSS Detail (Box, Grid, dll) --- */
.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.col{flex:1 1 45%;display:flex;flex-direction:column}
.hit-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:8px;margin-top:10px}
.calc-box{
    background:var(--color-input-bg);
    border:1px solid var(--color-border);
    border-radius:var(--radius-input);
    padding:6px;
    text-align:center;
}
.calc-box input{
    border:none;
    text-align:center;
    width:100%;
    font-size:.9em;
    background:transparent;
    padding:0;
    margin:0;
    font-weight: 700;
}
.calc-box input:focus { box-shadow: none; } /* Hapus shadow di dlm box */

.summary-row{display:flex;gap:14px;align-items:center;flex-wrap:wrap;margin-top:14px}
.sum-box,.density-box{
  background:var(--color-input-bg);
  padding:10px 14px;
  border-radius:var(--radius-input);
  border:1px solid var(--color-card-tester-border);
  min-width:140px;
}
.allowance-tester-input-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px dashed var(--color-border);
}
.allowance-tester-input-group label {
    flex-basis: 75%;
    margin: 0;
    font-size: 0.95em;
    color: var(--color-text-main);
}
.allowance-tester-input-group input {
    flex-basis: 25%;
    width: auto;
    padding: 5px 8px;
    text-align: center;
    margin: 0;
    font-size: 1em;
}

.tester-result-box {
    margin-top: 15px;
    padding: 15px;
    background: var(--color-tester-result-bg);
    border-radius: var(--radius-input);
    text-align: center;
    font-weight: 700;
    border: 1px solid var(--color-card-hitung-border);
    box-shadow: 0 2px 5px var(--color-shadow);
}
body.dark-mode .tester-result-box { border-color: var(--color-card-hitung-border); }
.tester-result-box .label {
    font-size: 0.7em;
    color: var(--color-tester-result-text);
    margin-bottom: 5px;
    font-weight: 700;
}
.tester-result-box .result-value {
    font-size: 1.5em;
    color: var(--color-tester-result-text);
    line-height: 1.2;
}

/* [BARU] CSS untuk unit "ekor/kantong" di dalam result value */
.result-value small {
    font-size: 0.4em; /* Jauh lebih kecil */
    font-weight: 300;
    color: var(--color-text-light);
    display: block; /* Pindah ke baris baru */
    line-height: 1;
    margin-top: 2px;
}
body.dark-mode .result-value small {
     color: var(--color-text-light);
}

.tester-result-box.split-layout {
    display: flex;
    justify-content: space-around;
    align-items: stretch;
    gap: 15px;
    padding: 10px;
}
.result-box-split {
    flex: 1;
    min-width: 0;
    padding: 5px;
    border-radius: 6px;
}
.result-box-split.estimasi-box {
    background: #FFF3E0;
    border: 1px solid #FFE0B2;
}
body.dark-mode .result-box-split.estimasi-box {
    background: #392B1A;
    border: 1px solid #5E452A;
}
.result-box-split.estimasi-box .label {
    color: #E65100;
}
body.dark-mode .result-box-split.estimasi-box .label {
    color: var(--color-alert-text);
}
.result-box-split.estimasi-box .result-value {
    color: var(--color-alert-text);
    font-size: 1.5em;
}


.label{font-size:.8em;color:var(--color-text-light)}
.value{font-size:1em;color:var(--color-text-sum);margin-top:4px; font-weight: 700;}

/* === [REVISI] CSS STYLES FOR CARD HITUNGAN (CARD 4) === */
.order-nominal-display {
    text-align: center;
    padding: 15px 10px;
    background: var(--color-tester-result-bg); 
    border: 1px solid var(--color-card-hitung-border);
    border-radius: var(--radius-input); 
    margin-bottom: 20px;
    max-width: 300px; 
    margin-left: auto;   
    margin-right: auto;  
}
body.dark-mode .order-nominal-display {
    background: var(--color-tester-result-bg);
    border-color: var(--color-card-hitung-border);
}
.order-nominal-display .label {
    font-size: 0.85em;
    color: var(--color-text-sum); 
    margin-bottom: 5px;
    opacity: 0.8;
}
body.dark-mode .order-nominal-display .label { color: var(--color-text-sum); }
.order-nominal-display .value {
    font-size: 1.8em;
    font-weight: 700;
    color: var(--color-text-sum); 
    line-height: 1.1;
}

.hit-session .session-summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    font-size: 0.9em;
    font-weight: 400;
    border-bottom: 1px dashed var(--color-border);
    margin-top: 10px;
}
.hit-session .session-summary .sum-value {
    font-weight: 700;
    color: var(--color-text-sum);
}

.actions-row-small .btn {
    font-size: 0.75em;
    padding: 5px 8px;
    border-width: 1px;
    opacity: 0.7;
}

.summary-and-result-grid {
    display: block;
    gap: 15px;
    margin-top: 20px;
}

/* [REVISI] Box Summary Abu-abu & Hijau */
.grey-summary-box, .green-result-box {
    padding: 15px;
    border-radius: var(--radius-card); 
    box-shadow: none; 
    border: 1px solid var(--color-border);
}
.grey-summary-box {
    background: var(--color-bg); 
}
.green-result-box {
    background: var(--color-card-bg); 
    border: 1px solid var(--color-card-hitung-border); 
    margin-top: 15px;
}
body.dark-mode .grey-summary-box {
    background: var(--color-bg);
    border-color: var(--color-border);
}
body.dark-mode .green-result-box {
    background: var(--color-card-bg);
    border-color: var(--color-card-hitung-border);
}

.summary-item-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px dashed var(--color-border);
}
.summary-item-row:last-child {
    border-bottom: none;
}
.summary-label {
    font-size: 0.9em;
    color: var(--color-text-main);
}
.summary-value {
    font-size: 1.2em;
    font-weight: 700;
}
.summary-value.avg {color: var(--color-text-sum);} 
body.dark-mode .summary-value.avg {color: var(--color-text-sum);}
.summary-value.box {color: var(--color-alert-text);} 
body.dark-mode .summary-value.box {color: var(--color-alert-text);}
.summary-value.real-sj {color: var(--color-text-sum);}
.summary-value.simulation {
    color: var(--color-alert-text);
    font-size: 1.1em;
    font-weight: 700;
}
.summary-value.positive {
    color: var(--color-text-sum);
}
.summary-value.negative {
    color: var(--color-alert-text);
}

.allowance-input-grid {
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: space-between;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px dashed var(--color-border);
}
.allowance-input-grid label {
    font-size: 0.9em;
    margin: 0;
    flex-grow: 1;
}
.allowance-input-grid input {
    width: 65px;
    padding: 5px;
    text-align: center;
    margin: 0;
}
.allowance-display {
    font-weight: 700;
    font-size: 1.1em;
    color: var(--color-text-sum);
    text-align: right;
    flex-shrink: 0;
}
.allowance-result-row .summary-label {
    flex-basis: 50%;
}
.allowance-result-row .allowance-inputs {
    display: flex;
    gap: 5px;
    align-items: center;
}

/* Floating Calculator CSS (No Change) */
.calculator-container {
    position: fixed; top: 100px; right: 20px; z-index: 1000;
    transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out;
    transform: translateX(100%); opacity: 0;
}
.calculator-container.visible {transform: translateX(0); opacity: 1;}
.calculator-card {
    width: 280px; background: var(--color-calc-bg); border-radius: var(--radius-card);
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3); padding: 15px;
}
.calc-display-input {
    width: 100%; height: 60px; background: var(--color-calc-display); border: none;
    border-radius: 8px; text-align: right; font-size: 2.2em; font-weight: 700;
    color: #333; padding: 10px; margin-bottom: 10px; pointer-events: none;
}
body.dark-mode .calc-display-input { color: var(--color-text-main); }
.calc-grid {display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;}
.calc-btn {
    background: #6c6c6c; color: white; border: none; border-radius: 50%;
    height: 55px; font-size: 1.2em; cursor: pointer; transition: background 0.2s;
}
body.dark-mode .calc-btn { background: #555; }
.calc-btn:hover {background: #888;}
body.dark-mode .calc-btn:hover {background: #777;}
.calc-btn.operator {background: var(--color-calc-operator); font-weight: 700;}
.calc-btn.operator:hover {background: #ffb75f;}
.calc-btn.clear, .calc-btn.toggle-sign {background: #a6a6a6; color: #333;}
body.dark-mode .calc-btn.clear, body.dark-mode .calc-btn.toggle-sign { background: #888; color: #f1f1f1; }
.calc-btn.clear:hover, .calc-btn.toggle-sign:hover {background: #c2c2c2;}
body.dark-mode .calc-btn.clear:hover, body.dark-mode .calc-btn.toggle-sign:hover {background: #999;}
.calc-btn.zero {grid-column: span 2; border-radius: 55px; text-align: left; padding-left: 20px;}
.calc-toggle-btn {
    position: fixed; bottom: 20px; right: 20px; z-index: 1001;
    background: var(--color-accent); color: white; border: none; border-radius: 50%;
    width: 50px; height: 50px; font-size: 1.5em; box-shadow: 0 4px 8px var(--color-shadow);
    cursor: pointer; transition: background 0.3s, transform 0.2s;
}
.calc-toggle-btn:hover {
    background: #0056b3;
    transform: scale(1.1); 
}

/* === [REVISI] Toggle Switch Simulasi (Gaya Modern) === */
.simulasi-toggle-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}
.simulasi-toggle-label {
    font-size: 0.9em;
    font-weight: 700;
    color: var(--color-text-main);
    
    /* [V6.9] Izinkan label dan ikon info */
    display: flex;
    align-items: center;
}
.switch {
    position: relative;
    display: inline-block;
    width: 44px; 
    height: 24px; 
    flex-shrink: 0; 
}
.switch input { 
    opacity: 0;
    width: 0;
    height: 0;
}
.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
}
.slider:before {
    position: absolute;
    content: "";
    height: 18px; 
    width: 18px; 
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
input:checked + .slider {
    background-color: var(--color-accent); 
}
input:checked + .slider:before {
    transform: translateX(20px); 
}
.slider.round {
    border-radius: 24px;
}
.slider.round:before {
    border-radius: 50%;
}
/* [V6.2] Style untuk switch yang terkunci */
.switch input:disabled + .slider {
    background-color: var(--color-border) !important;
    cursor: not-allowed;
    opacity: 0.7;
}


/* === [REVISI] Penyesuaian Font Mobile === */
@media (max-width: 360px) {
    body {
        font-size: 13px; 
    }
    .title { font-size: 1.1em; }
    .subtitle { font-size: 0.8em; }
    .btn, .card-recap .actions-row .btn, .global-actions .btn {
        font-size: 0.8em;
    }
    .card-data h2 { font-size: 1.05em; }
    .card h2 { font-size: 1em; }
    .tester-result-box .result-value { font-size: 1.5em; }
    .result-box-split.estimasi-box .result-value { font-size: 1.4em; }
    .order-nominal-display .value { font-size: 1.5em; }
    .summary-value { font-size: 1.1em; }
    .hit-grid {
        grid-template-columns: repeat(auto-fit,minmax(70px,1fr));
    }
}
/* === [REVISI V6.0] Floating Nav Bar Bawah === */

/* 1. Kontainer Utama */
.floating-nav-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    padding: 12px 15px 15px; 
    background: linear-gradient(180deg, 
        rgba(255,255,255,0) 0%, 
        rgba(255,255,255,0.8) 20%, 
        var(--color-bg) 100%
    );
    box-shadow: none; 
    
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    z-index: 998;
    pointer-events: none; 
}
body.dark-mode .floating-nav-bar {
    background: linear-gradient(180deg, 
        rgba(15, 23, 42, 0) 0%, 
        rgba(15, 23, 42, 0.8) 20%, 
        var(--color-bg) 100%
    );
}

/* 2. Grup Tombol (Kiri, Tengah, Kanan) */
.floating-nav-group {
    display: flex;
    align-items: center;
    gap: 10px;
    pointer-events: auto; 
}
.floating-nav-group.center {
    position: absolute; 
    left: 50%;
    transform: translateX(-50%);
    display: none; 
}
.floating-nav-group.right {
    margin-left: auto; 
}

/* [REVISI V6.0] Style Tombol Bulat (Termasuk Tombol Vault) */
.floating-nav-btn {
    background: var(--color-accent); 
    color: var(--color-accent-text); 
    border: none;
    border-radius: 50%;
    width: 40px; 
    height: 40px; 
    font-size: 1.3em;
    box-shadow: 0 4px 12px var(--color-shadow-dark); 
    cursor: pointer;
    transition: background 0.3s, transform 0.2s, box-shadow 0.2s ease-out;
    
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    padding: 0;
}
.floating-nav-btn:hover {
    transform: scale(1.1); 
    box-shadow: 0 8px 20px var(--color-shadow-dark); 
}
/* [REVISI V6.0] Tombol Vault (Menggantikan Save) */
.floating-nav-btn.vault-btn {
    background: #212529; /* Hitam/Dark */
    color: #FFFFFF;       
    font-size: 1.5em; /* Ikon vault sedikit lebih besar */
}
body.dark-mode .floating-nav-btn.vault-btn {
    background: #EAF0F6; 
    color: #212529;       
}

/* Tombol Navigasi Disabled */
.floating-nav-btn:disabled {
    background: var(--color-border);
    color: var(--color-text-lighter);
    box-shadow: none;
    transform: none;
    cursor: not-allowed;
}

/* 5. Style Indikator Halaman */
.floating-nav-indicator {
    background: var(--color-card-bg);
    color: var(--color-text-main);
    font-size: 1.1em;
    font-weight: 700;
    padding: 10px 16px;
    border-radius: 25px;
    box-shadow: 0 4px 8px var(--color-shadow);
    border: 1px solid var(--color-border);
}

/* 6. SEMBUNYIKAN Kontrol Asli */
#prevSlideBtn, #nextSlideBtn, #slideIndicator {
    display: none !important;
}
body > .calc-toggle-btn {
    display: none !important;
}

/* === [REVISI V6.4] CSS Accordion (Animasi Grid) === */
.card-accordion {
    margin-top: 10px;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-card);
    overflow: hidden; /* Penting untuk rounded corner */
}
.accordion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    cursor: pointer;
    background: var(--color-accent-light);
    transition: background 0.3s;
}
.accordion-header:hover {
    background: var(--color-tab-nav-bg);
}
body.dark-mode .accordion-header {
    background: var(--color-accent-light);
}
body.dark-mode .accordion-header:hover {
    background: var(--color-header-btn-bg);
}
.accordion-header h3 {
    margin: 0;
    font-size: 0.95em;
    font-weight: 700;
    color: var(--color-accent);
}
body.dark-mode .accordion-header h3 {
    color: var(--color-accent);
}
.accordion-toggle-icon {
    font-size: 1.2em;
    font-weight: 700;
    color: var(--color-accent);
    transition: transform 0.3s ease;
}

.accordion-header.active .accordion-toggle-icon {
    transform: rotate(45deg);
}

/* [V6.4] Animasi grid mulus */
.accordion-panel {
    display: grid;
    grid-template-rows: 0fr; /* Awalnya 0 */
    transition: grid-template-rows 0.4s cubic-bezier(0.4, 0, 0.2, 1); /* Transisi profesional */
    background: var(--color-card-bg);
}
body.dark-mode .accordion-panel {
    background: var(--color-card-bg);
}
.accordion-header.active + .accordion-panel {
    grid-template-rows: 1fr; /* Menjadi 1 */
}
/* [V6.4] Wrapper untuk konten di dalam grid */
.accordion-content-wrapper {
    overflow: hidden;
    padding: 0px 20px;
    /* [PERBAIKAN BUG #2] Tambahkan padding bawah */
    padding-bottom: 0px;
}
/* [V6.4] Penyesuaian untuk rekap */
.accordion-panel.recap-panel {
    background: transparent;
}
.accordion-panel.recap-panel .accordion-content-wrapper {
    padding: 0px 0 0 0;
}

/* Grid 2 kolom untuk input QC */
.qc-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0px 15px;
}
/* [PERBAIKAN BUG #2] RAPIKAN GRID QC */
.qc-grid.full-width {
    grid-template-columns: 1fr; /* Hanya 1 kolom */
}
.qc-grid.full-width label {
    margin-top: 12px; /* Beri jarak antar input */
}
.qc-grid label {
    margin-top: 12px;
}
/* Style untuk input dengan satuan */
.input-with-unit {
    position: relative;
}
.input-unit {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-text-lighter);
    font-size: 0.85em;
    font-weight: 400;
    pointer-events: none;
}
/* Sesuaikan input agar tidak tumpang tindih dengan unit */
.input-with-unit input {
    padding-right: 45px; 
}
.input-with-unit input[type=number] {
    padding-right: 45px;
}
/* === [AKHIR] CSS Accordion === */


/* === [REVISI V6.0] CSS Card Vault (Brankas Data) === */

/* 1. Kontainer Overlay (Latar belakang gelap) */
.vault-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100dvh;
    background: rgba(0,0,0,0.19); /* Latar gelap transparan */
    z-index: 1998;
    display: none; /* Default tersembunyi */
    transition: opacity 0.3s ease-out; /* [V6.3] Transisi halus */
    opacity: 0;
}
.vault-overlay.visible {
    display: block;
    opacity: 1;
}

/* 2. Kontainer Utama (Panel Pop-up Profesional) */
.vault-container {
    position: fixed;
    top: 50%; 
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1999; 
    width: 95%;
    max-width: 600px; /* LEBIH LEBAR */
    height: 85dvh; /* LEBIH TINGGI */
    
    background: var(--color-bg); /* Latar belakang body */
    border-radius: var(--radius-card);
    box-shadow: 0 10px 30px var(--color-shadow-dark); /* Bayangan lebih kuat */
    border: 1px solid var(--color-border);

    overflow: hidden; /* Kontrol di dalam */
    display: none; /* Default tersembunyi */
    flex-direction: column; /* Tata letak Vertikal */
    
    /* [REVISI V6.3] Animasi baru */
    transform-origin: center center;
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.95);
    transition: opacity 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.vault-container.visible {
    display: flex;
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
}
.vault-container.is-hiding {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.95);
}


/* 3. Header Vault (Judul + Tombol Export) */
.vault-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid var(--color-border);
    flex-shrink: 0; /* Header tidak mengecil */
    background: var(--color-card-bg);
}
.vault-header h2 {
    margin: 0;
    font-size: 1.1em;
    color: var(--color-accent);
}
.vault-export-btn {
    background: var(--color-text-sum);
    color: white;
    border: none;
    border-radius: var(--radius-input);
    padding: 8px 12px;
    font-size: 0.8em;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s, transform 0.2s;
}
.vault-export-btn:hover {
    background: #156d44;
    transform: scale(1.05);
}
/* [BARU V6.1] Style tombol saat disabled (untuk loading) */
.vault-export-btn:disabled {
    background: var(--color-text-light);
    cursor: not-allowed;
    transform: none;
}


/* 4. Daftar Vault (Bisa scroll) */
.vault-list {
    flex-grow: 1; /* Ambil sisa ruang */
    overflow-y: auto;
    padding: 15px;
}
.vault-list-item { 
    background: var(--color-card-bg); 
    border: 1px solid var(--color-border);
    border-left: 5px solid var(--color-accent); /* Penanda Profesional */
    border-radius: var(--radius-input); 
    padding: 15px 20px;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    box-shadow: 0 2px 5px var(--color-shadow);
    /* [REVISI V6.4] Transisi hapus yang lebih baik */
    transition: transform 0.3s cubic-bezier(0.6, -0.28, 0.74, 0.05), 
                opacity 0.3s cubic-bezier(0.6, -0.28, 0.74, 0.05),
                max-height 0.4s 0.1s ease, 
                padding 0.4s 0.1s ease, 
                margin 0.4s 0.1s ease, 
                border-width 0.4s 0.1s ease;
    overflow: hidden;
    max-height: 100px; /* Tinggi wajar */
}
.vault-list-item:hover {
    box-shadow: 0 4px 10px var(--color-shadow-dark);
}
/* [REVISI V6.4] Animasi menghapus item vault (swipe-out) */
.vault-list-item.is-deleting {
    transform: translateX(100px);
    opacity: 0;
    max-height: 0;
    padding-top: 0;
    padding-bottom: 0;
    margin-bottom: 0;
    border-width: 0;
}


/* Info di dalam list item */
.vault-item-info {
    flex-grow: 1;
    min-width: 0; /* Mencegah teks mendorong tombol */
    display: flex;
    flex-direction: column;
}
.vault-item-info-main {
    font-size: 1.1em;
    font-weight: 700;
    color: var(--color-text-main);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    
    /* [V6.3] Wadah untuk badge NEW */
    display: flex;
    align-items: center;
    gap: 8px;
}
/* [BARU V6.3] Badge "NEW!" */
.vault-new-badge {
    background: var(--color-alert-text);
    color: white;
    font-size: 0.6em;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 4px;
    line-height: 1;
}

.vault-item-info-sub {
    font-size: 0.85em;
    color: var(--color-text-light);
    margin-top: 2px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

/* Tombol di dalam list item */
.vault-item-actions { 
    display: flex; 
    gap: 8px; 
    flex-shrink: 0; /* Tombol tidak mengecil */
}
.vault-item-actions .btn { 
    font-size: 0.8em; 
    padding: 6px 10px; 
    min-width: 60px; /* Lebar minimum */
    text-align: center;
}
.vault-item-actions .restore { 
    border-color: var(--color-accent); 
    color: var(--color-accent); 
    background: transparent;
}
body.dark-mode .vault-item-actions .restore { 
    background: var(--color-accent-light); 
    border-color: var(--color-accent-light);
    color: var(--color-accent-text);
}
.vault-item-actions .delete { 
    border-color: var(--color-delete-text); 
    color: var(--color-delete-text); 
    background: transparent;
}
body.dark-mode .vault-item-actions .delete { 
    background: #4a2125;
    border-color: #dc3545;
}
/* === [AKHIR] CSS Vault === */


/* === [REVISI V6.4] DESAIN TAB SLIDING === */
.card-tab-nav {
    display: flex;
    justify-content: space-around;
    background: var(--color-tab-nav-bg); 
    margin: 15px 0 0 0; 
    padding: 4px; 
    border-radius: 25px; 
    box-shadow: none;
    border: 1px solid var(--color-border);
    position: sticky; 
    top: 5px; 
    z-index: 10;
    flex-shrink: 0; 
}
body.dark-mode .card-tab-nav {
    border: none; 
}
.tab-link {
    flex-grow: 1;
    border: none;
    background: transparent; 
    color: var(--color-text-light);
    padding: 8px 5px; 
    border-radius: 20px; 
    font-weight: 700;
    font-size: 0.8em; 
    cursor: pointer;
    transition: background 0.3s, color 0.3s;
    text-align: center;
    white-space: nowrap; 
    
    /* [REVISI V6.8] Tambahkan posisi relatif untuk badge */
    position: relative;
}
.tab-link.active {
    background: var(--color-accent); 
    color: var(--color-accent-text); 
    box-shadow: 0 2px 5px var(--color-shadow-dark);
}
body.dark-mode .tab-link.active {
    color: #FFFFFF; 
}

/* [V6.4] KONTEN TAB SLIDING */
.card-tab-content {
    padding-top: 10px; 
    flex-grow: 1; 
    overflow: hidden; /* [V6.4] Sembunyikan panel yg bergeser */
    padding-bottom: 50px; 
}
/* [V6.4] Wrapper untuk semua panel (400% width) */
.card-tab-track {
    display: flex;
    width: 400%; /* 4 tab */
    height: 100%;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); /* Transisi slide */
}

/* [V6.4] Panel tab individu */
.tab-panel {
    width: 25%; /* 1 dari 4 tab */
    flex-shrink: 0;
    height: 100%;
    overflow-y: auto; /* [V6.4] Scrollbar pindah ke sini */
    overflow-x: hidden;
    margin-top: 0 !important; 
    padding: 0 5px 20px 5px; /* Padding untuk scroll */
}
/* Sembunyikan scrollbar di panel */
.tab-panel::-webkit-scrollbar { display: none; }
.tab-panel { scrollbar-width: none; }


/* === [REVISI] PENYESUAIAN CSS LAMA === */
.slide-item {
    min-width: 100%;
    max-width: 400px;
    flex-shrink: 0;
    padding: 0 15px; 
    height: 100%; 
    display: flex;
    flex-direction: column;
}
.tab-panel .card { /* [V6.4] Ubah selector */
    margin: 0 0 15px 0; 
    box-shadow: var(--shadow-card); 
}
/* Hapus .card-data h2 lama, sudah diganti di atas */


/* === [BARU] SEMBUNYIKAN SCROLLBAR === */
.vault-list::-webkit-scrollbar {
    display: none;
}
.vault-list {
    scrollbar-width: none; /* Firefox */
}

/* === [REVISI V6.8] CSS Badge Status (Gaya Balon Teks) === */
.status-badge {
  display: inline-block;
  vertical-align: middle;
  font-weight: 700;
  font-size: 0.7em;
  padding: 3px 8px; 
  border-radius: 6px;
  color: #fff;  /* <-- DIKEMBALIKAN. Ini PENTING untuk "Terkirim" & "Edited" */
  flex-shrink: 0; 
  
  /* [REVISI V6.8] Pemosisian Balon Teks */
  position: absolute;
  top: -10px; /* Muncul di atas tab */
  right: -5px; /* Sedikit ke kanan */
  line-height: 1.2;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  z-index: 1; /* Di atas tab link lain */
  
  /* [REVISI V6.8c] PERBAIKAN BUG: Tambahkan 'opacity' ke transisi */
  transition: background 0.3s, transform 0.2s, opacity 0.2s ease-out;
  transform: scale(0.9);
  opacity: 0; /* <-- DIKEMBALIKAN ke 0 agar animasi 'pop' bisa berjalan */
  pointer-events: none; /* Tidak bisa diklik */
}
.status-badge.visible {
    transform: scale(1);
    opacity: 1; /* <-- Kelas .visible inilah yang memunculkannya */
}

/* Panah kecil di bawah badge */
.status-badge::after {
    content: '';
    position: absolute;
    bottom: -4px; /* Arahkan ke bawah */
    left: 50%;
    transform: translateX(-50%);
    border-width: 4px;
    border-style: solid;
    border-color: transparent; 
    /* Warna panah diatur oleh JS di 'markStatus' */
}

/* === [REVISI V6.9 - DARI POIN 4] CSS IKON INFO === */
.info-tooltip {
    display: inline-block;
    width: 15px;
    height: 15px;
    border-radius: 50%;
    background: var(--color-text-lighter);
    color: var(--color-card-bg);
    font-size: 10px;
    font-weight: 700;
    line-height: 15px;
    text-align: center;
    cursor: help;
    margin-left: 6px;
    opacity: 0.7;
    transition: opacity 0.2s;
    flex-shrink: 0;
}
.info-tooltip:hover {
    opacity: 1;
}
/* Style untuk tombol reset baris (Poin 2) */
.btn-reset-row {
    background: transparent;
    border: none;
    color: var(--color-alert-text);
    font-size: 1.1em;
    cursor: pointer;
    padding: 0 5px;
    margin-left: 5px;
    opacity: 0.7;
    transition: opacity 0.2s;
}
.btn-reset-row:hover {
    opacity: 1;
}

/* --- [BARU: STYLE MODAL SHARE] --- */
.modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 2000;
    display: flex;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(2px);
}
.modal-content {
    background: var(--color-card-bg);
    padding: 25px;
    border-radius: var(--radius-card);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    text-align: center;
    width: 90%;
    max-width: 350px;
    border: 1px solid var(--color-border);
}
.modal-content h3 {
    margin: 0 0 10px 0;
    color: var(--color-accent);
    font-size: 1.2em;
}
.modal-content p {
    margin: 0 0 20px 0;
    color: var(--color-text-main);
}
.modal-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.modal-actions .btn {
    width: 100%;
    padding: 12px;
    font-size: 0.9em;
}
</style>

</head>

<body>

<header class="app-header visible">
  <button id="vaultToggleBtn" class="dark-mode-toggle" onclick="toggleVault()" title="Buka Vault Data Panen">üóÑÔ∏è</button>
  
  <button id="darkModeToggle" class="dark-mode-toggle" title="Ganti Tema">üåô</button>

  <h1 class="title">
    <span class="title-pl">PL</span><span class="title-b">B</span> ShrimpCount
    <span class="version">V8.0</span>
    <span class="build-badge">Pro</span>
  </h1>
  <p class="subtitle">Alat Hitung & Simulasi Packing ‚Äî cepat, akurat, siap lapangan.</p>
  <p class="sponsor">This app has been built for internal use and restricted purpose only! ‚ìí 2025 All Right Reserved</p>
</header>

<div id="carouselWrapper" class="carousel-wrapper">
    <div id="slideTrack" class="slide-track">
        </div>
</div>

<div class="carousel-controls">
</div>

<div id="calculatorContainer" class="calculator-container">
    <div class="calculator-card">
        <input type="text" id="calcDisplay" class="calc-display-input" value="0" readonly>
        <div class="calc-grid">
            <button class="calc-btn clear" onclick="calcClear()">AC</button>
            <button class="calc-btn clear" onclick="calcBackspace()">DEL</button>
            <button class="calc-btn clear" onclick="calcPercent()">%</button>
            <button class="calc-btn operator" onclick="calcOperator('/')">√∑</button>

            <button class="calc-btn" onclick="calcInput('7')">7</button>
            <button class="calc-btn" onclick="calcInput('8')">8</button>
            <button class="calc-btn" onclick="calcInput('9')">9</button>
            <button class="calc-btn operator" onclick="calcOperator('*')">√ó</button>

            <button class="calc-btn" onclick="calcInput('4')">4</button>
            <button class="calc-btn" onclick="calcInput('5')">5</button>
            <button class="calc-btn" onclick="calcInput('6')">6</button>
            <button class="calc-btn operator" onclick="calcOperator('-')">‚àí</button>

            <button class="calc-btn" onclick="calcInput('1')">1</button>
            <button class="calc-btn" onclick="calcInput('2')">2</button>
            <button class="calc-btn" onclick="calcInput('3')">3</button>
            <button class="calc-btn operator" onclick="calcOperator('+')">+</button>

            <button class="calc-btn zero" onclick="calcInput('0')">0</button>
            <button class="calc-btn" onclick="calcInput('.')">.</button>
            <button class="calc-btn operator" onclick="calcEquals()">=</button>
        </div>
    </div>
</div>

<button class="calc-toggle-btn" onclick="toggleCalculator()">üßÆ</button>

<div id="shareOptionModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h3>Pilih Format Pesan</h3>
        <p>Kirim rincian lengkap?</p>
        <div class="modal-actions">
            <button class="btn primary" onclick="confirmShare(true)">Ya (Lengkap)</button>
            <button class="btn" onclick="confirmShare(false)">Tidak (Ringkas)</button>
            <button class="btn remove-btn" onclick="closeShareModal()" style="background: transparent; color: var(--color-text-light); border: none;">Batal</button>
        </div>
    </div>
</div>

<template id="panen-template">
    <div class="slide-item"> 
        <div class="card-tab-nav">
            <button class="tab-link active" data-tab-index="0" onclick="openCard(event, '{{INSTANCE_ID}}_data', 0)">üìã Data</button>
            <button class="tab-link" data-tab-index="1" onclick="openCard(event, '{{INSTANCE_ID}}_tester', 1)">üî¨ Tester</button>
            <button class="tab-link" data-tab-index="2" onclick="openCard(event, '{{INSTANCE_ID}}_hitung', 2)">üî¢ Hitung</button>
            <button class="tab-link" data-tab-index="3" onclick="openCard(event, '{{INSTANCE_ID}}_rekap', 3)" id="{{INSTANCE_ID}}_rekapTab">
                üìä Rekap
                <span class="status-badge" id="{{INSTANCE_ID}}_statusBadge">Draft</span>
            </button>
        </div>

        <div class="card-tab-content">
            <div class="card-tab-track" id="{{INSTANCE_ID}}_tabTrack">
            
                <section id="{{INSTANCE_ID}}_data" class="tab-panel">
                    <div class="card card-data">
                        <h2 id="{{INSTANCE_ID}}_title">
                            <span class="title-text">üìã Data Panen {{ID}}</span>
                            <div class="card-project-controls">
                                <button class="card-project-btn add-btn" onclick="addInstance()" title="Tambah Data Panen Baru">‚ûï</button>
                                <button class="card-project-btn reset-btn" onclick="resetCard1('{{INSTANCE_ID}}')" title="Reset Data Panen Ini">üîÑ</button>
                                <button id="{{INSTANCE_ID}}_removeBtn" class="card-project-btn remove-btn" onclick="removeInstance()" title="Hapus Data Panen Ini" disabled>‚ùå</button>
                            </div>
                        </h2>
                        
                        <label>üìÖ Tanggal Panen</label><input id="{{INSTANCE_ID}}_line" type="date" placeholder="YYYY-MM-DD" oninput="updateRecap('{{INSTANCE_ID}}')">
                        <label>üë§ Nama Customer</label><input id="{{INSTANCE_ID}}_customer" placeholder="Nama Customer" oninput="updateRecap('{{INSTANCE_ID}}')">
                        <label>üìç Tujuan</label><input id="{{INSTANCE_ID}}_tujuan" placeholder="Kota Tujuan" oninput="updateRecap('{{INSTANCE_ID}}')">
                        <label>ü¶ê Order Benur (Ekor)</label><input type="text" id="{{INSTANCE_ID}}_nominalOrder" placeholder="0" oninput="formatCurrency(this); recalcAllHitungan('{{INSTANCE_ID}}'); recalcAllTester('{{INSTANCE_ID}}')">

                        <label>üöõ Jenis Truk</label>
                        <select id="{{INSTANCE_ID}}_jenisTruk" onchange="updateTruckDetails('{{INSTANCE_ID}}'); recalcAllTester('{{INSTANCE_ID}}'); recalcAllHitungan('{{INSTANCE_ID}}')">
                            <option value="Euro2">Euro 2</option>
                            <option value="Euro4">Euro 4</option>
                            <option value="Bandara">Bandara</option>
                        </select>

                        <label>üì¶ Kapasitas Angkut (Box)</label>
                        <input type="number" id="{{INSTANCE_ID}}_kapasitasAngkut" placeholder="Auto isi">

                        <label>‚öñÔ∏è Isi Per Box (Kantong)</label>
                        <input type="number" id="{{INSTANCE_ID}}_isiBox" placeholder="Auto isi dari jenis truk" readonly>

                        <label>üöö Driver</label>
                        <select id="{{INSTANCE_ID}}_driver" onchange="updateDriverDetails('{{INSTANCE_ID}}')">
                            </select>
                        
                        <label>üí≥ Plat Nomor</label>
                        <input id="{{INSTANCE_ID}}_platNomor" placeholder="Plat Nomor (auto-fill)" oninput="updateRecap('{{INSTANCE_ID}}')">
                    </div>
                </section>

                <section id="{{INSTANCE_ID}}_tester" class="tab-panel">
                    <div class="card card-tester">
                        <h2>üî¨ Hitungan Tester</h2>

                        <div class="row">
                            <div class="col"><label>üìã Bak Scooring</label><input id="{{INSTANCE_ID}}_nomorBak" placeholder="Bak Scooring" oninput="updateRecap('{{INSTANCE_ID}}')"></div>
                            <div class="col"><label>üíß Bak Asli</label><input id="{{INSTANCE_ID}}_qcBakAsli" placeholder="Bak Asli" oninput="updateRecap('{{INSTANCE_ID}}')"></div>
                        </div>
                        <div class="row">
                            <div class="col"><label>ü§ñ Tomota (ekor)</label><input id="{{INSTANCE_ID}}_tomota" type="number" placeholder="Tomota" oninput="updateRecap('{{INSTANCE_ID}}')"></div>
                        </div>
                        <div class="row">
                            <div class="col"><label>Hitungan Tester:</label></div>
                        </div>

                        <div id="{{INSTANCE_ID}}_hitGridTester" class="hit-grid"></div>
                        
                        <div class="summary-row">
                            <div class="sum-box"><div class="label">Œ£ Total</div><div id="{{INSTANCE_ID}}_testerSum" class="value">0</div></div>
                            <div class="density-box"><div class="label">Density (ekor/L)</div><div id="{{INSTANCE_ID}}_testerDensity" class="value">-</div></div>
                        </div>

                        <div class="allowance-tester-input-group">
                            <label>Allowance Tester (%)</label>
                            <input type="number" id="{{INSTANCE_ID}}_allowanceTester" value="0" min="0" max="100" oninput="recalcAllTester('{{INSTANCE_ID}}')">
                        </div>

                        <div class="tester-result-box split-layout">
                            <div class="result-box-split">
                                <div class="label">‚úçüèª Hasil Benur Tester (Dibulatkan)</div>
                                <div id="{{INSTANCE_ID}}_finalTesterResult" class="result-value">0</div>
                            </div>
                            <div class="result-box-split estimasi-box">
                                <div class="label">üì¶ Estimasi Box (Tester)</div>
                                <div id="{{INSTANCE_ID}}_estimasiBoxTester" class="result-value">0 Box</div>
                            </div>
                        </div>
                        <div class="actions-row">
                            <button class="btn" onclick="addCalcBox('{{INSTANCE_ID}}_hitGridTester')">‚ûï Tambah Kolom</button>
                            <button class="btn" onclick="removeCalcBox('{{INSTANCE_ID}}_hitGridTester')">‚ùå Hapus Kolom</button>
                            <button class="btn" onclick="resetTester('{{INSTANCE_ID}}')">üîÑ Reset Semua</button>
                        </div>
                        <div id="{{INSTANCE_ID}}_testerTimestamp" class="time-stamp">üïí Terakhir diperbarui: -</div>

                        <div class="card-accordion" id="{{INSTANCE_ID}}_qcAccordion">
                            <div class="accordion-header" onclick="toggleAccordion(event)">
                                <h3>üß¨ Quality Control (QC)</h3>
                                <span class="accordion-toggle-icon">‚ûï</span>
                            </div>
                            <div class="accordion-panel">
                                <div class="accordion-content-wrapper">
                                    
                                    <div class="qc-grid">
                                        <div>
                                            <label>üå°Ô∏è Suhu</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="{{INSTANCE_ID}}_qcSuhu" placeholder="0" oninput="updateRecap('{{INSTANCE_ID}}')">
                                                <span class="input-unit">¬∞C</span>
                                            </div>
                                            
                                            <label>üíß pH</label>
                                            <input type="number" id="{{INSTANCE_ID}}_qcPh" placeholder="0" oninput="updateRecap('{{INSTANCE_ID}}')">

                                            <label>ü´ß DO</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="{{INSTANCE_ID}}_qcDo" placeholder="0" oninput="updateRecap('{{INSTANCE_ID}}')">
                                                <span class="input-unit">ppm</span>
                                            </div>

                                            <label>üßÇ Salinitas</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="{{INSTANCE_ID}}_qcSalinitas" placeholder="0" oninput="updateRecap('{{INSTANCE_ID}}')">
                                                <span class="input-unit">ppt</span>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <label>üó∫Ô∏è Jarak Tempuh</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="{{INSTANCE_ID}}_qcJarak" placeholder="0" oninput="updateRecap('{{INSTANCE_ID}}')">
                                                <span class="input-unit">Jam</span>
                                            </div>

                                            <label>‚öñÔ∏è Biomassa</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="{{INSTANCE_ID}}_qcBiomassa" placeholder="0" oninput="updateRecap('{{INSTANCE_ID}}')">
                                                <span class="input-unit">gr</span>
                                            </div>

                                            <label>üìè Panjang</label>
                                            <div class="input-with-unit">
                                                <input type="number" id="{{INSTANCE_ID}}_qcPanjang" placeholder="0" oninput="updateRecap('{{INSTANCE_ID}}')">
                                                <span class="input-unit">mm</span>
                                            </div>
                                            
                                            <label>üåü Stadia</label>
                                            <input id="{{INSTANCE_ID}}_qcStadia" placeholder="contoh: pl8pl9" oninput="updateRecap('{{INSTANCE_ID}}')">

                                            </div>
                                    </div>

                                    <div class="qc-grid" style="margin-top: 12px;">
    <div>
        <label style="margin-top: 0;">üë®‚Äçüè≠ Scooping</label>
        <input id="{{INSTANCE_ID}}_qcScooping" placeholder="-" oninput="updateRecap('{{INSTANCE_ID}}')">
    </div>
    <div>
        <label style="margin-top: 0;">#Ô∏è‚É£ No. Scooping</label>
        <input id="{{INSTANCE_ID}}_qcNoScooping" placeholder="-" oninput="updateRecap('{{INSTANCE_ID}}')">
    </div>
</div>
                                </div> </div> </div>
                        </div>
                </section>

                <section id="{{INSTANCE_ID}}_hitung" class="tab-panel">
                    <div class="card card-hitung">
                        <h2>üî¢ Hitungan</h2>

<div class="order-nominal-display">
                            <div class="label">üéØ Order Benur (Ekor)</div>
                            <div id="{{INSTANCE_ID}}_orderDisplay" class="value">0</div>
                        </div>

                        <div id="{{INSTANCE_ID}}_multiSessionGrid">
                            </div>

                        <div class="actions-row actions-row-small">
                            <button class="btn primary" onclick="addHitunganSession('{{INSTANCE_ID}}')">‚ûï Tambah Baris</button>
                            <button class="btn" onclick="removeHitunganSession('{{INSTANCE_ID}}')">‚ùå Hapus Baris</button>
                            <button class="btn" onclick="resetHitungan('{{INSTANCE_ID}}')">üîÑ Reset Semua</button>
                        </div>

                        <div class="summary-and-result-grid">
                            
                            <div class="grey-summary-box">
                                
                                <div class="summary-item-row">
                                    <div class="summary-label">Rata-rata (Aktual)</div>
                                    <div id="{{INSTANCE_ID}}_avgValueDisplay" class="summary-value avg">0 ekor</div>
                                </div>
                                <div class="summary-item-row allowance-result-row">
                                    <div class="summary-label">Allowance (%)</div>
                                    <div class="allowance-inputs">
                                        <input type="number" id="{{INSTANCE_ID}}_allowance1" value="0" min="0" max="100" oninput="recalcAllHitungan('{{INSTANCE_ID}}')" style="width: 70px;">
                                        <span>-</span>
                                        <input type="number" id="{{INSTANCE_ID}}_allowance2" value="0" min="0" max="100" oninput="recalcAllHitungan('{{INSTANCE_ID}}')" style="width: 70px;">
                                    </div>
                                </div>
                                <div class="summary-item-row">
                                    <div class="summary-label">üì¶ Kebutuhan Box</div>
                                    <div id="{{INSTANCE_ID}}_kebutuhanBox" class="summary-value box">0 Box</div>
                                </div>
                                
                                <div id="{{INSTANCE_ID}}_limitKapasitasToggleContainer" class="simulasi-toggle-container" style="justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--color-border);">
                                    <span class="simulasi-toggle-label" style="font-size: 0.9em; color: var(--color-accent);">Batasi ke Kapasitas Truk?
                                        <span class="info-tooltip" title="Jika Aktif: Kebutuhan Box akan dibatasi sesuai kapasitas truk. Aplikasi akan otomatis menghitung ulang benur/kantong agar total order pas.">i</span>
                                    </span>
                                    <label class="switch">
                                        <input type="checkbox" id="{{INSTANCE_ID}}_limitKapasitasToggle" onchange="recalcAllHitungan('{{INSTANCE_ID}}')" checked>
                                        <span class="slider round"></span>
                                    </label>
                                </div>

                                <div class="summary-item-row" id="{{INSTANCE_ID}}_simulasiBoxRow" style="display: none;">
                                    <div class="summary-label" style="font-weight: 700; color: var(--color-alert-text);">‚ö† Simulasi Box Real (Over Capacity)</div>
                                    <div id="{{INSTANCE_ID}}_simulasiBoxReal" class="summary-value simulation"></div>
                                </div>
                            </div>

<div class="green-result-box">

                                <div id="{{INSTANCE_ID}}_manualBenurToggleContainer" class="simulasi-toggle-container" style="justify-content: space-between; margin-bottom: 5px;">
                                    <span class="simulasi-toggle-label" style="font-size: 0.9em; color: var(--color-alert-text);">Gunakan Override Manual?</span>
                                    <label class="switch">
                                        <input type="checkbox" id="{{INSTANCE_ID}}_manualBenurToggle" onchange="toggleManualBenurInput('{{INSTANCE_ID}}')">
                                        <span class="slider round"></span>
                                    </label>
                                </div>

                                <div class="summary-item-row" id="{{INSTANCE_ID}}_manualBenurInputRow" style="background: var(--color-card-recap); padding: 8px; border-radius: 6px; margin-top: 5px; display: none;">
                                    <div class="summary-label" style="font-size: 0.85em; font-style: italic;">
                                        Override Manual (Ekor):
                                    </div>
                                    <div class="allowance-inputs">
                                        <input type="number" id="{{INSTANCE_ID}}_manualBenurOverride" oninput="recalcAllHitungan('{{INSTANCE_ID}}')" style="width: 100px; font-weight: 700; text-align: right; color: var(--color-alert-text);">
                                        <button class="btn" onclick="clearManualBenur('{{INSTANCE_ID}}')" style="padding: 5px 8px; font-size: 0.7em; line-height: 1; min-width: 30px;" title="Reset Override">üîÑ</button>
                                    </div>
                                </div>

                                <div class="tester-result-box split-layout" id="{{INSTANCE_ID}}_benurPerKantongWrapper" 
                                     style="padding: 10px 5px; margin-top: 10px; border-top: 1px dashed var(--color-border); background: transparent; border: none; box-shadow: none;">
                                    
                                    <div class="result-box-split" id="{{INSTANCE_ID}}_benurPerKantongRealBox" style="background: var(--color-tester-result-bg); border-color: var(--color-card-hitung-border);">
                                        <div class="label" id="{{INSTANCE_ID}}_benurPerKantongRealLabel" style="font-size: 0.7em; color: var(--color-tester-result-text);">
                                            Benur/Kantong (Real)
                                            <small class="text-muted" style="font-size: 0.9em; display: block; color: inherit; opacity: 0.7;">(Rata-rata - A1)</small>
                                        </div>
                                        <div id="{{INSTANCE_ID}}_benurPerKantongReal" class="result-value" style="font-size: 1.5em; color: var(--color-text-sum);">
                                            <span>0</span> <small>ekor/kantong</small>
                                        </div>
                                    </div>
                                    
                                    <div class="result-box-split estimasi-box" id="{{INSTANCE_ID}}_benurPerKantongSJBox" style="display: none; background: var(--color-card-bg); border-color: var(--color-accent);">
                                        <div class="label" id="{{INSTANCE_ID}}_benurPerKantongSJLabel" style="font-size: 0.7em; color: var(--color-accent);">
                                            Benur/Kantong (SJ)
                                            <small class="text-muted" style="font-size: 0.9em; display: block; color: inherit; opacity: 0.7;">(Rata-rata - A1 - A2)</small>
                                        </div>
                                        <div id="{{INSTANCE_ID}}_benurPerKantongSJ" class="result-value" style="font-size: 1.5em; color: var(--color-accent);">
                                            <span>0</span> <small>ekor/kantong</small>
                                        </div>
                                    </div>
                                </div>
                                </div>

                            <section class="grey-summary-box" id="{{INSTANCE_ID}}_selisihBox" style="display: none; margin-top: 15px;">
                                <div class="summary-item-row" style="border-bottom: 1px solid var(--color-border);">
                                    <div class="summary-label" style="font-weight: 700; color: var(--color-accent); font-size: 0.95em;">üê† Rekap Packing</div>
                                </div>

                                <div class="summary-item-row">
                                    <span class="summary-label">Total Benur Packing</span>
                                    <span class="summary-value real-sj" id="{{INSTANCE_ID}}_selisih_totalPacking">0</span>
                                </div>
                                <div class="summary-item-row">
                                    <span class="summary-label">Selisih (vs Order)</span>
                                    <span class="summary-value" id="{{INSTANCE_ID}}_selisih_selisihOrder">0</span>
                                </div>
                            
                                <div id="{{INSTANCE_ID}}_selisihWarningBox" style="display: none; margin-top: 15px; border-top: 1px dashed var(--color-recap-border); padding-top: 15px; text-align: center;">
                                    
                                    <h3 style="font-size: 0.9em; color: var(--color-alert-text); margin: 0 0 8px 0; display: flex; align-items: center; justify-content: center;">
                                        ‚ö† Peringatan Selisih! Cek Ulang:
                                        <span class="info-tooltip" onclick="showInfo(event)" title="Peringatan ini muncul jika Total Packing (Box * Benur/Kantong) memiliki selisih lebih dari 0.1% dari Total Order. Gunakan 'Simulasi' di bawah untuk menghitung ulang benur/kantong agar selisih pas.">i</span>
                                    </h3>
                                    
                                    <div class="simulasi-toggle-container" style="justify-content: center;">
                                        <span class="simulasi-toggle-label">Gunakan Simulasi</span>
                                        <label class="switch">
                                            <input type="checkbox" id="{{INSTANCE_ID}}_simulasiToggle" onchange="toggleSimulasiUsage('{{INSTANCE_ID}}')">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                    <div id="{{INSTANCE_ID}}_selisihFinalResult" style="font-size: 1.8em; font-weight: 700; color: var(--color-alert-text); text-align: center; background: var(--color-card-tester); padding: 10px; border-radius: 8px; margin-top: 10px;">
                                        0 ekor/kantong
                                    </div>
                                    <div id="{{INSTANCE_ID}}_selisihSimulasiResult" style="font-size: 0.9em; font-weight: 700; color: var(--color-text-light); margin-top: 8px;">
                                        Estimasi Selisih Baru: +0 ekor
                                    </div>
                                </div>
                            </section>
                        </div>
                                
                        <div class="actions-row">
                            </div>

                        <div id="{{INSTANCE_ID}}_hitunganTimestamp" class="time-stamp">üïí Terakhir diperbarui: -</div>
                    </div>
                </section>

                <section id="{{INSTANCE_ID}}_rekap" class="tab-panel">
                    <div class="card card-recap">
                        <h2>üìä Rekap Panen {{ID}}</h2>

                        <h3 class="recap-section-title">Data Panen</h3>
                        <div class="recap-row"><span class="recap-label">Customer</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_customer">-</span></div>
                        <div class="recap-row"><span class="recap-label">Tujuan</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_tujuan">-</span></div>
                        <div class="recap-row"><span class="recap-label">Tanggal Panen</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_line">-</span></div>
                        <div class="recap-row"><span class="recap-label">Driver</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_driver">-</span></div>
                        <div class="recap-row"><span class="recap-label">Plat Nomor</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_platNomor">-</span></div>
                        <div class="recap-row"><span class="recap-label">Order</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_orderBenur">0</span></div>
                        <div class="recap-row"><span class="recap-label">Truk</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_jenisTruk">-</span></div>
                        <div class="recap-row"><span class="recap-label">Kapasitas</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_kapasitasAngkut">0 Box</span></div>
                        <div class="recap-row"><span class="recap-label">Isi/Box</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_isiBox">0 Kantong</span></div>

                        <h3 class="recap-section-title">Data Tester</h3>
                        <div class="recap-row"><span class="recap-label">No. Bak Scooring</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_nomorBak">-</span></div>
                        <div class="recap-row"><span class="recap-label">Tomota</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_tomota">- ekor</span></div>
                        <div class="recap-row"><span class="recap-label">Œ£ Total</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_testerSum">0</span></div>
                        <div class="recap-row"><span class="recap-label">Density</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_testerDensity">-</span></div>
                        <div class="recap-row"><span class="recap-label">Allowance</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_allowanceTester">0 %</span></div>
                        <div class="recap-row"><span class="recap-label">Hasil Benur Tester</span><span class="recap-value final-result" id="{{INSTANCE_ID}}_recap_hasilTester">0</span></div>
                        <div class="recap-row"><span class="recap-label">Estimasi Box</span><span class="recap-value final-result-alert" id="{{INSTANCE_ID}}_recap_estimasiBoxTester">0 Box</span></div>

                        <div class="card-accordion" id="{{INSTANCE_ID}}_recapQcAccordion">
                            <div class="accordion-header" onclick="toggleAccordion(event)">
                                <h3>üß¨ Rekap Quality Control</h3>
                                <span class="accordion-toggle-icon">‚ûï</span>
                            </div>
                            <div class="accordion-panel recap-panel">
                                <div class="accordion-content-wrapper">
                                    <div class="recap-row"><span class="recap-label">Bak Asli</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_qcBakAsli">-</span></div>
                                    <div class="recap-row"><span class="recap-label">Suhu</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_qcSuhu">-</span></div>
                                    <div class="recap-row"><span class="recap-label">pH</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_qcPh">-</span></div>
                                    <div class="recap-row"><span class="recap-label">DO</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_qcDo">-</span></div>
                                    <div class="recap-row"><span class="recap-label">Salinitas</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_qcSalinitas">-</span></div>
                                    <div class="recap-row"><span class="recap-label">Jarak Tempuh</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_qcJarak">-</span></div>
                                    <div class="recap-row"><span class="recap-label">Biomassa</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_qcBiomassa">-</span></div>
                                    <div class="recap-row"><span class="recap-label">Panjang</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_qcPanjang">-</span></div>
                                    <div class="recap-row"><span class="recap-label">Stadia</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_qcStadia">-</span></div>
                                    <div class="recap-row"><span class="recap-label">Scooping</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_qcScooping">-</span></div>
                                    <div class="recap-row"><span class="recap-label">No. Scooping</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_qcNoScooping">-</span></div>
                                </div>
                            </div>
                        </div>
                        <h3 class="recap-section-title">Hasil Hitungan</h3>
                        <div id="{{INSTANCE_ID}}_recap_sessionSummary">
                            </div>
                        <div class="recap-row"><span class="recap-label">Rata-rata (Aktual)</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_avgValue">0 ekor</span></div>
                        <div class="recap-row"><span class="recap-label">Allowance</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_allowanceHitung">0% / 0%</span></div>
                        <div class="recap-row"><span class="recap-label">Kebutuhan Box</span><span class="recap-value final-result-alert" id="{{INSTANCE_ID}}_recap_kebutuhanBox">0 Box</span></div>
                        <div class="recap-row"><span class="recap-label">Benur/Kantong (Real)</span><span class="recap-value final-result" id="{{INSTANCE_ID}}_recap_benurReal">0 ekor/kantong</span></div>
                        <div class="recap-row" id="{{INSTANCE_ID}}_recap_benurSJ_row" style="display: none;"><span class="recap-label">Benur/Kantong (SJ)</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_benurSJ">0 ekor/kantong</span></div>
                        <div class="recap-row" id="{{INSTANCE_ID}}_recap_simulasi_row" style="display: none;"><span class="recap-label">‚ö† Simulasi Real</span><span class="recap-value final-result-alert" id="{{INSTANCE_ID}}_recap_simulasi">0 ekor/kantong</span></div>

                        <div class="actions-row">
                            <button class="btn save-to-vault" onclick="saveDataToVault('{{INSTANCE_ID}}')" title="Simpan data panen ini ke Vault">üíæ Simpan ke Vault</button>
                            <button class="btn" onclick="shareToCustomer('{{INSTANCE_ID}}')" title="Bagikan rincian panen ke Customer via Whatsapp">ü§≥üèª Bagikan ke Customer</button>
                            <button class="btn" onclick="shareAdmin('{{INSTANCE_ID}}')" title="Kirim rincian panen via WhatsApp">üöõ Kirim Rincian Panen</button>
                        </div>

                        <div id="{{INSTANCE_ID}}_recapTimestamp" class="time-stamp">üïí Terakhir diperbarui: -</div>
                    </div>
                </section>
                
            </div> </div> </div> </template>
<div class="floating-nav-bar">
    
    <div class="floating-nav-group left">
        <button id="floatingVaultBtn" class="floating-nav-btn vault-btn" onclick="toggleVault()" title="Buka Vault Data Panen">üóÑÔ∏è</button>
    </div>
    
    <div id="floatingNavCenter" class="floating-nav-group center">
        <button id="floatingPrevBtn" class="floating-nav-btn" title="Slide Sebelumnya" disabled>&lt;</button>
        <span id="floatingIndicator" class="floating-nav-indicator">1 / 1</span>
        <button id="floatingNextBtn" class="floating-nav-btn" title="Slide Berikutnya" disabled>&gt;</button>
    </div>
    
    <div class="floating-nav-group right">
        <button id="floatingCalcBtn" class="floating-nav-btn" onclick="toggleCalculator()" title="Buka Kalkulator">üßÆ</button>
    </div>

</div>

<div id="vaultOverlay" class="vault-overlay" onclick="toggleVault()"></div>
<div id="vaultContainer" class="vault-container">
    <div class="vault-header">
        <h2>üóÑÔ∏è Vault Data Panen</h2>
        <button id="exportVaultBtn" class="vault-export-btn" onclick="exportVaultToExcel(this)">üì§ Export ke Excel</button>
    </div>
    <div id="vaultList" class="vault-list">
        </div>
</div>

<style>
    .status-badge::after {
        content: '';
        position: absolute;
        bottom: -4px; /* Panah di bawah */
        left: 50%;
        transform: translateX(-50%);
        border-width: 4px;
        border-style: solid;
        border-color: transparent;
        /* Warna diatur oleh kelas di bawah */
    }
    
    /* Warna panah berdasarkan status */
    .status-badge.status-draft::after {
        border-top-color: #FFC107; /* Kuning */
    }
    .status-badge.status-terkirim::after {
        border-top-color: var(--color-text-sum); /* Hijau */
    }
    .status-badge.status-edited::after {
        border-top-color: var(--color-alert-text); /* Oranye */
    }
</style>

<script>

// ===================================
// [REVISI V6.9 - POIN 4] FUNGSI INFO (i)
// ===================================
function showInfo(event) {
    const infoEl = event.target;
    const message = infoEl.getAttribute('title');
    if (message) {
        alert(message);
    }
}

// ===================================
// [REVISI V6.4] FUNGSI TAB SLIDING
// ===================================

/**
 * [V6.4] Mengganti kartu yang terlihat dengan animasi geser profesional.
 */
function openCard(evt, cardIdToOpen, tabIndex) {
    const slideItem = evt.target.closest('.slide-item');
    if (!slideItem) return;

    // 1. Dapatkan track yang menampung semua panel tab
    const tabTrack = slideItem.querySelector('.card-tab-track');
    if (!tabTrack) return;

    // 2. Hapus status 'active' dari semua tombol tab
    const tabLinks = slideItem.querySelectorAll('.tab-link');
    tabLinks.forEach(link => {
        link.classList.remove('active');
    });

    // 3. Aktifkan tombol tab yang diklik
    evt.target.classList.add('active');

    // 4. Geser track ke posisi tab yang benar
    // (0 * -25% = 0%, 1 * -25% = -25%, dst.)
    const offset = tabIndex * -25;
    tabTrack.style.transform = `translateX(${offset}%)`;
}


/**
 * [V6.4] Membuka/menutup panel accordion (animasi CSS via grid)
 */
function toggleAccordion(event) {
    const header = event.currentTarget;
    header.classList.toggle('active');
    // Animasi sekarang ditangani murni oleh CSS di .accordion-panel
}

// ===================================
// GLOBAL VARIABLES & SETUP
// ===================================

let activeInstanceIndex = 0; // 0-based index
const slideTrack = document.getElementById('slideTrack');
const maxBox = 12; // Maksimal kolom hitungan per sesi
let autoSaveTimeout;
let statusLockTimeout = null; // <-- TAMBAHKAN BARIS INI

// [REVISI V6.0] Kunci Penyimpanan
const LOCAL_STORAGE_KEY = 'shrimpCountData_v5_SESSION'; 
const VAULT_STORAGE_KEY = 'shrimpCountData_v6_VAULT'; 

// Database Sopir
const sopirDB = {
  "Didi": { "nohp": "085351360595", "plat": "DK 8656 UE" },
  "Yandi": { "nohp": "081236248730", "plat": "DK 8252 UB" },
  "Suharsono": { "nohp": "081399102574", "plat": "DK 8250 UB" },
  "Rusdiana": { "nohp": "081287812738", "plat": "DK 8040 UD" },
  "Yana": { "nohp": "082146659061", "plat": "DK 8655 UE" },
  "Rizki": { "nohp": "081398994440", "plat": " DK 8995 UE" },
  "Ruksin": { "nohp": "081246101708", "plat": "DK 8079 UD" },
  "Dian": { "nohp": "082340074446", "plat": "DK 8079 UF" },
  "Anggi": { "nohp": "082169656871", "plat": "DK 8043 UD" },
  "Frendi": { "nohp": "082278912811", "plat": "DK 8078 UC" },
  "Asep Satria": { "nohp": "081337045654", "plat": "DK 8230 UB" },
  "M. Soleh": { "nohp": "082145810407", "plat": "DK 8996 UE" },
  "Awaludin": { "nohp": "085333533892", "plat": "DK 8580 VB" },
  "Yusup": { "nohp": "08881722094", "plat": "DK 8115 YU" },
  "Sidik": { "nohp": "082146807407", "plat": "DK 8745 VU" },
  "Romli": { "nohp": "082174445127", "plat": "DK 8945 VA" },
  "Anang": { "nohp": "085860259512", "plat": "DK 8349 VA" },
  "Sulaeman": { "nohp": "081337611536", "plat": "DK 8459 UZ" },
  "Jenal": { "nohp": "082127741992", "plat": "DK 8177 VU" }
};

/**
 * [PERBAIKAN ANDROID] Helper function untuk parsing angka yang aman.
 */
function safeParseFloat(value) {
    if (typeof value !== 'string') {
        value = String(value);
    }
    const cleanValue = value.replace(',', '.');
    return parseFloat(cleanValue) || 0;
}

// ===================================
// DARK MODE LOGIC
// ===================================
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDarkMode = document.body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isDarkMode);
    document.getElementById('darkModeToggle').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
}
function checkDarkModePreference() {
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeToggle').textContent = '‚òÄÔ∏è';
    } else {
        document.getElementById('darkModeToggle').textContent = 'üåô';
    }
}

// === [REVISI] Auto-Save Logic (Hanya untuk Sesi Aktif) ===
/**
 * [REVISI] Logika ini (Req 2) sudah benar: auto-save HANYA aktif saat
 * ada input (oninput -> recalcAll -> triggerAutoSave).
 * [REVISI] Logika badge 'Edited' juga ditangani di sini.
 */
function triggerAutoSave(instanceId) {
    // JIKA STATUS DIKUNCI (karena baru saja disimpan), JANGAN LAKUKAN APAPUN.
    if (statusLockTimeout) {
        clearTimeout(autoSaveTimeout); // Batalkan juga timer yang sedang berjalan
        return; 
    }

    const slideItem = document.getElementById(instanceId);
    if (!slideItem) return;

    // [REVISI] Logika Badge 'Edited' (Req 1)
    // Jika status saat ini 'Terkirim', ubah menjadi 'Edited'
    if (slideItem.dataset.status === 'Terkirim') {
        markStatus(instanceId, 'Edited');
    }
    
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
        // Ambil status terbaru setelah mungkin diubah
        const currentStatus = slideItem.dataset.status || 'Draft';
        saveSessionData(instanceId, true, currentStatus); // Simpan ke Sesi dengan status terbaru
    }, 1500);
}

// ===================================
// [REVISI V6.8] TEMPLATE & CAROUSEL LOGIC
// ===================================

/**
 * [V6.8] Fungsi ini sekarang menerima ID visual (misal "1") dan
 * ID unik sistem (misal "instance_171234567")
 */
function createInstanceHTML(id, instanceId) {
    const templateHTML = document.getElementById('panen-template').innerHTML;
    const finalHTML = templateHTML
        .replace(/{{INSTANCE_ID}}/g, instanceId) // Gunakan instanceId unik
        .replace(/{{ID}}/g, id); // Gunakan id untuk visual
    return finalHTML;
}

function updateCarouselControls() {
    const total = slideTrack.children.length;
    const indicatorText = `${activeInstanceIndex + 1} / ${total}`;
    
    document.getElementById('floatingIndicator').textContent = indicatorText;
    document.getElementById('floatingPrevBtn').disabled = (activeInstanceIndex <= 0);
    document.getElementById('floatingNextBtn').disabled = (activeInstanceIndex >= total - 1);
    document.getElementById('floatingNavCenter').style.display = (total > 1) ? 'flex' : 'none';

    // Perbarui status tombol hapus untuk SEMUA slide
    const allRemoveButtons = slideTrack.querySelectorAll('.remove-btn');
    allRemoveButtons.forEach(btn => {
        btn.disabled = (total <= 1);
    });
}


function goToSlide(index) {
    const total = slideTrack.children.length;
    if (index >= 0 && index < total) {
        activeInstanceIndex = index;
        const offset = -activeInstanceIndex * 100;
        slideTrack.style.transform = `translateX(${offset}%)`;
        updateCarouselControls();
    }
}

/**
 * [REVISI V6.8 - PERBAIKAN BUG REQ 3]
 * Logika 'addInstance' yang baru dan stabil.
 * - Menerima dataToLoad dan existingInstanceId opsional.
 * - Memperbaiki bug load "driver hilang" dan "carousel bertambah".
 */
function addInstance(dataToLoad = null, existingInstanceId = null) {
    const visualId = slideTrack.children.length + 1; // ID visual (1, 2, 3...)
    
    // [FIX REQ 3] Gunakan ID yang ada jika disediakan (dari localStorage), jika tidak, buat ID baru.
    const uniqueId = existingInstanceId ? existingInstanceId : `instance_${Date.now()}_${Math.floor(Math.random() * 100)}`; 
    
    const newInstanceHTML = createInstanceHTML(visualId, uniqueId);
    slideTrack.insertAdjacentHTML('beforeend', newInstanceHTML);
    
    // Set ID unik ke elemen slide-item itu sendiri
    const newSlideItem = slideTrack.lastChild;
    newSlideItem.id = uniqueId; 

    // [FIX REQ 3] Selalu inisialisasi elemen dasar (seperti driver) SEBELUM memuat data
    populateDriverOptions(uniqueId);
    initBoxesTester(uniqueId); 
    
    if (dataToLoad) {
        // Jika memuat data (dari localStorage atau Vault), panggil loadDataFromObject.
        // loadDataFromObject akan menangani pembuatan grid hitungan.
        loadDataFromObject(uniqueId, dataToLoad);
    } else {
        // Jika ini adalah slide baru (tombol +)
        // Inisialisasi default
        updateTruckDetails(uniqueId);
        addHitunganSession(uniqueId); 
        addHitunganSession(uniqueId); 
        updateRecap(uniqueId);
        markStatus(uniqueId, 'Draft');
        goToSlide(slideTrack.children.length - 1); // Pindah ke slide baru
    }

    // [FIX REQ 3] Selalu panggil updateCarouselControls di akhir
    updateCarouselControls();
}


/**
 * [V6.8] Logika 'removeInstance' yang baru dan aman.
 * - TIDAK ADA LAGI "RE-INDEXING" yang rumit dan berbahaya.
 * - Hanya menghapus DOM dan data localStorage yang spesifik.
 */
function removeInstance() {
    const total = slideTrack.children.length;
    if (total <= 1) {
        alert("Tidak bisa menghapus! Minimal harus ada 1 Data Panen.");
        return;
    }

    // Dapatkan slide aktif dan ID uniknya
    const slideToRemove = slideTrack.children[activeInstanceIndex];
    if (!slideToRemove) return; // Pengaman
    
    const removedInstanceId = slideToRemove.id; // Dapatkan ID unik (misal "instance_171234567")
    const visualTitle = slideToRemove.querySelector('.title-text')?.textContent || `Data Panen ${activeInstanceIndex + 1}`;
    
    if (!confirm(`Hapus slide "${visualTitle}"? \n\n(Data yang sudah tersimpan di Vault tidak akan terhapus).`)) return;

    const removedStorageKey = `${LOCAL_STORAGE_KEY}_${removedInstanceId}`;

    try {
        // 1. Hapus dari localStorage
        localStorage.removeItem(removedStorageKey);
        
        // 2. Hapus dari DOM
        slideTrack.removeChild(slideToRemove);
    } catch (e) {
        console.warn(`Gagal menghapus instance ${removedInstanceId}`, e);
        alert(`Gagal menghapus data: ${e.message}`);
        return; // Hentikan jika gagal
    }

    // 3. Atur ulang index aktif
    if (activeInstanceIndex >= slideTrack.children.length) {
        activeInstanceIndex = slideTrack.children.length - 1;
    }

    // 4. Perbarui UI (Pindah ke slide baru & update kontrol)
    goToSlide(activeInstanceIndex);
    // updateCarouselControls() sudah dipanggil di dalam goToSlide()
}

// ===================================
// GENERAL HELPER FUNCTIONS
// ===================================
function getEl(instanceId, id) {
    return document.getElementById(`${instanceId}_${id}`);
}

function populateDriverOptions(instanceId) {
    const selectEl = getEl(instanceId, 'driver');
    if (!selectEl) return;
    selectEl.innerHTML = '<option value="">--- Pilih Sopir ---</option>';
    const sortedDrivers = Object.keys(sopirDB).sort();
    sortedDrivers.forEach(driverName => {
        const option = document.createElement('option');
        option.value = driverName;
        option.textContent = driverName;
        selectEl.appendChild(option);
    });
}

function updateDriverDetails(instanceId) {
    const driverSelect = getEl(instanceId, 'driver');
    const platInput = getEl(instanceId, 'platNomor');
    if (!driverSelect || !platInput) return; // Safety check
    const driverName = driverSelect.value;
    if (driverName && sopirDB[driverName]) {
        platInput.value = sopirDB[driverName].plat.trim();
    } else {
        platInput.value = '';
    }
    updateRecap(instanceId);
}

function resetCard1(instanceId) {
    if (!confirm(`Reset semua DATA PANEN (Kartu 1) untuk slide ini?`)) return;
    getEl(instanceId, 'line').value = '';
    getEl(instanceId, 'customer').value = '';
    getEl(instanceId, 'tujuan').value = '';
    getEl(instanceId, 'nominalOrder').value = '0';
    getEl(instanceId, 'jenisTruk').value = 'Euro2';
    getEl(instanceId, 'driver').selectedIndex = 0;
    getEl(instanceId, 'platNomor').value = '';
    updateTruckDetails(instanceId);
    recalcAllHitungan(instanceId);
    recalcAllTester(instanceId);
}

function updateTruckDetails(instanceId){
  const j=getEl(instanceId, 'jenisTruk').value;
  const i=getEl(instanceId, 'isiBox');
  const k=getEl(instanceId, 'kapasitasAngkut');
  if(j.includes('Euro2')){i.value=2;k.value=240;}
  else if(j.includes('Euro4')){i.value=2;k.value=258;}
  else if(j.includes('Bandara')){i.value=6;k.value=120;}
  else {i.value='';k.value='';}
  updateRecap(instanceId);
}
function timestampNow(instanceId, elementId){
  const el = getEl(instanceId, elementId);
  if (!el) return;
  const d=new Date();
  const opt={day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'};
  el.textContent='üïí Terakhir diperbarui: '+d.toLocaleString('id-ID',opt);
}
function getDensityDivisor(instanceId) {
    const jenisTrukEl = getEl(instanceId, 'jenisTruk');
    if (!jenisTrukEl) return 5; // Default
    const jenis = jenisTrukEl.value.toLowerCase();
    return jenis.includes('bandara') ? 3 : 5;
}
function formatCurrency(input) {
    let value = input.value.replace(/\./g, '');
    if (value) { input.value = parseFloat(value).toLocaleString('id-ID'); }
}
function roundToNearestTen(num) {
    if (typeof num !== 'number') return 0;
    return Math.round(num / 10) * 10;
}

// ===================================
// CARD 2: TESTER LOGIC
// ===================================
function recalcAllTester(instanceId){
  const gridTester = getEl(instanceId, 'hitGridTester');
  const sumTesterEl = getEl(instanceId, 'testerSum');
  const densTesterEl = getEl(instanceId, 'testerDensity');
  const allowanceInput = getEl(instanceId, 'allowanceTester');
  const finalResultEl = getEl(instanceId, 'finalTesterResult');
  if (!gridTester || !sumTesterEl || !densTesterEl || !allowanceInput || !finalResultEl) return;
  
  const vals=[...gridTester.querySelectorAll('input')].map(i=>safeParseFloat(i.value));
  const s=vals.reduce((a,b)=>a+b,0);
  sumTesterEl.textContent=s.toLocaleString();
  let div=getDensityDivisor(instanceId);
  densTesterEl.textContent=(s?Math.round(s/div):'-').toLocaleString();
  const allowancePercent = safeParseFloat(allowanceInput.value) / 100;
  let finalBenurTester = 0;
  if (s > 0) {
      finalBenurTester = Math.round(s * (1 - allowancePercent));
  }
  finalResultEl.textContent = finalBenurTester.toLocaleString();
  const estimasiBoxEl = getEl(instanceId, 'estimasiBoxTester');
  const nominalOrderEl = getEl(instanceId, 'nominalOrder');
  const isiBoxEl = getEl(instanceId, 'isiBox');
  if (!estimasiBoxEl || !nominalOrderEl || !isiBoxEl) return;

  const nominalText = nominalOrderEl.value.replace(/\./g,'');
  const nominalOrderEkor = parseFloat(nominalText)||0;
  const isiBox = parseFloat(isiBoxEl.value)||0;
  let estimasiBox = 0;
  if (nominalOrderEkor > 0 && finalBenurTester > 0 && isiBox > 0) {
      estimasiBox = Math.ceil(nominalOrderEkor / finalBenurTester / isiBox);
  }
  estimasiBoxEl.textContent = estimasiBox.toLocaleString() + ' Box';
  timestampNow(instanceId, 'testerTimestamp');
  updateRecap(instanceId);
  triggerAutoSave(instanceId);
}
function initBoxesTester(instanceId){
    const gridTester = getEl(instanceId, 'hitGridTester');
    if (!gridTester) return; // Safety check
    gridTester.innerHTML=''; // Kosongkan dulu
    for(let i=0;i<8;i++){
        const box=document.createElement('div');box.className='calc-box';
        const input=document.createElement('input');input.type='number';input.placeholder='0';
        input.oninput=() => recalcAllTester(instanceId);
        box.appendChild(input);
        gridTester.appendChild(box);
    }
}
function resetTester(instanceId){
  if(!confirm('Reset semua input Hitungan Tester dan QC untuk Data Panen ini?'))return;
  getEl(instanceId, 'nomorBak').value='';
  getEl(instanceId, 'tomota').value='';
  getEl(instanceId, 'allowanceTester').value='0';
  getEl(instanceId, 'qcBakAsli').value='';
  getEl(instanceId, 'qcSuhu').value='';
  getEl(instanceId, 'qcPh').value='';
  getEl(instanceId, 'qcDo').value='';
  getEl(instanceId, 'qcSalinitas').value='';
  getEl(instanceId, 'qcJarak').value='';
  getEl(instanceId, 'qcBiomassa').value='';
  getEl(instanceId, 'qcPanjang').value='';
  getEl(instanceId, 'qcStadia').value='';
  getEl(instanceId, 'qcScooping').value='';
  getEl(instanceId, 'qcNoScooping').value='';
  
  initBoxesTester(instanceId);
  recalcAllTester(instanceId);
}

// ===================================
// CARD 3 & 4: HITUNGAN MULTI SESI LOGIC
// ===================================
let sessionCounter = {};

function resetSessionRow(event, instanceId, sessionId) {
    event.stopPropagation(); 
    if (!confirm(`Reset semua 8 kolom hitungan untuk Baris ${sessionId} ini?`)) return;
    const grid = document.getElementById(`${instanceId}_sessionGrid${sessionId}`);
    if (!grid) return;
    const inputs = grid.querySelectorAll('input');
    inputs.forEach(input => { input.value = ''; });
    recalcSession(instanceId, sessionId);
    recalcAllHitungan(instanceId);
}

function recalcSession(instanceId, sessionId) {
    const grid = document.getElementById(`${instanceId}_sessionGrid${sessionId}`);
    const sumEl = document.getElementById(`${instanceId}_sessionSum${sessionId}`);
    if (!grid || !sumEl) return; 
    const vals = [...grid.querySelectorAll('input')].map(i => safeParseFloat(i.value));
    const s = vals.reduce((a,b)=>a+b,0);
    sumEl.innerHTML = s.toLocaleString('id-ID');
}
function toggleManualBenurInput(instanceId) {
    const toggle = getEl(instanceId, 'manualBenurToggle');
    const inputRow = getEl(instanceId, 'manualBenurInputRow');
    if (!toggle || !inputRow) return;
    if (toggle.checked) {
        inputRow.style.display = 'flex';
    } else {
        inputRow.style.display = 'none';
        clearManualBenur(instanceId, true); 
    }
    recalcAllHitungan(instanceId);
}
function clearManualBenur(instanceId, silent = false) {
    const manualInput = getEl(instanceId, 'manualBenurOverride');
    if (manualInput) { manualInput.value = ''; }
    const manualToggle = getEl(instanceId, 'manualBenurToggle');
    if (manualToggle) { manualToggle.checked = false; }
    const inputRow = getEl(instanceId, 'manualBenurInputRow');
     if (inputRow) { inputRow.style.display = 'none'; }
    if (!silent) { recalcAllHitungan(instanceId); }
}

function recalcAllHitungan(instanceId) {
    const multiSessionGrid = getEl(instanceId, 'multiSessionGrid');
    if (!multiSessionGrid) return;
    
    const sessions = multiSessionGrid.querySelectorAll('.hit-session');
    let totalSum = 0;
    let validSessions = 0;
    sessions.forEach(session => {
        const sessionId = session.dataset.sessionId;
        recalcSession(instanceId, sessionId);
        const sumTextEl = document.getElementById(`${instanceId}_sessionSum${sessionId}`);
        if(sumTextEl) {
            const sumText = sumTextEl.textContent.replace(/\./g,'');
            const sumVal = parseFloat(sumText)||0;
            if (sumVal > 0) { totalSum += sumVal; validSessions++; }
        }
    });
    const averageSum = validSessions > 0 ? totalSum / validSessions : 0;
    const avgRounded = Math.round(averageSum);
    
    const nominalOrderEl = getEl(instanceId, 'nominalOrder');
    const isiBoxEl = getEl(instanceId, 'isiBox');
    const kapasitasAngkutEl = getEl(instanceId, 'kapasitasAngkut');
    const allowance1El = getEl(instanceId, 'allowance1');
    const allowance2El = getEl(instanceId, 'allowance2');
    const orderDisplayEl = getEl(instanceId, 'orderDisplay');
    const avgValueDisplayEl = getEl(instanceId, 'avgValueDisplay');

    if (!nominalOrderEl || !isiBoxEl || !kapasitasAngkutEl || !allowance1El || !allowance2El || !orderDisplayEl || !avgValueDisplayEl) return;

    const nominalText = nominalOrderEl.value.replace(/\./g,'');
    const nominalOrderEkor = parseFloat(nominalText)||0;
    const isiBox = parseFloat(isiBoxEl.value)||0;
    const kapasitasAngkut = parseFloat(kapasitasAngkutEl.value)||0;
    const allowance1Input = safeParseFloat(allowance1El.value);
    const allowance2Input = safeParseFloat(allowance2El.value);
    const allowance1 = allowance1Input / 100;
    const allowance2 = allowance2Input / 100;
    
    orderDisplayEl.textContent = nominalOrderEkor.toLocaleString();
    avgValueDisplayEl.textContent = avgRounded.toLocaleString() + ' ekor';

    const calculatedBenur_Real_Murni = roundToNearestTen(avgRounded * (1 - allowance1));
    
    let kebutuhanBox_Murni = 0;
    if (nominalOrderEkor > 0 && calculatedBenur_Real_Murni > 0 && isiBox > 0) {
        kebutuhanBox_Murni = Math.ceil(nominalOrderEkor / calculatedBenur_Real_Murni / isiBox);
    }

    const isOverCapacity = (kebutuhanBox_Murni > kapasitasAngkut) && (kapasitasAngkut > 0);
    const limitKapasitasToggle = getEl(instanceId, 'limitKapasitasToggle');
    const limitKapasitas = limitKapasitasToggle && limitKapasitasToggle.checked && isOverCapacity;
    
    let kebutuhanBox_Terbatas = kebutuhanBox_Murni;
    let benurPerKantong_SimulasiOverCapacity = 0;
    let simulationNeeded = false;

    if (limitKapasitas) {
        simulationNeeded = true;
        kebutuhanBox_Terbatas = kapasitasAngkut; 
        const simulasiTotalKantong = kapasitasAngkut * isiBox;
        if (simulasiTotalKantong > 0) {
            benurPerKantong_SimulasiOverCapacity = roundToNearestTen(nominalOrderEkor / simulasiTotalKantong);
        }
    }

    const kebutuhanBoxEl = getEl(instanceId, 'kebutuhanBox');
    if (kebutuhanBoxEl) {
        kebutuhanBoxEl.textContent = kebutuhanBox_Terbatas.toLocaleString() + (limitKapasitas ? ' Box (MAX)' : ' Box');
    }
    
    const simulasiBoxRow = getEl(instanceId, 'simulasiBoxRow');
    if (simulasiBoxRow) {
        if (simulationNeeded) {
            simulasiBoxRow.style.display = 'flex';
            getEl(instanceId, 'simulasiBoxReal').textContent = benurPerKantong_SimulasiOverCapacity.toLocaleString() + ' ekor/kantong';
        } else {
            simulasiBoxRow.style.display = 'none';
        }
    }
    
    const benurPerKantong_Real_Dasar = simulationNeeded ? benurPerKantong_SimulasiOverCapacity : calculatedBenur_Real_Murni;

    const manualBenurToggle = getEl(instanceId, 'manualBenurToggle');
    const manualBenurInput = getEl(instanceId, 'manualBenurOverride');
    const manualBenurValue = manualBenurInput ? safeParseFloat(manualBenurInput.value) : 0;
    const useManualBenurToggle = manualBenurToggle && manualBenurToggle.checked;

    const simulasiSelisihToggle = getEl(instanceId, 'simulasiToggle');
    const useSimulasiSelisih = simulasiSelisihToggle && simulasiSelisihToggle.checked;
    
    let benurPerKantong_Real_Final = 0;
    let usingManualBenur = false;
    let usingSimulasiSelisih = false;
    let selisihSimulasiValue = 0; 

    if (useManualBenurToggle && manualBenurValue > 0) {
        benurPerKantong_Real_Final = manualBenurValue;
        usingManualBenur = true;
    } else {
        benurPerKantong_Real_Final = benurPerKantong_Real_Dasar; 
    }
    
    const selisihBoxEl = getEl(instanceId, 'selisihBox');
    const totalPackingEl = getEl(instanceId, 'selisih_totalPacking');
    const selisihOrderEl = getEl(instanceId, 'selisih_selisihOrder');
    const selisihWarningBox = getEl(instanceId, 'selisihWarningBox');
    const selisihFinalResultEl = getEl(instanceId, 'selisihFinalResult');

    if (selisihBoxEl && totalPackingEl && selisihOrderEl && kebutuhanBox_Terbatas > 0 && isiBox > 0) {
        const totalPacking_Murni = kebutuhanBox_Terbatas * isiBox * benurPerKantong_Real_Dasar;
        const selisihOrder_Murni = totalPacking_Murni - nominalOrderEkor;
        const batasWajar = nominalOrderEkor * 0.001; 

        if (selisihWarningBox && !usingManualBenur && selisihOrder_Murni > batasWajar && nominalOrderEkor > 0) {
            const targetTotalPacking = nominalOrderEkor * 1.001; 
            const newBenurPerKantong = targetTotalPacking / kebutuhanBox_Terbatas / isiBox;
            selisihSimulasiValue = roundToNearestTen(newBenurPerKantong); 

            if (benurPerKantong_Real_Dasar === selisihSimulasiValue) {
                 selisihWarningBox.style.display = 'none';
                 if (simulasiSelisihToggle) simulasiSelisihToggle.checked = false;
            } else {
                selisihWarningBox.style.display = 'block';
                if(selisihFinalResultEl) selisihFinalResultEl.textContent = selisihSimulasiValue.toLocaleString('id-ID') + ' ekor/kantong';
                
                const newTotalPacking = kebutuhanBox_Terbatas * isiBox * selisihSimulasiValue;
                const newSelisih = newTotalPacking - nominalOrderEkor;
                const selisihSimulasiResultEl = getEl(instanceId, 'selisihSimulasiResult');
                if (selisihSimulasiResultEl) {
                    selisihSimulasiResultEl.textContent = 'Estimasi Selisih Baru: ' + (newSelisih >= 0 ? '+' : '') + newSelisih.toLocaleString('id-ID') + ' ekor';
                }
            }
            if (useSimulasiSelisih && selisihSimulasiValue > 0) {
                 benurPerKantong_Real_Final = selisihSimulasiValue; 
                 usingSimulasiSelisih = true;
            }

        } else if (selisihWarningBox) {
            selisihWarningBox.style.display = 'none';
            if (simulasiSelisihToggle) simulasiSelisihToggle.checked = false;
        }

        const totalPacking_Final = kebutuhanBox_Terbatas * isiBox * benurPerKantong_Real_Final;
        const selisihOrder_Final = totalPacking_Final - nominalOrderEkor;
        
        totalPackingEl.textContent = totalPacking_Final.toLocaleString('id-ID') + ' ekor';
        selisihOrderEl.textContent = (selisihOrder_Final >= 0 ? '+' : '') + selisihOrder_Final.toLocaleString('id-ID') + ' ekor';
        selisihOrderEl.classList.toggle('positive', selisihOrder_Final >= 0);
        selisihOrderEl.classList.toggle('negative', selisihOrder_Final < 0);
        selisihBoxEl.style.display = 'block'; 

    } else if (selisihBoxEl) {
        selisihBoxEl.style.display = 'none'; 
        if (selisihWarningBox) selisihWarningBox.style.display = 'none';
        if (simulasiSelisihToggle) simulasiSelisihToggle.checked = false;
    }
    
    const sjAdjustment = benurPerKantong_Real_Final * allowance2;
    const benurPerKantong_SJ_Final = roundToNearestTen(benurPerKantong_Real_Final - sjAdjustment);
    
    const realDisplayEl = getEl(instanceId, 'benurPerKantongReal');
    const sjDisplayEl = getEl(instanceId, 'benurPerKantongSJ');
    
    if(realDisplayEl) {
        const span = realDisplayEl.querySelector('span');
        if (span) span.textContent = benurPerKantong_Real_Final.toLocaleString();
    }
    if(sjDisplayEl) {
        const span = sjDisplayEl.querySelector('span');
        if (span) span.textContent = benurPerKantong_SJ_Final.toLocaleString();
    }
    
    const sjRow = getEl(instanceId, 'benurPerKantongSJBox');
    if (allowance2Input > 0) {
        if(sjRow) sjRow.style.display = 'block';
    } else {
        if(sjRow) sjRow.style.display = 'none';
    }

    const realDisplayBox = getEl(instanceId, 'benurPerKantongRealBox');
    const sjDisplayBox = getEl(instanceId, 'benurPerKantongSJBox');

    let highlightFont = usingManualBenur || simulationNeeded || usingSimulasiSelisih;
    let highlightBg = usingManualBenur || simulationNeeded;

    if (realDisplayBox && realDisplayEl) {
        realDisplayEl.style.color = highlightFont ? 'var(--color-alert-text)' : 'var(--color-text-sum)';
        realDisplayBox.style.background = highlightBg ? 'var(--color-card-tester)' : 'var(--color-tester-result-bg)';
        const realLabel = realDisplayBox.querySelector('.label');
        if(realLabel) realLabel.style.color = highlightFont ? 'var(--color-alert-text)' : 'var(--color-tester-result-text)';
    }
    if (sjDisplayBox && sjDisplayEl) {
        sjDisplayEl.style.color = highlightFont ? 'var(--color-alert-text)' : 'var(--color-accent)';
        sjDisplayBox.style.background = highlightBg ? 'var(--color-card-tester)' : 'var(--color-card-bg)';
        const sjLabel = sjDisplayBox.querySelector('.label');
        if(sjLabel) sjLabel.style.color = highlightFont ? 'var(--color-alert-text)' : 'var(--color-accent)';
    }
    
    timestampNow(instanceId, 'hitunganTimestamp');
    updateRecap(instanceId);
    triggerAutoSave(instanceId);
}
function toggleSimulasiUsage(instanceId) {
    recalcAllHitungan(instanceId);
}
function addHitunganSession(instanceId) {
    const multiSessionGrid = getEl(instanceId, 'multiSessionGrid');
    if (!multiSessionGrid) return; 
    if (!sessionCounter[instanceId]) { sessionCounter[instanceId] = 0; }
    sessionCounter[instanceId]++;
    const sessionId = sessionCounter[instanceId];
    const newSession = document.createElement('div');
    newSession.className = 'hit-session';
    newSession.dataset.sessionId = sessionId;
    
    newSession.innerHTML = `
        <div class="session-summary">
            <span class="session-label">Hitungan ${sessionId}:</span>
            <span class="results">
                Œ£ <span id="${instanceId}_sessionSum${sessionId}" class="sum-value">0</span>
                <button class="btn-reset-row" onclick="resetSessionRow(event, '${instanceId}', ${sessionId})" title="Reset Baris Ini">üîÑ</button>
            </span>
        </div>
        <div id="${instanceId}_sessionGrid${sessionId}" class="hit-grid"></div>
    `;
    multiSessionGrid.appendChild(newSession);
    
    const grid = document.getElementById(`${instanceId}_sessionGrid${sessionId}`);
    for (let i = 0; i < 8; i++) {
        const box = document.createElement('div');
        box.className = 'calc-box';
        const input = document.createElement('input');
        input.type = 'number';
        input.placeholder = '0';
        input.oninput = function() { recalcSession(instanceId, sessionId); recalcAllHitungan(instanceId); };
        box.appendChild(input);
        grid.appendChild(box);
    }
    recalcAllHitungan(instanceId);
}
function removeHitunganSession(instanceId) {
    const multiSessionGrid = getEl(instanceId, 'multiSessionGrid');
    if (!multiSessionGrid) return;
    const sessions = multiSessionGrid.querySelectorAll('.hit-session');
    if (sessions.length > 0) {
        sessions[sessions.length - 1].remove();
    }
    recalcAllHitungan(instanceId);
}
function resetHitungan(instanceId) {
    if (!confirm('Reset semua input Hitungan, Allowance, dan Override untuk Data Panen ini?')) return;
    const multiSessionGrid = getEl(instanceId, 'multiSessionGrid');
    if(multiSessionGrid) multiSessionGrid.innerHTML = '';
    sessionCounter[instanceId] = 0;
    addHitunganSession(instanceId);
    addHitunganSession(instanceId);
    getEl(instanceId, 'allowance1').value = '0';
    getEl(instanceId, 'allowance2').value = '0';
    
    const simulasiToggle = getEl(instanceId, 'simulasiToggle');
    if (simulasiToggle) simulasiToggle.checked = false;
    
    clearManualBenur(instanceId, true); 
    recalcAllHitungan(instanceId);
}

addCalcBox = (fullGridId) => {
    const parts = fullGridId.split('_');
    const instanceId = parts.slice(0, 3).join('_'); 
    const gridType = parts[parts.length - 1]; 
    const grid = document.getElementById(fullGridId);
    if (!grid) return; 
    
    const c=grid.querySelectorAll('.calc-box').length;
    if(gridType === 'hitGridTester' && c>=maxBox){alert('Maks '+maxBox+' kolom per sesi.');return;}

    if (gridType === 'hitGridTester') {
        const box=document.createElement('div');box.className='calc-box';
        const input=document.createElement('input');input.type='number';input.placeholder='0';
        input.oninput = () => recalcAllTester(instanceId);
        box.appendChild(input);
        grid.appendChild(box);
    }
};

removeCalcBox = (fullGridId) => {
    const parts = fullGridId.split('_');
    const instanceId = parts.slice(0, 3).join('_'); 
    const gridType = parts[parts.length - 1]; 
    const grid = document.getElementById(fullGridId);
    if (!grid) return; 
    
    let shouldRecalc = false;
    if (gridType === 'hitGridTester') {
        const b=grid.querySelectorAll('.calc-box');
        if(b.length){b[b.length-1].remove(); shouldRecalc = true;}
        if (shouldRecalc) recalcAllTester(instanceId);
    }
};


// ===================================
// CARD 5: REKAP LOGIC
// ===================================
function updateRecap(instanceId) {
    const setRecap = (targetId, sourceEl, isInput = true, fallback = '-', suffix = '') => {
        if (!sourceEl) {
             const elFallback = getEl(instanceId, targetId);
             if (elFallback) elFallback.textContent = fallback + suffix;
             return;
        }
        const val = isInput ? sourceEl.value : sourceEl.textContent;
        const el = getEl(instanceId, targetId);
        if (el) {
            el.textContent = (val || fallback) + suffix;
        }
    };
    setRecap('recap_customer', getEl(instanceId, 'customer'));
    setRecap('recap_tujuan', getEl(instanceId, 'tujuan'));
    setRecap('recap_line', getEl(instanceId, 'line'));
    setRecap('recap_driver', getEl(instanceId, 'driver'));
    setRecap('recap_platNomor', getEl(instanceId, 'platNomor'));
    setRecap('recap_orderBenur', getEl(instanceId, 'nominalOrder'), true, '0');
    setRecap('recap_jenisTruk', getEl(instanceId, 'jenisTruk'));
    setRecap('recap_kapasitasAngkut', getEl(instanceId, 'kapasitasAngkut'), true, '0', ' Box');
    setRecap('recap_isiBox', getEl(instanceId, 'isiBox'), true, '0', ' Kantong');
    setRecap('recap_nomorBak', getEl(instanceId, 'nomorBak'));
    setRecap('recap_tomota', getEl(instanceId, 'tomota'), true, '-', ' ekor');
    setRecap('recap_testerSum', getEl(instanceId, 'testerSum'), false, '0');
    setRecap('recap_testerDensity', getEl(instanceId, 'testerDensity'), false, '-');
    setRecap('recap_allowanceTester', getEl(instanceId, 'allowanceTester'), true, '0', ' %');
    setRecap('recap_hasilTester', getEl(instanceId, 'finalTesterResult'), false, '0');
    setRecap('recap_estimasiBoxTester', getEl(instanceId, 'estimasiBoxTester'), false, '0 Box');
    
    setRecap('recap_qcSuhu', getEl(instanceId, 'qcSuhu'), true, '-', ' ¬∞C');
    setRecap('recap_qcPh', getEl(instanceId, 'qcPh'), true, '-');
    setRecap('recap_qcDo', getEl(instanceId, 'qcDo'), true, '-', ' ppm');
    setRecap('recap_qcSalinitas', getEl(instanceId, 'qcSalinitas'), true, '-', ' ppt');
    setRecap('recap_qcJarak', getEl(instanceId, 'qcJarak'), true, '-', ' Jam');
    setRecap('recap_qcBiomassa', getEl(instanceId, 'qcBiomassa'), true, '-', ' gr');
    setRecap('recap_qcPanjang', getEl(instanceId, 'qcPanjang'), true, '-', ' mm');
    setRecap('recap_qcStadia', getEl(instanceId, 'qcStadia'));
    setRecap('recap_qcScooping', getEl(instanceId, 'qcScooping'));
    setRecap('recap_qcNoScooping', getEl(instanceId, 'qcNoScooping'));
    setRecap('recap_qcBakAsli', getEl(instanceId, 'qcBakAsli'));
    
    const multiSessionGrid = getEl(instanceId, 'multiSessionGrid');
    let sessionHtml = '';
    if (multiSessionGrid) {
        const sessions = multiSessionGrid.querySelectorAll('.hit-session');
        sessions.forEach(session => {
            const labelEl = session.querySelector('.session-label');
            const sumEl = document.getElementById(`${instanceId}_sessionSum${session.dataset.sessionId}`);
            if (labelEl && sumEl) {
                const label = labelEl.textContent.trim();
                const sum = sumEl.textContent.trim();
                sessionHtml += `<div class="recap-row-small"><span class="recap-label">${label}</span><span class="recap-value">Œ£ ${sum}</span></div>`;
            }
        });
    }
    const recapSessionSummaryEl = getEl(instanceId, 'recap_sessionSummary');
    if (recapSessionSummaryEl) {
        recapSessionSummaryEl.innerHTML = sessionHtml || '<div class="recap-row-small"><span class="recap-label">Tidak ada data</span></div>';
    }

    setRecap('recap_avgValue', getEl(instanceId, 'avgValueDisplay'), false);
    const a1El = getEl(instanceId, 'allowance1');
    const a2El = getEl(instanceId, 'allowance2');
    const a1 = a1El ? (a1El.value || '0') : '0';
    const a2 = a2El ? (a2El.value || '0') : '0';
    const recapAllowanceEl = getEl(instanceId, 'recap_allowanceHitung');
    if (recapAllowanceEl) recapAllowanceEl.textContent = `${a1}% / ${a2}%`;
    
    setRecap('recap_kebutuhanBox', getEl(instanceId, 'kebutuhanBox'), false);
    
    const benurRealEl = getEl(instanceId, 'benurPerKantongReal');
    const recapBenurRealEl = getEl(instanceId, 'recap_benurReal');
    if (benurRealEl && recapBenurRealEl) {
        const span = benurRealEl.querySelector('span');
        if (span) {
            recapBenurRealEl.textContent = span.textContent.trim() + ' ekor/kantong';
        }
    }
    
    const sjRow = getEl(instanceId, 'benurPerKantongSJBox');
    const sjRowRecap = getEl(instanceId, 'recap_benurSJ_row');
    if (sjRow && sjRowRecap) {
        if (sjRow.style.display === 'block') {
            const benurSJEl = getEl(instanceId, 'benurPerKantongSJ');
            if (benurSJEl) {
                const span = benurSJEl.querySelector('span');
                if (span) {
                    getEl(instanceId, 'recap_benurSJ').textContent = span.textContent.trim() + ' ekor/kantong';
                }
            }
            sjRowRecap.style.display = 'flex';
        } else {
            sjRowRecap.style.display = 'none';
        }
    }

    const simRow = getEl(instanceId, 'simulasiBoxRow');
    const simRowRecap = getEl(instanceId, 'recap_simulasi_row');
    if (simRow && simRowRecap) {
        if (simRow.style.display === 'flex') {
            setRecap('recap_simulasi', getEl(instanceId, 'simulasiBoxReal'), false);
            simRowRecap.style.display = 'flex';
        } else {
            simRowRecap.style.display = 'none';
        }
    }
    timestampNow(instanceId, 'recapTimestamp');
    triggerAutoSave(instanceId);
}


// ===================================
// [REVISI V6.0] SAVE, LOAD, SHARE LOGIC
// ===================================
function gatherDataFromInstance(instanceId) {
    const dataToSave = {};
    dataToSave.customer = getEl(instanceId, 'customer').value;
    dataToSave.tujuan = getEl(instanceId, 'tujuan').value;
    dataToSave.line = getEl(instanceId, 'line').value;
    dataToSave.nominalOrder = getEl(instanceId, 'nominalOrder').value;
    dataToSave.jenisTruk = getEl(instanceId, 'jenisTruk').value;
    dataToSave.kapasitasAngkut = getEl(instanceId, 'kapasitasAngkut').value;
    dataToSave.driver = getEl(instanceId, 'driver').value;
    dataToSave.platNomor = getEl(instanceId, 'platNomor').value;
    dataToSave.nomorBak = getEl(instanceId, 'nomorBak').value;
    dataToSave.tomota = getEl(instanceId, 'tomota').value;
    dataToSave.allowanceTester = getEl(instanceId, 'allowanceTester').value;
    const testerGridEl = getEl(instanceId, 'hitGridTester');
    if (testerGridEl) {
        dataToSave.testerGrid = [...testerGridEl.querySelectorAll('input')].map(inp => inp.value);
    }
    dataToSave.qcSuhu = getEl(instanceId, 'qcSuhu').value;
    dataToSave.qcPh = getEl(instanceId, 'qcPh').value;
    dataToSave.qcDo = getEl(instanceId, 'qcDo').value;
    dataToSave.qcSalinitas = getEl(instanceId, 'qcSalinitas').value;
    dataToSave.qcJarak = getEl(instanceId, 'qcJarak').value;
    dataToSave.qcBiomassa = getEl(instanceId, 'qcBiomassa').value;
    dataToSave.qcPanjang = getEl(instanceId, 'qcPanjang').value;
    dataToSave.qcStadia = getEl(instanceId, 'qcStadia').value;
    dataToSave.qcScooping = getEl(instanceId, 'qcScooping').value;
    dataToSave.qcNoScooping = getEl(instanceId, 'qcNoScooping').value;
    dataToSave.qcBakAsli = getEl(instanceId, 'qcBakAsli').value;
    
    dataToSave.allowance1 = getEl(instanceId, 'allowance1').value;
    dataToSave.allowance2 = getEl(instanceId, 'allowance2').value;
    dataToSave.sessionsGrid = [];
    const multiSessionGridEl = getEl(instanceId, 'multiSessionGrid');
    if (multiSessionGridEl) {
        const sessions = multiSessionGridEl.querySelectorAll('.hit-session');
        sessions.forEach(session => {
            const sessionId = session.dataset.sessionId;
            const gridEl = document.getElementById(`${instanceId}_sessionGrid${sessionId}`);
            if (gridEl) {
                const inputs = [...gridEl.querySelectorAll('input')].map(inp => inp.value);
                dataToSave.sessionsGrid.push(inputs);
            }
        });
    }
    
    dataToSave.limitKapasitasToggle = getEl(instanceId, 'limitKapasitasToggle').checked;
    dataToSave.manualBenurToggle = getEl(instanceId, 'manualBenurToggle').checked;
    dataToSave.manualBenurOverride = getEl(instanceId, 'manualBenurOverride').value;
    dataToSave.simulasiToggle = getEl(instanceId, 'simulasiToggle').checked;

    dataToSave._vaultInfo = {
        uuid: `vault_${Date.now()}_${Math.floor(Math.random() * 1000)}`, 
        customer: dataToSave.customer || "Tanpa Nama",
        order: dataToSave.nominalOrder || "0",
        tanggal: dataToSave.line || new Date().toISOString().split('T')[0],
        savedOn: new Date().toISOString()
    };
    
    dataToSave._finalCalc = {};
    const benurRealEl = getEl(instanceId, 'benurPerKantongReal');
    if (benurRealEl) {
         const span = benurRealEl.querySelector('span');
         if (span) dataToSave._finalCalc.benurPerKantong = span.textContent.trim().replace(/\./g,'');
    }
    const kebutuhanBoxEl = getEl(instanceId, 'kebutuhanBox');
    if (kebutuhanBoxEl) {
        dataToSave._finalCalc.kebutuhanBox = kebutuhanBoxEl.textContent.split(' ')[0].replace(/\./g,'');
    }
    dataToSave._finalCalc.isiBox = getEl(instanceId, 'isiBox').value;
    const avgValueEl = getEl(instanceId, 'avgValueDisplay');
    if(avgValueEl) {
        dataToSave._finalCalc.avgAktual = avgValueEl.textContent.replace(' ekor', '').trim().replace(/\./g,'');
    }
    const testerDensityEl = getEl(instanceId, 'testerDensity');
    if (testerDensityEl) {
        dataToSave._finalCalc.testerDensity = testerDensityEl.textContent.trim().replace(/\./g,'');
    }
    
    return dataToSave;
}

function saveSessionData(instanceId, silent = false, status = 'Draft') {
    try {
        const dataToSave = gatherDataFromInstance(instanceId);
        delete dataToSave._vaultInfo;
        delete dataToSave._finalCalc;
        dataToSave._status = status;
        const storageKey = `${LOCAL_STORAGE_KEY}_${instanceId}`;
        localStorage.setItem(storageKey, JSON.stringify(dataToSave));
        if (!silent) {
            alert(`Sesi Data Panen ${instanceId} disimpan! ‚úÖ \n(Ini adalah auto-save, gunakan tombol 'Simpan ke Vault' untuk arsip permanen)`);
        }
    } catch (e) {
        console.error("Gagal menyimpan data sesi:", e);
        if (!silent) {
            alert(`Gagal menyimpan data Sesi Panen ${instanceId}.`);
        }
    }
}

function loadSessionData(instanceId, silent = false) {
    const storageKey = `${LOCAL_STORAGE_KEY}_${instanceId}`;
    const savedData = localStorage.getItem(storageKey);
    if (!savedData) {
        if (!silent) alert(`Tidak ada data sesi tersimpan untuk Panen ${instanceId}. üìÇ`);
        return false; 
    }
    try {
        const data = JSON.parse(savedData);
        loadDataFromObject(instanceId, data); 
        if (!silent) alert(`Data Sesi Panen ${instanceId} berhasil dimuat! ‚úÖ`);
        return true; 
    } catch (e) {
        console.error("Gagal memuat data sesi:", e);
        if (!silent) alert(`Gagal memuat data Sesi Panen ${instanceId}. Data tersimpan mungkin rusak.`);
        return false; 
    }
}

function formatWithDots(num) {
    if (typeof num !== 'number' || isNaN(num)) { num = 0; }
    return Math.round(num).toLocaleString('id-ID');
}
function reformatDate(dateString) {
    if (!dateString) return '-';
    try {
        const parts = dateString.split('-'); 
        if (parts.length !== 3) return dateString;
        return `${parts[2]}/${parts[1]}/${parts[0]}`; 
    } catch (e) { return dateString; }
}

function shareToCustomer(instanceId) {
    const customer = getEl(instanceId, 'customer').value || 'Customer';
    const tanggal = reformatDate(getEl(instanceId, 'line').value);
    const tujuan = getEl(instanceId, 'tujuan').value || 'Tujuan';
    const nomorBak = getEl(instanceId, 'nomorBak').value || '-';
    
    const driverName = getEl(instanceId, 'driver').value;
    const driverData = sopirDB[driverName] || { nohp: '-', plat: '-' };
    const driverHP = driverData.nohp;
    const driverPlat = getEl(instanceId, 'platNomor').value || driverData.plat; 

    const kebutuhanBoxEl = getEl(instanceId, 'kebutuhanBox');
    const isiBoxEl = getEl(instanceId, 'isiBox');
    const allowance2El = getEl(instanceId, 'allowance2');
    const benurRealEl = getEl(instanceId, 'benurPerKantongReal');
    const benurSJEl = getEl(instanceId, 'benurPerKantongSJ');

    if (!kebutuhanBoxEl || !isiBoxEl || !allowance2El || !benurRealEl || !benurSJEl) {
        alert("Error: Elemen hitungan tidak ditemukan. Tidak bisa membagikan data.");
        return;
    }

    const boxText = kebutuhanBoxEl.textContent.split(' ')[0];
    const kebutuhanBox = parseFloat(boxText.replace(/[\.,]/g, '')) || 0;
    const isiBox = parseFloat(isiBoxEl.value) || 0;
    const totalKantong = kebutuhanBox * isiBox;
    const a2 = parseFloat(allowance2El.value) || 0;
    
    const benurRealSpan = benurRealEl.querySelector('span');
    const benurSJSpan = benurSJEl.querySelector('span');
    if (!benurRealSpan || !benurSJSpan) { alert("Error: Elemen nilai <span> tidak ditemukan."); return; }
    
    const benurRealText = benurRealSpan.textContent.split(' ')[0];
    const benurReal_Value = parseFloat(benurRealText.replace(/[\.,]/g, '')) || 0;
    const benurSJText = benurSJSpan.textContent.split(' ')[0];
    const benurSJ_Value = parseFloat(benurSJText.replace(/[\.,]/g, '')) || 0;

    let text = "Assalamu'alaikum Wr. Wb.\n";
    text += "Berikut kami kirimkan rincian benur kepada:\n";
    text += `${customer}\n`;
    text += `(${tanggal}, ${tujuan})\n\n`;

    if (a2 > 0) {
        const bruto_SJ = totalKantong * benurSJ_Value; 
        const netto_SJ = Math.round(bruto_SJ * 0.9);
        const totalReal = totalKantong * benurReal_Value; 

        text += `${formatWithDots(kebutuhanBox)} Box, ${formatWithDots(totalKantong)} Kantong @${formatWithDots(benurSJ_Value)} Ekor\n`;
        text += `Bruto = ${formatWithDots(bruto_SJ)} (Bak ${nomorBak})\n`;
        text += `Netto = ${formatWithDots(netto_SJ)}\n\n`;
        text += `Hitungan Real:\n`;
        text += `${formatWithDots(kebutuhanBox)} Box, ${formatWithDots(totalKantong)} Kantong @${formatWithDots(benurReal_Value)} ekor = ${formatWithDots(totalReal)}\n\n`;
        
    } else {
        const bruto = totalKantong * benurReal_Value;
        const netto = Math.round(bruto * 0.9);
        text += `${formatWithDots(kebutuhanBox)} Box, ${formatWithDots(totalKantong)} Kantong @${formatWithDots(benurReal_Value)} Ekor\n`;
        text += `Bruto = ${formatWithDots(bruto)} (Bak ${nomorBak})\n`;
        text += `Netto = ${formatWithDots(netto)}\n\n`;
    }

    text += `Dengan Sopir Bp. ${driverName || '-'}\n`;
    text += `No. Hp = ${driverHP}\n`;
    text += `Plat Mobil = ${driverPlat}\n\n`;
    text += `Terimakasih, Sukses Bersama PLB ü§ù`;

    const encodedText = encodeURIComponent(text);
    window.open(`https://wa.me/?text=${encodedText}`, '_blank');
}

// ===================================
// [BARU] FUNGSI SHARE ADMIN DENGAN POP-UP
// ===================================
let currentShareInstanceId = null;

// 1. Fungsi Trigger saat tombol ditekan
function shareAdmin(instanceId) {
    currentShareInstanceId = instanceId;
    document.getElementById('shareOptionModal').style.display = 'flex';
}

// 2. Fungsi Tutup Modal
function closeShareModal() {
    document.getElementById('shareOptionModal').style.display = 'none';
    currentShareInstanceId = null;
}

// 3. Fungsi Konfirmasi Pilihan
function confirmShare(isComplete) {
    if (currentShareInstanceId) {
        executeShareAdmin(currentShareInstanceId, isComplete);
    }
    closeShareModal();
}

// 4. Eksekusi Pengiriman Pesan
function executeShareAdmin(instanceId, isComplete) {
    // Ambil Data QC & Tester
    const suhu = getEl(instanceId, 'qcSuhu').value || '-';
    const doVal = getEl(instanceId, 'qcDo').value || '-';
    const ph = getEl(instanceId, 'qcPh').value || '-';
    const sal = getEl(instanceId, 'qcSalinitas').value || '-';
    const biomassa = getEl(instanceId, 'qcBiomassa').value || '-';
    const tomota = getEl(instanceId, 'tomota').value || '-';
    const bakAsli = getEl(instanceId, 'qcBakAsli').value || '-'; 
    const stadia = getEl(instanceId, 'qcStadia').value || '-';
    const panjang = getEl(instanceId, 'qcPanjang').value || '-';
    const scooping = getEl(instanceId, 'qcScooping').value || '-';
    const noScooping = getEl(instanceId, 'qcNoScooping').value || '-';
    const customer = getEl(instanceId, 'customer').value || '-';
    const driver = getEl(instanceId, 'driver').value || '-';
    const tujuan = getEl(instanceId, 'tujuan').value || '-';
    const avgAktualEl = getEl(instanceId, 'avgValueDisplay');
    const kebutuhanBoxEl = getEl(instanceId, 'kebutuhanBox');
    const isiBoxEl = getEl(instanceId, 'isiBox');
    const benurRealEl = getEl(instanceId, 'benurPerKantongReal');
    const benurSJEl = getEl(instanceId, 'benurPerKantongSJ');
    const allowance2El = getEl(instanceId, 'allowance2');

    if (!avgAktualEl || !kebutuhanBoxEl || !isiBoxEl || !benurRealEl || !benurSJEl || !allowance2El) {
        alert("Error: Elemen hitungan tidak ditemukan.");
        return;
    }

    const avgAktualText = avgAktualEl.textContent.replace(' ekor', '').trim();
    const boxText = kebutuhanBoxEl.textContent;
    const boxNumberString = boxText.split(' Box')[0];
    const boxValue = parseFloat(boxNumberString.replace(/\./g, '')) || 0;
    const isiBox = parseFloat(isiBoxEl.value) || 0;
    const totalKantong = (boxValue * isiBox).toLocaleString('id-ID');
    
    const benurRealSpan = benurRealEl.querySelector('span');
    const benurSJSpan = benurSJEl.querySelector('span');
    
    if (!benurRealSpan || !benurSJSpan) { alert("Error: Elemen nilai span tidak ditemukan."); return; }
    
    const benurReal = benurRealSpan.textContent.trim();
    const benurSJ = benurSJSpan.textContent.trim();
    const a2 = parseFloat(allowance2El.value) || 0;

    // --- LOGIKA PENYUSUNAN TEKS ---
    let text = "";

    // Bagian Hitungan (Sama untuk kedua format)
    let hitunganText = "";
    const lineRealSimple = `${boxValue} Box, ${totalKantong} Kantong @${benurReal} Ekor (+1)`;
    
    if (a2 > 0) {
        // Jika ada A2 -> Tampilkan Real dan SJ
        hitunganText += `Real: ${lineRealSimple}\n`;
        hitunganText += `SJ:   ${boxValue} Box, ${totalKantong} Kantong @${benurSJ} Ekor (+1)`;
    } else {
        // Jika tidak ada A2 -> Tampilkan Real saja (tanpa label "Real:")
        hitunganText += lineRealSimple;
    }

    if (isComplete) {
        // --- FORMAT LENGKAP (YA) ---
        text += `${scooping}/${noScooping}\n\n`;
        text += `Suhu ${suhu}\n`;
        text += `Do ${doVal}\n`;
        text += `Ph ${ph}\n`;
        text += `Sal ${sal}\n\n`;
        text += `Biomassa ${biomassa}\n`;
        text += `Tomota ${tomota}\n`;
        text += `Kode Bak ${bakAsli} (${stadia})\n`;
        text += `Panjang ${panjang} mm\n\n`;
        text += `${customer}/${tujuan}\n`;
        text += `${driver}/Act ${avgAktualText}\n\n`;
        text += hitunganText;

    } else {
        // --- FORMAT RINGKAS (TIDAK) ---
        // Contoh: 
        // Heri/5.5
        // Bak Asli 4
        // 
        // CV Sudana/Lombok
        // Didi/Act 3.804
        //
        // [Hitungan]

        text += `${scooping}/${noScooping}\n`;
        text += `Bak Asli ${bakAsli}\n\n`;
        
        text += `${customer}/${tujuan}\n`;
        text += `${driver}/Act ${avgAktualText}\n\n`;
        
        text += hitunganText;
    }

    const encodedText = encodeURIComponent(text);
    window.open(`https://wa.me/?text=${encodedText}`, '_blank');
}


// ===================================
// IMPORT/EXPORT JSON LOGIC
// ===================================
function markStatus(instanceID, status) {
  const slideItem = document.getElementById(instanceID);
  if (!slideItem) return;
  const badge = document.getElementById(`${instanceID}_statusBadge`);
  if (!badge) { return; }
  
  slideItem.dataset.status = status;
  badge.textContent = status;
  badge.classList.remove('status-draft', 'status-terkirim', 'status-edited');
  
  if (status === 'Terkirim') {
      badge.style.background = 'var(--color-text-sum)'; 
      badge.style.color = '#FFFFFF';
      badge.classList.add('status-terkirim');
  } else if (status === 'Edited') {
      badge.style.background = 'var(--color-alert-text)'; 
      badge.style.color = '#FFFFFF';
      badge.classList.add('status-edited');
  } else { 
      badge.style.background = '#FFC107'; 
      badge.style.color = '#212529';
      badge.classList.add('status-draft');
  }
  badge.classList.add('visible');
}

function loadDataFromObject(instanceId, data) {
    try {
        getEl(instanceId, 'customer').value = data.customer || '';
        getEl(instanceId, 'tujuan').value = data.tujuan || '';
        getEl(instanceId, 'line').value = data.line || '';
        getEl(instanceId, 'nominalOrder').value = data.nominalOrder || '0';
        getEl(instanceId, 'jenisTruk').value = data.jenisTruk || 'Euro2';
        getEl(instanceId, 'kapasitasAngkut').value = data.kapasitasAngkut || '';
        getEl(instanceId, 'driver').value = data.driver || ''; 
        getEl(instanceId, 'platNomor').value = data.platNomor || '';
        getEl(instanceId, 'nomorBak').value = data.nomorBak || '';
        getEl(instanceId, 'tomota').value = data.tomota || '';
        getEl(instanceId, 'allowanceTester').value = data.allowanceTester || '0';
        
        getEl(instanceId, 'qcSuhu').value = data.qcSuhu || '';
        getEl(instanceId, 'qcPh').value = data.qcPh || '';
        getEl(instanceId, 'qcDo').value = data.qcDo || '';
        getEl(instanceId, 'qcSalinitas').value = data.qcSalinitas || '';
        getEl(instanceId, 'qcJarak').value = data.qcJarak || '';
        getEl(instanceId, 'qcBiomassa').value = data.qcBiomassa || '';
        getEl(instanceId, 'qcPanjang').value = data.qcPanjang || '';
        getEl(instanceId, 'qcStadia').value = data.qcStadia || '';
        getEl(instanceId, 'qcScooping').value = data.qcScooping || '';
        getEl(instanceId, 'qcNoScooping').value = data.qcNoScooping || '';
        getEl(instanceId, 'qcBakAsli').value = data.qcBakAsli || '';
        
        const testerGridEl = getEl(instanceId, 'hitGridTester');
        if (testerGridEl && data.testerGrid) {
            testerGridEl.innerHTML = ''; 
            data.testerGrid.forEach(val => {
                const box = document.createElement('div');
                box.className = 'calc-box';
                const input = document.createElement('input');
                input.type = 'number';
                input.placeholder = '0';
                input.value = val || '';
                input.oninput = () => recalcAllTester(instanceId);
                box.appendChild(input);
                testerGridEl.appendChild(box);
            });
            const diff = 8 - data.testerGrid.length;
            if (diff > 0) {
                for (let i = 0; i < diff; i++) { addCalcBox(`${instanceId}_hitGridTester`); }
            }
        }

        getEl(instanceId, 'allowance1').value = data.allowance1 || '0';
        getEl(instanceId, 'allowance2').value = data.allowance2 || '0'; 

        const multiSessionGridEl = getEl(instanceId, 'multiSessionGrid');
        if (multiSessionGridEl) {
            multiSessionGridEl.innerHTML = ''; 
            sessionCounter[instanceId] = 0; 
            
            if (data.sessionsGrid && data.sessionsGrid.length > 0) {
                data.sessionsGrid.forEach(sessionData => {
                    sessionCounter[instanceId]++;
                    const sessionId = sessionCounter[instanceId];
                    const newSession = document.createElement('div');
                    newSession.className = 'hit-session';
                    newSession.dataset.sessionId = sessionId;
                    newSession.innerHTML = `
                        <div class="session-summary">
                            <span class="session-label">Hitungan ${sessionId}:</span>
                            <span class="results">
                                Œ£ <span id="${instanceId}_sessionSum${sessionId}" class="sum-value">0</span>
                                <button class="btn-reset-row" onclick="resetSessionRow(event, '${instanceId}', ${sessionId})" title="Reset Baris Ini">üîÑ</button>
                            </span>
                        </div>
                        <div id="${instanceId}_sessionGrid${sessionId}" class="hit-grid"></div>
                    `;
                    multiSessionGridEl.appendChild(newSession);
                    
                    const grid = document.getElementById(`${instanceId}_sessionGrid${sessionId}`);
                    if (grid && sessionData) {
                         sessionData.forEach(val => {
                            const box = document.createElement('div');
                            box.className = 'calc-box';
                            const input = document.createElement('input');
                            input.type = 'number';
                            input.placeholder = '0';
                            input.value = val || '';
                            input.oninput = function() { recalcSession(instanceId, sessionId); recalcAllHitungan(instanceId); };
                            box.appendChild(input);
                            grid.appendChild(box);
                        });
                        const diff = 8 - sessionData.length;
                        if (diff > 0) {
                            for (let i = 0; i < diff; i++) {
                                const box = document.createElement('div');
                                box.className = 'calc-box';
                                const input = document.createElement('input');
                                input.type = 'number';
                                input.placeholder = '0';
                                input.oninput = function() { recalcSession(instanceId, sessionId); recalcAllHitungan(instanceId); };
                                box.appendChild(input);
                                grid.appendChild(box);
                            }
                        }
                    }
                });
            } else {
                addHitunganSession(instanceId);
                addHitunganSession(instanceId);
            }
        }
        
        const limitToggle = getEl(instanceId, 'limitKapasitasToggle');
        if (limitToggle) limitToggle.checked = data.limitKapasitasToggle !== undefined ? data.limitKapasitasToggle : true; 
        const manualToggle = getEl(instanceId, 'manualBenurToggle');
        if (manualToggle) manualToggle.checked = data.manualBenurToggle || false;
        const manualInput = getEl(instanceId, 'manualBenurOverride');
        if (manualInput) manualInput.value = data.manualBenurOverride || '';
        const simulasiToggle = getEl(instanceId, 'simulasiToggle');
        if (simulasiToggle) simulasiToggle.checked = data.simulasiToggle || false;
        
        toggleManualBenurInput(instanceId);

        updateTruckDetails(instanceId);
        recalcAllTester(instanceId);
        recalcAllHitungan(instanceId);
        formatCurrency(getEl(instanceId, 'nominalOrder'));
        updateRecap(instanceId);
        
        let currentStatus = data._status || 'Draft'; 
        if (data._vaultInfo) { currentStatus = data._status || 'Terkirim'; }
        if (currentStatus === 'Final') { currentStatus = 'Terkirim'; }
        markStatus(instanceId, currentStatus); 
        
    } catch (e) { console.error(`Gagal memuat data ke ${instanceId}:`, e); }
}

// ===================================
// FLOATING CALCULATOR LOGIC
// ===================================
const calcContainer = document.getElementById('calculatorContainer');
const calcDisplay = document.getElementById('calcDisplay');
let currentInput = '0';
let previousValue = null;
let operator = null;
let waitingForNewInput = true;
function toggleCalculator() { calcContainer.classList.toggle('visible'); }
function calcClear() {
    currentInput = '0'; previousValue = null; operator = null; waitingForNewInput = true;
    updateCalcDisplay();
}
function updateCalcDisplay() {
    let displayValue = currentInput.includes('.') ? currentInput : parseFloat(currentInput).toLocaleString('id-ID', {maximumFractionDigits: 10});
    if (displayValue === 'NaN' || displayValue === 'Infinity' || !isFinite(currentInput)) {
         calcDisplay.value = 'Error';
    }
    else { calcDisplay.value = displayValue; }
}
function calcInput(value) {
    if (calcDisplay.value === 'Error') return;
    if (waitingForNewInput) {
        if (value === '.') { currentInput = '0.'; }
        else { currentInput = value; }
        waitingForNewInput = false;
    } else {
        if (value === '0' && currentInput === '0') return;
        if (value === '.' && currentInput.includes('.')) return;
        if (currentInput.length >= 15) return;
        if (currentInput === '0' && value !== '.') { currentInput = value; }
        else { currentInput += value; }
    }
    updateCalcDisplay();
}
function calcBackspace() {
    if (calcDisplay.value === 'Error') return;
    if (waitingForNewInput) return;
    if (currentInput.length > 1) {
        currentInput = currentInput.slice(0, -1);
    } else {
        currentInput = '0';
        waitingForNewInput = true;
    }
    updateCalcDisplay();
}
function calcPercent() {
    if (calcDisplay.value === 'Error') return;
    let currentValue = parseFloat(currentInput);
    if (previousValue !== null && operator !== null) {
        currentValue = (parseFloat(previousValue) / 100) * currentValue;
    } else {
        currentValue = currentValue / 100;
    }
    currentInput = currentValue.toString();
    updateCalcDisplay();
    waitingForNewInput = true;
}
function performCalculation(prev, current, op) {
    const prevNum = parseFloat(prev);
    const currNum = parseFloat(current);
    if (op === '/' && currNum === 0) return 'Error';
    let result;
    if (op === '+') result = (prevNum + currNum);
    else if (op === '-') result = (prevNum - currNum);
    else if (op === '*') result = (prevNum * currNum);
    else if (op === '/') result = (prevNum / currNum);
    else result = currNum;
    if (!isFinite(result)) return 'Error';
    result = parseFloat(result.toPrecision(15));
    return result.toString();
}
function calcOperator(nextOperator) {
     if (calcDisplay.value === 'Error') return;
    const inputValue = parseFloat(currentInput);
    if (operator && waitingForNewInput) {
        operator = nextOperator;
        return;
    }
    if (previousValue === null) {
        previousValue = inputValue;
    } else if (!waitingForNewInput) {
        const result = performCalculation(previousValue, currentInput, operator);
         if (result === 'Error') {
             currentInput = 'Error';
             updateCalcDisplay();
             previousValue = null;
             operator = null;
             waitingForNewInput = true;
             currentInput = '0';
             return;
         }
        currentInput = result;
        previousValue = parseFloat(result);
	updateCalcDisplay();
    }
    waitingForNewInput = true;
    operator = nextOperator;
}
function calcEquals() {
     if (calcDisplay.value === 'Error' || previousValue === null || operator === null) return;
    const result = performCalculation(previousValue, currentInput, operator);
     if (result === 'Error') {
         currentInput = 'Error';
         updateCalcDisplay();
         previousValue = null;
         operator = null;
         waitingForNewInput = true;
         currentInput = '0';
     } else {
         currentInput = result;
         updateCalcDisplay();
         previousValue = null;
         operator = null;
         waitingForNewInput = true;
     }
}

// ===================================
// [REVISI V6.8] FUNGSI VAULT (BRANKAS DATA)
// ===================================

function getVaultData() {
    const vaultRaw = localStorage.getItem(VAULT_STORAGE_KEY);
    if (!vaultRaw) { return []; }
    try {
        const data = JSON.parse(vaultRaw);
        return data.sort((a, b) => new Date(b._vaultInfo.savedOn) - new Date(a._vaultInfo.savedOn));
    } catch (e) {
        console.error("Data vault rusak:", e);
        return [];
    }
}

function saveVaultData(vaultArray) {
    try {
        localStorage.setItem(VAULT_STORAGE_KEY, JSON.stringify(vaultArray));
    } catch (e) {
        console.error("Gagal menyimpan vault:", e);
        alert("Error saat menyimpan vault.");
    }
}

function saveDataToVault(instanceId) {
    if (!confirm("Simpan data panen ini ke Vault? \n\nData ini akan ditandai sebagai 'Terkirim'.")) return;
    
    clearTimeout(autoSaveTimeout); 
    clearTimeout(statusLockTimeout); 

    try {
        const newData = gatherDataFromInstance(instanceId);
        let vaultArray = getVaultData();
        
        vaultArray.push(newData);
        saveVaultData(vaultArray);
        
        alert("Data Panen berhasil disimpan ke Vault! üóÑÔ∏è");
        populateVaultList(); 
        
        markStatus(instanceId, 'Terkirim'); 
        saveSessionData(instanceId, true, 'Terkirim'); 
        
        statusLockTimeout = setTimeout(() => {
            statusLockTimeout = null; 
        }, 3000); 
        
    } catch (e) {
        console.error("Gagal menyimpan ke Vault:", e);
        alert("Gagal menyimpan data ke Vault. Error: " + e.message);
    }
}

function populateVaultList() {
    const vaultArray = getVaultData();
    const listEl = document.getElementById('vaultList');
    
    if (!listEl) return;
    listEl.innerHTML = ''; 
    
    const now = new Date();
    const twelveHoursAgo = new Date(now.getTime() - (12 * 60 * 60 * 1000));

    if (vaultArray.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--color-text-light);">Vault data kosong.</p>';
    } else {
        vaultArray.forEach((item) => { 
            const info = item._vaultInfo;
            if (!info) return; 
            
            const customerName = info.customer || 'Tanpa Nama';
            const order = parseFloat(info.order.replace(/\./g,'') || 0).toLocaleString('id-ID');
            const date = reformatDate(info.tanggal);
            
            const savedDate = new Date(info.savedOn);
            const isNew = savedDate > twelveHoursAgo;
            const newBadgeHTML = isNew ? '<span class="vault-new-badge">NEW!</span>' : '';
            const uuid = info.uuid;

            const itemEl = document.createElement('div');
            itemEl.className = 'vault-list-item';
            itemEl.innerHTML = `
                <div class="vault-item-info">
                    <div class="vault-item-info-main">
                        ${customerName}
                        ${newBadgeHTML}
                    </div>
                    <div class="vault-item-info-sub">
                        <span>üìÖ ${date}</span>
                        <span>|</span>
                        <span>üéØ ${order} ekor</span>
                    </div>
                </div>
                <div class="vault-item-actions">
                    <button class="btn restore" title="Muat Ulang data ini ke slide baru">üîÑ Muat Ulang</button>
                    <button class="btn delete" title="Hapus permanen data ini">‚ùå Hapus</button>
                </div>
            `;
            
            itemEl.querySelector('.delete').onclick = () => deleteFromVault(uuid, itemEl);
            itemEl.querySelector('.restore').onclick = () => loadFromVault(item); 
            listEl.appendChild(itemEl);
        });
    }
}

function toggleVault() {
    const overlay = document.getElementById('vaultOverlay');
    const container = document.getElementById('vaultContainer');
    
    if (container.classList.contains('visible')) {
        overlay.style.opacity = 0;
        container.classList.add('is-hiding');
        setTimeout(() => {
            overlay.classList.remove('visible');
            container.classList.remove('visible');
            container.classList.remove('is-hiding');
        }, 300); 
    } else {
        populateVaultList(); 
        overlay.classList.add('visible');
        container.classList.add('visible');
    }
}

function loadFromVault(restoredData) {
    if (!confirm("Muat Ulang data ini? \n\nData akan dimuat di slide baru paling akhir. Ini tidak akan mengubah data di Vault.")) return;
    addInstance(restoredData); 
    goToSlide(slideTrack.children.length - 1); 
    toggleVault(); 
    alert("Data berhasil dimuat ulang! \nSlide baru ini ditandai sebagai 'Terkirim' dan dapat diedit.");
}

function deleteFromVault(uuidToDelete, itemElement) {
    if (!uuidToDelete) {
        alert("Gagal menghapus: Data ini tidak memiliki ID unik. (Data lama?)");
        return;
    }
    if (!confirm("Yakin ingin MENGHAPUS PERMANEN data ini dari Vault? Tindakan ini tidak dapat dibatalkan.")) return;
    itemElement.classList.add('is-deleting');
    setTimeout(() => {
        let vaultArray = getVaultData();
        const newVaultArray = vaultArray.filter(item => item._vaultInfo.uuid !== uuidToDelete);
        if (newVaultArray.length < vaultArray.length) {
            saveVaultData(newVaultArray); 
        } else {
            console.warn(`Gagal menghapus: UUID ${uuidToDelete} tidak ditemukan di vault.`);
        }
        populateVaultList(); 
    }, 400); 
}


function exportVaultToExcel(buttonElement) {
    const originalText = buttonElement.innerHTML;
    buttonElement.innerHTML = "‚è≥ Exporting...";
    buttonElement.disabled = true;

    setTimeout(() => {
        try {
            if (!confirm("Ekspor semua data di Vault ke file Excel?")) {
                buttonElement.innerHTML = originalText;
                buttonElement.disabled = false;
                return;
            }

            const vaultData = getVaultData();
            if (vaultData.length === 0) {
                alert("Vault kosong. Tidak ada data untuk diekspor.");
                buttonElement.innerHTML = originalText;
                buttonElement.disabled = false;
                return;
            }

            const dataToExport = [];
            
            dataToExport.push([
                "Tanggal", "Nama Customer", "Bak Scooring", "Bak Asli", 
                "Jumlah Kantong", "Benur Per Kantong", "Rata-Rata (Aktual)", "Tomota", 
                "Density (Tester)", "Total Benur", "Panjang (mm)", "Suhu (¬∞C)", 
                "Jarak Tempuh (Jam)", "Stadia", "No. Scooping", "Scooping",
                "Tujuan", "Jenis Truk", "Driver", "Plat Nomor", "DO (ppm)", "pH", "Salinitas (ppt)", "Biomassa (gr)"
            ]);

            vaultData.forEach(item => {
                try {
                    const calc = item._finalCalc || {};
                    const kebutuhanBox = safeParseFloat(calc.kebutuhanBox);
                    const isiBox = safeParseFloat(calc.isiBox);
                    const benurPerKantong = safeParseFloat(calc.benurPerKantong);
                    const jumlahKantong = kebutuhanBox * isiBox;
                    const totalBenur = jumlahKantong * benurPerKantong;
                    const densityTester = calc.testerDensity || '-';

                    dataToExport.push([
                        reformatDate(item.line),
                        item.customer || '-',
                        item.nomorBak || '-',
                        item.qcBakAsli || '-', 
                        jumlahKantong,
                        benurPerKantong,
                        safeParseFloat(calc.avgAktual),
                        safeParseFloat(item.tomota),
                        safeParseFloat(densityTester), 
                        totalBenur,
                        safeParseFloat(item.qcPanjang),
                        safeParseFloat(item.qcSuhu),
                        safeParseFloat(item.qcJarak),
                        item.qcStadia || '-',
                        item.qcNoScooping || '-',
                        item.qcScooping || '-',
                        item.tujuan || '-',
                        item.jenisTruk || '-',
                        item.driver || '-',
                        item.platNomor || '-',
                        safeParseFloat(item.qcDo),
                        safeParseFloat(item.qcPh),
                        safeParseFloat(item.qcSalinitas),
                        safeParseFloat(item.qcBiomassa)
                    ]);
                } catch (e) {
                    console.error("Gagal memproses item untuk Excel:", item, e);
                }
            });

            const ws = XLSX.utils.aoa_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data Panen Vault");

            const date = new Date();
            const y = date.getFullYear();
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const d = date.getDate().toString().padStart(2, '0');
            const fileName = `PLBShrimpCount_Vault_${y}${m}${d}.xlsx`;
            
            XLSX.writeFile(wb, fileName);

        } catch(e) {
            alert("Gagal membuat file Excel. Error: " + e.message);
        } finally {
            buttonElement.innerHTML = originalText;
            buttonElement.disabled = false;
        }
    }, 100); 
}

// ===================================
// INITIALIZATION
// ===================================

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('darkModeToggle').onclick = toggleDarkMode;
    document.getElementById('floatingVaultBtn').onclick = toggleVault;
    document.getElementById('floatingPrevBtn').onclick = () => goToSlide(activeInstanceIndex - 1);
    document.getElementById('floatingNextBtn').onclick = () => goToSlide(activeInstanceIndex + 1);

    checkDarkModePreference();

    let keysToLoad = [];
    try {
        const allKeys = Object.keys(localStorage);
        keysToLoad = allKeys.filter(key => 
            key.startsWith(LOCAL_STORAGE_KEY) && key.includes('_instance_')
        );
    } catch (e) {
        console.warn("Gagal mengakses localStorage untuk load data sesi:", e);
    }

    if (keysToLoad.length === 0) {
        addInstance(); 
    } 
    else {
        keysToLoad.sort().forEach(key => {
            const instanceId = key.substring(LOCAL_STORAGE_KEY.length + 1); 
            const savedData = localStorage.getItem(key);
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    addInstance(data, instanceId); 
                } catch (e) {
                    console.warn(`Gagal memuat sesi data untuk ${instanceId}:`, e);
                    addInstance(null, instanceId); 
                }
            }
        });
    }
    
    goToSlide(0); 
    calcClear();
    
    const observer = new MutationObserver(() => {
      if (document.body.classList.contains("dark-mode")) {
        document.documentElement.style.setProperty("--color-text-main", "#E2ECF5");
        document.documentElement.style.setProperty("--color-text-light", "#A8B6C9");
      } else {
        document.documentElement.style.removeProperty("--color-text-main");
        document.documentElement.style.removeProperty("--color-text-light");
      }
    });
    observer.observe(document.body, { attributes: true, attributeFilter: ["class"] });
    if (document.body.classList.contains("dark-mode")) {
        document.documentElement.style.setProperty("--color-text-main", "#E2ECF5");
        document.documentElement.style.setProperty("--color-text-light", "#A8B6C9");
    }
    
    let tabStartX = 0;
    document.addEventListener("touchstart", e => {
        if (e.target.closest('.card-tab-content') || e.target.closest('.card-tab-nav')) {
            tabStartX = e.touches[0].clientX;
        } else {
            tabStartX = 0;
        }
    }, { passive: true });
    document.addEventListener("touchend", e => {
      if (tabStartX === 0) return; 
      const tabEndX = e.changedTouches[0].clientX;
      const delta = tabEndX - tabStartX;
      
      if (Math.abs(delta) > 70) { 
        const activeSlide = slideTrack.children[activeInstanceIndex];
        if (!activeSlide) return;
        
        const activeTab = activeSlide.querySelector(".tab-link.active");
        if (!activeTab) return;
        
        const tabs = Array.from(activeTab.parentNode.querySelectorAll(".tab-link"));
        let idx = tabs.indexOf(activeTab);
        
        if (delta < 0 && idx < tabs.length - 1) { 
            tabs[idx + 1].click();
        }
        if (delta > 0 && idx > 0) { 
            tabs[idx - 1].click();
        }
      }
      tabStartX = 0; 
    });
    
    document.addEventListener("input", (e) => {
      const el = e.target;
      if (el.type === "number") {
        const val = parseFloat(el.value);
        if (val < 0) el.value = 0; 
        const max = el.getAttribute('max');
        if (max && val > parseFloat(max)) {
             el.value = max; 
        } else if (!max && val > 9999999) {
             el.value = 9999999; 
        }
      }
    });
    
    const tooltips = [
        { sel: "#darkModeToggle", text: "Ganti Tema Terang/Gelap üåô" },
        { sel: "#vaultToggleBtn", text: "Buka Brankas Data Panen üóÑÔ∏è" },
        { sel: ".calc-toggle-btn", text: "Buka Kalkulator üßÆ" },
        { sel: ".add-btn", text: "Tambah Data Baru ‚ûï" },
        { sel: ".remove-btn", text: "Hapus Data Ini ‚ùå" },
        { sel: ".reset-btn", text: "Reset Form Ini üîÑ" }
    ];
    tooltips.forEach(t => {
        document.querySelectorAll(t.sel).forEach(btn => {
          if (!btn.title) btn.title = t.text;
        });
    });

});
</script>

<style>
/* Transisi lembut untuk badge status */
.status-badge {
  transition: background-color 0.4s ease, color 0.4s ease, transform 0.3s ease;
}

/* Efek kecil saat berubah status */
.status-badge.status-changed {
  transform: scale(1.1);
  box-shadow: 0 0 8px rgba(0,0,0,0.2);
}

/* Panah mengikuti warna background */
.status-badge::after {
  border-bottom-color: var(--after-color, transparent) !important;
  transition: border-bottom-color 0.4s ease;
}
</style>

<script>
(function(){
  const STATUS_COLORS = {
    Draft:   { bg: '#FFA500', text: '#ffffff' }, 
    Terkirim:{ bg: '#198754', text: '#ffffff' }, 
    Edited:  { bg: '#0DCAF0', text: '#212529' } 
  };

  function setStatusBadge(badgeEl, status) {
    if (!badgeEl) return;
    const col = STATUS_COLORS[status] || STATUS_COLORS.Draft;
    badgeEl.classList.add('status-changed');
    setTimeout(() => badgeEl.classList.remove('status-changed'), 250);

    badgeEl.textContent = status;
    badgeEl.classList.add('visible');
    badgeEl.style.background = col.bg;
    badgeEl.style.color = col.text;
    badgeEl.style.setProperty('--after-color', col.bg);
  }

  function findBadgeFromInside(el) {
    const slide = el.closest('.slide-item');
    return slide ? slide.querySelector('.status-badge') : null;
  }

  function initializeExistingBadges() {
    document.querySelectorAll('.status-badge').forEach(b => {
      setStatusBadge(b, 'Draft');
      b.dataset.hasSaved = "false";
    });
  }

  function attachInputListeners(root) {
    if (!root) root = document;
    root.addEventListener('input', function(e){
      const target = e.target;
      if (!target) return;
      const tag = (target.tagName || '').toLowerCase();
      if (!['input','select','textarea'].includes(tag)) return;

      const badge = findBadgeFromInside(target);
      if (!badge) return;
      const hasSaved = badge.dataset.hasSaved === "true";
      const current = (badge.textContent || '').trim();

      if (!hasSaved) {
        if (current !== 'Draft') setStatusBadge(badge, 'Draft');
      } else {
        if (current !== 'Edited') setStatusBadge(badge, 'Edited');
      }
    }, { capture: true });
  }

  function attachSaveClickListener() {
    document.addEventListener('click', function(e){
      const btn = e.target.closest('button, a, input[type="button"], input[type="submit"]');
      if (!btn) return;
      const txt = (btn.innerText || btn.value || '').toLowerCase();
      const isSaveBtn = /save|simpan|vault|terkirim|kirim/.test(txt) ||
                        (btn.className && /save|vault|simpan/.test(btn.className));
      if (!isSaveBtn) return;

      const badge = findBadgeFromInside(btn);
      if (!badge) return;
      setStatusBadge(badge, 'Terkirim');
      badge.dataset.hasSaved = "true";
    }, true);
  }

  function observeNewBadges() {
    const mo = new MutationObserver(muts => {
      muts.forEach(m => {
        m.addedNodes.forEach(node => {
          if (!(node instanceof Element)) return;
          const badges = node.matches('.status-badge')
            ? [node]
            : Array.from(node.querySelectorAll('.status-badge'));
          badges.forEach(b => {
            setStatusBadge(b, 'Draft');
            b.dataset.hasSaved = "false";
          });
        });
      });
    });
    mo.observe(document.body, { childList: true, subtree: true });
  }

  initializeExistingBadges();
  attachInputListeners(document);
  attachSaveClickListener();
  observeNewBadges();

  window.PLB = window.PLB || {};
  window.PLB.setStatusBadge = (inst, status)=>{
    const badge = typeof inst === 'string' ? document.getElementById(inst) : findBadgeFromInside(inst);
    if (badge) setStatusBadge(badge, status);
  };
})();
</script>
</body>

</html>
