<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PLB ShrimpCount</title>

<link rel="icon" type="image/jpeg" href="logo-plb.png">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;700&display=swap" rel="stylesheet">
<style>
/* --- [REVISI] VARIABEL AKAR & STANDAR (TEMA BIRU MODERN) --- */
:root {
  /* Palet Aksen Biru */
  --color-accent: #0D69C2; /* Biru PLB yang lebih kuat */
  --color-accent-light: #E7F0F8; /* Latar belakang/hover biru sangat muda */
  --color-accent-text: #FFFFFF; /* Teks di atas aksen (putih) */
  
  /* Palet UI Utama (Light) */
  --color-bg: #F4F7FA; /* Latar belakang body (putih kebiruan) */
  --color-card-bg: #FFFFFF; /* Latar kartu (putih bersih) */
  --color-tab-nav-bg: #EAF0F6; /* Latar navigasi tab */
  
  /* Palet Header */
  --color-header-bg: #0D69C2; /* Header biru solid */
  --color-header-text: #FFFFFF;
  --color-header-btn-bg: #0A5499; /* Tombol di header (lebih gelap) */
  --color-header-btn-text: #FFFFFF;
  
  /* Palet Teks */
  --color-text-main: #212529; /* Teks utama (hitam pekat) */
  --color-text-light: #5A6A7B; /* Teks sekunder (abu-abu kebiruan) */
  --color-text-lighter: #8A9BAB; /* Teks (mis. timestamp) */
  
  /* Palet Umum */
  --color-border: #DDE4EE; /* Border umum & input */
  --color-input-bg: #FFFFFF;
  --color-shadow: rgba(13, 105, 194, 0.1); /* Bayangan berbasis biru */
  --color-shadow-dark: rgba(13, 105, 194, 0.15);

  /* Palet Semantik (Peringatan, Sukses) */
  --color-text-sum: #198754; /* Hijau untuk sukses/total */
  --color-alert-text: #E65200; /* Oranye untuk peringatan */
  --color-delete-text: #DC3545;
  --color-tester-result-bg: #E8F5E9; /* Latar hijau muda */
  --color-tester-result-text: #1E6A21;
  --color-card-hitung-border: #c8e6c9;

  /* Metrik Desain */
  --font-main:'Poppins',sans-serif;
  --font-weight-thin:300;
  --radius-card: 12px;
  --radius-input: 8px;
  --shadow-card: 0 4px 12px var(--color-shadow);
  
  /* Variabel lama (disesuaikan atau tidak terpakai) */
  --color-header-bg1: var(--color-header-bg); /* Disesuaikan */
  --color-header-bg2: var(--color-header-bg); /* Disesuaikan */
  --color-card-tester: var(--color-accent-light); /* Disesuaikan */
  --color-card-hitung: var(--color-accent-light); /* Disesuaikan */
  --color-text-sj: var(--color-accent); /* Disesuaikan */
  --color-calc-bg: #4a4a4a;
  --color-calc-display: #e8f5f9;
  --color-calc-operator: #ff9500;
  --color-card-recap: #FAFCFE;
  --color-recap-label: var(--color-text-light);
  --color-recap-value: var(--color-text-main);
  --color-recap-border: var(--color-border);
  --color-card-tester-border: var(--color-border);
}

/* === [REVISI] Mode Gelap (TEMA BIRU MODERN) === */
body.dark-mode {
  /* Palet Aksen Biru (Dark) */
  --color-accent: #58A6FF; /* Biru muda yang cerah */
  --color-accent-light: #2A3B50; /* Latar biru tua */
  --color-accent-text: #FFFFFF; /* Teks di atas aksen (putih) */

  /* Palet UI Utama (Dark) */
  --color-bg: #0F172A; /* Latar body (biru sangat tua) */
  --color-card-bg: #1E293B; /* Latar kartu (biru tua) */
  --color-tab-nav-bg: #0F172A; /* Latar nav tab (sama dgn body) */
  
  /* Palet Header (Dark) */
  --color-header-bg: #1E293B; /* Header (sama dgn kartu) */
  --color-header-text: #F1F5F9;
  --color-header-btn-bg: #334155; /* Tombol di header (lebih cerah) */
  --color-header-btn-text: #F1F5F9;
  
  /* Palet Teks (Dark) */
  --color-text-main: #F1F5F9; /* Teks utama (putih kebiruan) */
  --color-text-light: #94A3B8; /* Teks sekunder */
  --color-text-lighter: #64748B; /* Teks timestamp */
  
  /* Palet Umum (Dark) */
  --color-border: #334155; /* Border */
  --color-input-bg: #283447;
  --color-shadow: rgba(0, 0, 0, 0.2);
  --color-shadow-dark: rgba(0, 0, 0, 0.3);

  /* Palet Semantik (Dark) */
  --color-text-sum: #6EE7B7; /* Hijau cerah */
  --color-alert-text: #FFAB40; /* Oranye cerah */
  --color-delete-text: #F87171;
  --color-tester-result-bg: #1C3A2A;
  --color-tester-result-text: #6EE7B7;
  --color-card-hitung-border: #2A462C;

  /* Variabel lama (disesuaikan) */
  --color-card-tester: var(--color-card-bg);
  --color-card-hitung: var(--color-card-bg);
  --color-text-sj: var(--color-accent);
  --color-calc-bg: #3a3a3a;
  --color-calc-display: #222;
  --color-card-recap: var(--color-card-bg);
  --color-recap-label: var(--color-text-light);
  --color-recap-value: var(--color-text-main);
  --color-recap-border: var(--color-border);
  --color-card-tester-border: var(--color-border);
}
/* === [AKHIR] Mode Gelap === */

*{box-sizing:border-box}

/* === [REVISI] KUNCI LAYOUT 1: HTML & BODY === */
html {
  height: 100dvh; 
}
body{
  margin:0;font-family:var(--font-main);
  font-weight:var(--font-weight-thin);
  background:var(--color-bg);color:var(--color-text-main);
  transition: background .3s, color .3s;
  font-size: 13px;
  display: flex;
  flex-direction: column;
  height: 100dvh; 
  overflow: hidden; 
}
/* Animasi */
@keyframes fadeSlideIn{from{opacity:0;transform:translateY(25px)}to{opacity:1;transform:translateY(0)}}
header{opacity:0;transform:translateY(25px);transition:opacity .8s ease,transform .8s ease}
header.visible{opacity:1;transform:translateY(0)}

/* --- [REVISI] KUNCI LAYOUT 2: HEADER (DESAIN BIRU SOLID) --- */
.app-header{
  text-align:center;padding: 15px 15px 10px;
  border-radius:0 0 20px 20px;
  background: var(--color-header-bg); /* Latar solid modern */
  box-shadow: 0 4px 10px var(--color-shadow);
  position: relative;
  flex-shrink: 0;
  z-index: 100; /* Pastikan di atas */
}

.title{
    font-size:1.2em;
    margin:0;
    color: var(--color-header-text); /* Teks header putih */
    font-weight: 700;

    /* --- [PERBAIKAN BUG STABILITAS] --- */
    white-space: nowrap; /* Paksa judul tetap 1 baris */
    overflow: hidden;    /* Sembunyikan jika terlalu panjang */
    text-overflow: ellipsis; /* Beri tanda "..." jika terpotong */
    padding: 0 30px; /* Beri jarak agar tidak mentok tombol */
}
body.dark-mode .title { color: var(--color-header-text); }
body.dark-mode .title-pl,
body.dark-mode .title-b {
    color: inherit;
}
/* Hapus warna spesifik, biarkan mewarisi dari .title */
.title-pl { color: inherit; opacity: 0.8; }
.title-b { color: inherit; }

.version{font-size:.45em;color:var(--color-header-text);vertical-align:super; opacity: 0.7;}
.build-badge{
  background: rgba(255,255,255,0.2); /* Badge transparan */
  color:var(--color-header-text);
  font-size:.65em;border-radius:8px;padding:2px 6px;margin-left:6px; font-weight: 400;
}
.subtitle{font-size: .5em;color:var(--color-text-light);margin-top: 4px;font-style:italic; display: none; }
.sponsor{font-size: .4em;color:var(--color-text-lighter);margin-top: 2px; display: none; }
.sponsor b{color:var(--color-accent)}
.timestamp{font-size:.7em;color:#999}

/* [PERBAIKAN V5.2] Tombol Header (Animasi Zoom) */
.dark-mode-toggle {
    position: absolute;
    top: 50%; 
    transform: translateY(-50%); 
    right: 25px;
    background: var(--color-header-btn-bg); 
    color: var(--color-header-btn-text); 
    border: 0px solid var(--color-border);
    border-radius: 50%;
    width: 24px; 
    height: 24px; 
    cursor: pointer;
    font-size: 0.9em; 
    line-height: 1;
    box-shadow: 0 1px 3px var(--color-shadow);
    transition: transform 0.2s, background 0.3s; /* <-- UBAH Transisi */
    
    display: flex;
    align-items: center;
    justify-content: center;
}
#trashToggleBtn {
    left: 20px;
    right: auto;
}
/* [PERBAIKAN V5.2] Animasi Zoom In (Membesar) */
.dark-mode-toggle:hover {
    transform: translateY(-50%) scale(1.1); /* <-- PERBAIKI Transform */
}

/* --- [REVISI] CARD UMUM & INPUT (GAYA MODERN) --- */
.card{
  background:var(--color-card-bg);
  border:1px solid var(--color-border);
  border-radius:var(--radius-card);
  padding:30px 20px; /* Padding atas dikurangi */
  margin:25px 0 0;
  box-shadow:var(--shadow-card);
  position:relative;
  transition: background .3s, border .3s;
}
.card h2{
    margin-top:0;
    color: var(--color-accent);
    font-size:1.05em;
    font-weight: 700; /* Lebih tebal */
}
.card-data h2 {
    color: var(--color-accent);
    font-weight: 700;
    font-size: 1.15em;
    margin-bottom: 20px;
    border-bottom: 1px dashed var(--color-border);
    padding-bottom: 10px;
}
label{
    display:block;
    margin-top:12px;
    font-size:.9em;
    font-weight: 400; /* Sedikit lebih tebal */
    color: var(--color-text-light);
}
input,select{
  width:100%;padding: 10px 12px; /* Lebih tinggi */
  margin-top:4px;
  border:1px solid var(--color-border);
  border-radius:var(--radius-input); /* Radius baru */
  font-size:.9em;font-family:var(--font-main);
  transition:.3s;
  background: var(--color-input-bg);
  color: var(--color-text-main);
  font-weight: 300;
}
input:focus,select:focus{
  outline:none;
  border-color:var(--color-accent);
  box-shadow: 0 0 0 3px var(--color-shadow); /* Bayangan fokus modern */
}
.card-tester{background:var(--color-card-tester);}
.card-hitung{background:var(--color-card-hitung);}

.card-recap{
    background: var(--color-card-recap);
    border-color: var(--color-recap-border);
}
.card-recap h2 {
    color: var(--color-text-main);
    font-weight: 700;
}
.recap-section-title {
    font-size: 0.95em;
    font-weight: 700;
    color: var(--color-accent);
    margin-top: 20px;
    margin-bottom: 10px;
    border-bottom: 1px solid var(--color-recap-border);
    padding-bottom: 5px;
}
.recap-row, .recap-row-small {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    font-size: 0.9em;
    border-bottom: 1px dashed var(--color-recap-border);
}
.card-recap .recap-row:last-child { border-bottom: none; }
.recap-label {
    color: var(--color-recap-label);
    flex-basis: 40%;
    flex-shrink: 0;
}
.recap-value {
    color: var(--color-recap-value);
    font-weight: 700;
    text-align: right;
    flex-grow: 1;
}
.recap-row-small {
    font-size: 0.85em;
    padding: 4px 0;
}
.recap-value.final-result {
    font-size: 1.1em;
    color: var(--color-text-sum);
}
.recap-value.final-result-alert {
    font-size: 1.1em;
    color: var(--color-alert-text);
}

/* [REVISI] Tombol */
.actions-row{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
.btn{
  background: var(--color-accent-light); /* Latar biru muda */
  border: 1px solid var(--color-accent-light);
  padding: 8px 12px; /* Lebih besar */
  border-radius: var(--radius-input); /* Radius baru */
  cursor:pointer;
  font-size:.7em; /* Font lebih besar */
  font-weight: 700;
  transition:.2s;
  color: var(--color-accent); /* Teks biru tua */
}
body.dark-mode .btn {
  background: var(--color-accent-light);
  border-color: var(--color-accent-light);
  color: var(--color-accent-text);
}
.btn:hover{
    transform:translateY(-1px);
    opacity: 0.9;
}
.btn.primary{
    background:var(--color-accent);
    color:var(--color-accent-text);
    border-color:var(--color-accent);
}
body.dark-mode .btn.primary:hover { color: var(--color-accent-text); }
.time-stamp{
  position:absolute;bottom:8px;right:12px;
  font-size:.65em;color:var(--color-text-lighter);font-weight:300;opacity:.8
}

.card-recap .actions-row {
    margin-top: 25px;
    border-top: 1px dashed var(--color-recap-border);
    padding-top: 15px;
    justify-content: space-around;
}
.card-recap .actions-row .btn {
    flex-grow: 1;
    flex-basis: 180px;
    text-align: center;
    font-size: 0.85em;
    background: var(--color-card-bg);
    color: var(--color-accent);
    border: 1px solid var(--color-accent);
    font-weight: 700;
}
body.dark-mode .card-recap .actions-row .btn {
    background: var(--color-card-recap);
    color: var(--color-accent);
    border-color: var(--color-accent);
}
.card-recap .actions-row .btn:hover {
    background: var(--color-accent-light);
    transform: translateY(-1px);
    color: var(--color-accent);
}
body.dark-mode .card-recap .actions-row .btn:hover {
    background: var(--color-accent-light);
    color: var(--color-accent-text);
}


/* --- [REVISI] KUNCI LAYOUT 3: CAROUSEL / SLIDE CONTAINER --- */
.carousel-wrapper {
    width: 100%; 
    max-width: 400px;
    margin: 0px auto 0;
    overflow: hidden;
    position: relative;
    border-radius: var(--radius-card);
    flex-grow: 1; 
}


.slide-track {
    display: flex;
    transition: transform 0.5s ease-in-out;
    height: 100%; 
}

.slide-item {
    min-width: 100%;
    max-width: 400px;
    flex-shrink: 0;
    padding: 0 20px;
    height: 100%; 
    display: flex;
    flex-direction: column;
}

/* --- Sembunyikan kontrol lama --- */
.carousel-controls { display: none; }
.slide-nav-btn { display: none; }
#slideIndicator { display: none; }
.global-actions { display: none; }


/* --- [REVISI] PROJECT CONTROLS DI CARD 1 (GAYA BARU) --- */
.card-project-controls {
    position: relative;
    top: auto;
    right: auto;
    display: flex;
    gap: 6px;
    z-index: 50;
}
.card-project-btn {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 1px solid var(--color-border);
    font-size: 0.8em;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 1px 3px var(--color-shadow);
    transition: transform 0.2s, opacity 0.2s, background 0.2s;
    line-height: 1;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-card-bg);
}
.card-project-btn:hover {
    transform: scale(1.1);
}
.add-btn {
    color: var(--color-accent);
}
.remove-btn {
    color: var(--color-delete-text);
}
.remove-btn:disabled {
    color: var(--color-text-lighter);
    cursor: not-allowed;
    opacity: 0.8;
    transform: none !important;
}
.reset-btn {
    color: var(--color-alert-text);
}
body.dark-mode .card-project-btn {
    background: var(--color-input-bg);
    border-color: var(--color-border);
}

/* --- [REVISI] CSS Detail (Box, Grid, dll) --- */
.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.col{flex:1 1 45%;display:flex;flex-direction:column}
.hit-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:8px;margin-top:10px}
.calc-box{
    background:var(--color-input-bg);
    border:1px solid var(--color-border);
    border-radius:var(--radius-input);
    padding:6px;
    text-align:center;
}
.calc-box input{
    border:none;
    text-align:center;
    width:100%;
    font-size:.9em;
    background:transparent;
    padding:0;
    margin:0;
    font-weight: 700;
}
.calc-box input:focus { box-shadow: none; } /* Hapus shadow di dlm box */

.summary-row{display:flex;gap:14px;align-items:center;flex-wrap:wrap;margin-top:14px}
.sum-box,.density-box{
  background:var(--color-input-bg);
  padding:10px 14px;
  border-radius:var(--radius-input);
  border:1px solid var(--color-card-tester-border);
  min-width:140px;
}
.allowance-tester-input-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px dashed var(--color-border);
}
.allowance-tester-input-group label {
    flex-basis: 75%;
    margin: 0;
    font-size: 0.95em;
    color: var(--color-text-main);
}
.allowance-tester-input-group input {
    flex-basis: 25%;
    width: auto;
    padding: 5px 8px;
    text-align: center;
    margin: 0;
    font-size: 1em;
}

.tester-result-box {
    margin-top: 15px;
    padding: 15px;
    background: var(--color-tester-result-bg);
    border-radius: var(--radius-input);
    text-align: center;
    font-weight: 700;
    border: 1px solid var(--color-card-hitung-border);
    box-shadow: 0 2px 5px var(--color-shadow);
}
body.dark-mode .tester-result-box { border-color: var(--color-card-hitung-border); }
.tester-result-box .label {
    font-size: 0.7em;
    color: var(--color-tester-result-text);
    margin-bottom: 5px;
    font-weight: 700;
}
.tester-result-box .result-value {
    font-size: 1.5em;
    color: var(--color-tester-result-text);
    line-height: 1.2;
}

/* [BARU] CSS untuk unit "ekor/kantong" di dalam result value */
.result-value small {
    font-size: 0.4em; /* Jauh lebih kecil */
    font-weight: 300;
    color: var(--color-text-light);
    display: block; /* Pindah ke baris baru */
    line-height: 1;
    margin-top: 2px;
}
body.dark-mode .result-value small {
     color: var(--color-text-light);
}

.tester-result-box.split-layout {
    display: flex;
    justify-content: space-around;
    align-items: stretch;
    gap: 15px;
    padding: 10px;
}
.result-box-split {
    flex: 1;
    min-width: 0;
    padding: 5px;
    border-radius: 6px;
}
.result-box-split.estimasi-box {
    background: #FFF3E0;
    border: 1px solid #FFE0B2;
}
body.dark-mode .result-box-split.estimasi-box {
    background: #392B1A;
    border: 1px solid #5E452A;
}
.result-box-split.estimasi-box .label {
    color: #E65100;
}
body.dark-mode .result-box-split.estimasi-box .label {
    color: var(--color-alert-text);
}
.result-box-split.estimasi-box .result-value {
    color: var(--color-alert-text);
    font-size: 1.5em;
}


.label{font-size:.8em;color:var(--color-text-light)}
.value{font-size:1em;color:var(--color-text-sum);margin-top:4px; font-weight: 700;}

/* === [REVISI] CSS STYLES FOR CARD HITUNGAN (CARD 4) === */
.order-nominal-display {
    text-align: center;
    padding: 15px 10px;
    background: var(--color-tester-result-bg); /* Latar hijau semantik */
    border: 1px solid var(--color-card-hitung-border);
    border-radius: var(--radius-input); /* Radius baru */
    margin-bottom: 20px;
    max-width: 300px; /* <-- Atur lebar maksimum box, sesuaikan jika perlu */
    margin-left: auto;   /* <-- Tambahkan ini */
    margin-right: auto;  /* <-- Tambahkan ini */
}
body.dark-mode .order-nominal-display {
    background: var(--color-tester-result-bg);
    border-color: var(--color-card-hitung-border);
}
.order-nominal-display .label {
    font-size: 0.85em;
    color: var(--color-text-sum); /* Teks hijau */
    margin-bottom: 5px;
    opacity: 0.8;
}
body.dark-mode .order-nominal-display .label { color: var(--color-text-sum); }
.order-nominal-display .value {
    font-size: 1.8em;
    font-weight: 700;
    color: var(--color-text-sum); /* Teks hijau */
    line-height: 1.1;
}

.hit-session .session-summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    font-size: 0.9em;
    font-weight: 400;
    border-bottom: 1px dashed var(--color-border);
    margin-top: 10px;
}
.hit-session .session-summary .sum-value {
    font-weight: 700;
    color: var(--color-text-sum);
}

.actions-row-small .btn {
    font-size: 0.75em;
    padding: 5px 8px;
    border-width: 1px;
    opacity: 0.7;
}

.summary-and-result-grid {
    display: block;
    gap: 15px;
    margin-top: 20px;
}

/* [REVISI] Box Summary Abu-abu & Hijau */
.grey-summary-box, .green-result-box {
    padding: 15px;
    border-radius: var(--radius-card); /* Radius Card */
    box-shadow: none; /* Hapus bayangan ganda */
    border: 1px solid var(--color-border);
}
.grey-summary-box {
    background: var(--color-bg); /* Lebih menyatu dgn body */
}
.green-result-box {
    background: var(--color-card-bg); /* Putih */
    border: 1px solid var(--color-card-hitung-border); /* Border hijau */
    margin-top: 15px;
}
body.dark-mode .grey-summary-box {
    background: var(--color-bg);
    border-color: var(--color-border);
}
body.dark-mode .green-result-box {
    background: var(--color-card-bg);
    border-color: var(--color-card-hitung-border);
}

.summary-item-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px dashed var(--color-border);
}
.summary-item-row:last-child {
    border-bottom: none;
}
.summary-label {
    font-size: 0.9em;
    color: var(--color-text-main);
}
.summary-value {
    font-size: 1.2em;
    font-weight: 700;
}
.summary-value.avg {color: var(--color-text-sum);} /* Hijau */
body.dark-mode .summary-value.avg {color: var(--color-text-sum);}
.summary-value.box {color: var(--color-alert-text);} /* Oranye */
body.dark-mode .summary-value.box {color: var(--color-alert-text);}
.summary-value.real-sj {color: var(--color-text-sum);}
.summary-value.simulation {
    color: var(--color-alert-text);
    font-size: 1.1em;
    font-weight: 700;
}
.summary-value.positive {
    color: var(--color-text-sum);
}
.summary-value.negative {
    color: var(--color-alert-text);
}

.allowance-input-grid {
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: space-between;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px dashed var(--color-border);
}
.allowance-input-grid label {
    font-size: 0.9em;
    margin: 0;
    flex-grow: 1;
}
.allowance-input-grid input {
    width: 65px;
    padding: 5px;
    text-align: center;
    margin: 0;
}
.allowance-display {
    font-weight: 700;
    font-size: 1.1em;
    color: var(--color-text-sum);
    text-align: right;
    flex-shrink: 0;
}
.allowance-result-row .summary-label {
    flex-basis: 50%;
}
.allowance-result-row .allowance-inputs {
    display: flex;
    gap: 5px;
    align-items: center;
}

/* Floating Calculator CSS (No Change) */
.calculator-container {
    position: fixed; top: 100px; right: 20px; z-index: 1000;
    transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out;
    transform: translateX(100%); opacity: 0;
}
.calculator-container.visible {transform: translateX(0); opacity: 1;}
.calculator-card {
    width: 280px; background: var(--color-calc-bg); border-radius: var(--radius-card);
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3); padding: 15px;
}
.calc-display-input {
    width: 100%; height: 60px; background: var(--color-calc-display); border: none;
    border-radius: 8px; text-align: right; font-size: 2.2em; font-weight: 700;
    color: #333; padding: 10px; margin-bottom: 10px; pointer-events: none;
}
body.dark-mode .calc-display-input { color: var(--color-text-main); }
.calc-grid {display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;}
.calc-btn {
    background: #6c6c6c; color: white; border: none; border-radius: 50%;
    height: 55px; font-size: 1.2em; cursor: pointer; transition: background 0.2s;
}
body.dark-mode .calc-btn { background: #555; }
.calc-btn:hover {background: #888;}
body.dark-mode .calc-btn:hover {background: #777;}
.calc-btn.operator {background: var(--color-calc-operator); font-weight: 700;}
.calc-btn.operator:hover {background: #ffb75f;}
.calc-btn.clear, .calc-btn.toggle-sign {background: #a6a6a6; color: #333;}
body.dark-mode .calc-btn.clear, body.dark-mode .calc-btn.toggle-sign { background: #888; color: #f1f1f1; }
.calc-btn.clear:hover, .calc-btn.toggle-sign:hover {background: #c2c2c2;}
body.dark-mode .calc-btn.clear:hover, body.dark-mode .calc-btn.toggle-sign:hover {background: #999;}
.calc-btn.zero {grid-column: span 2; border-radius: 55px; text-align: left; padding-left: 20px;}
.calc-toggle-btn {
    position: fixed; bottom: 20px; right: 20px; z-index: 1001;
    background: var(--color-accent); color: white; border: none; border-radius: 50%;
    width: 50px; height: 50px; font-size: 1.5em; box-shadow: 0 4px 8px var(--color-shadow);
    cursor: pointer; transition: background 0.3s, transform 0.2s;
}
/* [PERBAIKAN V5.2] Animasi Zoom In (Membesar) */
.calc-toggle-btn:hover {
    background: #0056b3;
    transform: scale(1.1); /* <-- TAMBAHKAN Animasi Zoom */
}


/* === [REVISI] Toggle Switch Simulasi (Gaya Modern) === */
.simulasi-toggle-container {
    display: flex;
    
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}
.simulasi-toggle-label {
    font-size: 0.9em;
    font-weight: 700;
    color: var(--color-text-main);
}
.switch {
    position: relative;
    display: inline-block;
    width: 44px; /* Lebar switch */
    height: 24px; /* Tinggi switch */
    flex-shrink: 0; /* <-- DITAMBAH: agar switch tidak gepeng */
}
.switch input { 
    opacity: 0;
    width: 0;
    height: 0;
}
.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
}
.slider:before {
    position: absolute;
    content: "";
    height: 18px; /* Ukuran knob */
    width: 18px; /* Ukuran knob */
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
input:checked + .slider {
    background-color: var(--color-accent); /* Warna Biru Aksen */
}
input:checked + .slider:before {
    transform: translateX(20px); /* Pergeseran knob */
}
.slider.round {
    border-radius: 24px;
}
.slider.round:before {
    border-radius: 50%;
}
/* === [AKHIR] REVISI 5 === */

/* === [REVISI] Penyesuaian Font Mobile === */
@media (max-width: 360px) {
    body {
        font-size: 13px; /* Tetap di 13px */
    }
    .title { font-size: 1.1em; }
    .subtitle { font-size: 0.8em; }
    .btn, .card-recap .actions-row .btn, .global-actions .btn {
        font-size: 0.8em;
    }
    .card-data h2 { font-size: 1.05em; }
    .card h2 { font-size: 1em; }
    .tester-result-box .result-value { font-size: 1.5em; }
    .result-box-split.estimasi-box .result-value { font-size: 1.4em; }
    .order-nominal-display .value { font-size: 1.5em; }
    .summary-value { font-size: 1.1em; }
    .hit-grid {
        grid-template-columns: repeat(auto-fit,minmax(70px,1fr));
    }
}
/* === [REVISI] Floating Nav Bar Bawah === */

/* 1. Kontainer Utama */
.floating-nav-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    padding: 12px 15px 15px; /* Padding bawah lebih besar */
    /* Latar belakang gradien agar teks terbaca */
    background: linear-gradient(180deg, 
        rgba(255,255,255,0) 0%, 
        rgba(255,255,255,0.8) 20%, 
        var(--color-bg) 100%
    );
    box-shadow: none; /* Hapus bayangan, andalkan gradien */
    
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    z-index: 998;
    pointer-events: none; /* Kontainer tidak bisa diklik */
}
body.dark-mode .floating-nav-bar {
    background: linear-gradient(180deg, 
        rgba(15, 23, 42, 0) 0%, 
        rgba(15, 23, 42, 0.8) 20%, 
        var(--color-bg) 100%
    );
}

/* 2. Grup Tombol (Kiri, Tengah, Kanan) */
.floating-nav-group {
    display: flex;
    align-items: center;
    gap: 10px;
    pointer-events: auto; /* Tombol bisa diklik */
}
.floating-nav-group.center {
    position: absolute; 
    left: 50%;
    transform: translateX(-50%);
    display: none; 
}
.floating-nav-group.right {
    margin-left: auto; /* Dorong ke kanan */
}

/* [PERBAIKAN V5.2] Style Tombol Bulat (Animasi Zoom) */
.floating-nav-btn {
    background: var(--color-accent); /* Biru Aksen */
    color: var(--color-accent-text); /* Putih */
    border: none;
    border-radius: 50%;
    width: 40px; /* Lebih besar */
    height: 40px; /* Lebih besar */
    font-size: 1.3em;
    box-shadow: 0 4px 12px var(--color-shadow-dark); /* Bayangan lebih kuat */
    cursor: pointer;
    /* [PERBAIKAN V5.2] Transisi hover "zoom" */
    transition: background 0.3s, transform 0.2s, box-shadow 0.2s ease-out;
    
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    padding: 0;
}
/* [PERBAIKAN V5.2] Animasi hover "zoom" */
.floating-nav-btn:hover {
    transform: scale(1.1); /* <-- GANTI ANIMASI JADI ZOOM */
    box-shadow: 0 8px 20px var(--color-shadow-dark); /* <-- PERBESAR BAYANGAN */
}
/* Tombol Save berwarna Kuning Telur */
.floating-nav-btn.save-btn {
    background: #FFC107; 
    color: #212529;       
}
body.dark-mode .floating-nav-btn.save-btn {
    background: #FFC107; 
    color: #212529;       
}

/* Tombol Navigasi Disabled */
.floating-nav-btn:disabled {
    background: var(--color-border);
    color: var(--color-text-lighter);
    box-shadow: none;
    transform: none;
    cursor: not-allowed;
}

/* 5. Style Indikator Halaman */
.floating-nav-indicator {
    background: var(--color-card-bg);
    color: var(--color-text-main);
    font-size: 1.1em;
    font-weight: 700;
    padding: 10px 16px;
    border-radius: 25px;
    box-shadow: 0 4px 8px var(--color-shadow);
    border: 1px solid var(--color-border);
}

/* 6. SEMBUNYIKAN Kontrol Asli */
#prevSlideBtn, #nextSlideBtn, #slideIndicator {
    display: none !important;
}
body > .calc-toggle-btn {
    display: none !important;
}
/* === [AKHIR PATCH CSS] === */

/* === [REVISI] CSS Card Keranjang Sampah (Floating Panel) === */

/* 1. Kontainer Utama (Panel Mengambang) */
.trash-popup-container {
    position: absolute;
    top: 70px; 
    left: 50%;
    transform: translateX(-50%);
    z-index: 990; 
    width: 90%;
    max-width: 360px; 
    max-height: 60vh; 
    
    background: var(--color-bg); /* Latar belakang body */
    border-radius: var(--radius-card);
    box-shadow: 0 5px 20px var(--color-shadow-dark); /* Bayangan lebih kuat */
    border: 1px solid var(--color-border);

    overflow: hidden; 
}

/* 2. Atur .slide-item khusus di dalam trash */
.trash-popup-container .slide-item {
    padding: 0; 
    height: auto;
    max-height: 60vh; 
    overflow-y: auto; 
}

/* 3. Atur .card-trash khusus di dalam trash */
.trash-popup-container .card-trash {
    margin: 0; 
    box-shadow: none; 
    border: none; 
}
/* === [AKHIR] CSS Card Keranjang Sampah === */

/* [REVISI] CSS untuk Card Keranjang Sampah (GAYA BARU) */
.card-trash {
    background: var(--color-card-recap); 
    border-color: var(--color-recap-border);
}
.trash-list {
    max-height: 400px;
    overflow-y: auto;
}
.trash-modal-list-item { 
    background: var(--color-card-bg); /* Latar kartu */
    border: 1px solid var(--color-border);
    border-radius: var(--radius-input); /* Radius baru */
    padding: 10px 15px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
}
.trash-item-info strong {
    display: block;
    font-size: 1em;
    color: var(--color-text-main);
}
.trash-item-info span {
    font-size: 0.8em;
    color: var(--color-text-light);
}
.trash-item-actions { display: flex; gap: 8px; }
.trash-item-actions .btn { font-size: 0.8em; padding: 5px 8px; }
.trash-item-actions .restore { 
    border-color: var(--color-text-sum); 
    color: var(--color-text-sum); 
    background: transparent;
}
body.dark-mode .trash-item-actions .restore { 
    background: var(--color-tester-result-bg); 
    border-color: var(--color-card-hitung-border);
}
.trash-item-actions .delete { 
    border-color: var(--color-delete-text); 
    color: var(--color-delete-text); 
    background: transparent;
}
body.dark-mode .trash-item-actions .delete { 
    background: #4a2125;
    border-color: #dc3545;
}
/* === [AKHIR] CSS Card Sampah === */

/* === [REVISI] DESAIN 1: GAYA TAB MODERN === */

/* 1. Navigasi Tab (Kotak Pil di Atas) */
.card-tab-nav {
    display: flex;
    justify-content: space-around;
    background: var(--color-tab-nav-bg); /* Latar abu-abu muda */
    margin: 15px 0 0 0; /* Margin atas */
    padding: 4px; /* Padding untuk "pill" di dalam */
    border-radius: 25px; /* Bentuk pil luar */
    box-shadow: none;
    border: 1px solid var(--color-border);
    position: sticky; 
    top: 5px; /* Jarak dari atas layar */
    z-index: 10;
    flex-shrink: 0; 
}
body.dark-mode .card-tab-nav {
    border: none; /* Hapus border di dark mode */
}

/* 2. Tombol Tab Individual */
.tab-link {
    flex-grow: 1;
    border: none;
    background: transparent; /* Transparan, hanya yg aktif yg solid */
    color: var(--color-text-light);
    padding: 8px 5px; /* Padding tombol */
    border-radius: 20px; /* Pil di dalam */
    font-weight: 700;
    font-size: 0.8em; 
    cursor: pointer;
    transition: background 0.3s, color 0.3s;
    text-align: center;
    white-space: nowrap; 
}

/* 3. Tombol Tab Saat Aktif */
.tab-link.active {
    background: var(--color-accent); /* Biru Aksen */
    color: var(--color-accent-text); /* Putih */
    box-shadow: 0 2px 5px var(--color-shadow-dark);
}
body.dark-mode .tab-link.active {
    color: #FFFFFF; /* Pastikan putih di dark mode */
}

/* 4. [REVISI] KUNCI LAYOUT 6: KONTEN TAB */
.card-tab-content {
    padding-top: 10px; /* Jarak dari tab ke kartu */
    flex-grow: 1; 
    overflow-y: auto; 
    overflow-x: hidden;
    /* Padding bawah agar tidak tertutup nav melayang */
    padding-bottom: 90px; 
}

/* 5. Panel Kartu (Default Tersembunyi) */
.tab-panel {
    display: none; 
    margin-top: 0 !important; 
    animation: fadeSlideIn 0.4s ease; 
}
.tab-panel.active {
    display: block;
}

/* === [REVISI] PENYESUAIAN CSS LAMA === */

/* 1. Ubah .slide-item */
.slide-item {
    min-width: 100%;
    max-width: 400px;
    flex-shrink: 0;
    padding: 0 15px; /* Jarak samping utama */
    height: 100%; 
    display: flex;
    flex-direction: column;
}

/* 2. Ubah .card di dalam tab */
.tab-panel.card {
    margin: 0 0 15px 0; /* Margin bawah antar kartu */
    box-shadow: var(--shadow-card); /* Shadow konsisten */
}

/* 3. Ubah h2 di kartu pertama (Data Panen) */
.card-data h2 {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-right: -10px; 
}

/* 4. Pindahkan .card-project-controls (sudah di-override di atas) */


/* === [BARU] SEMBUNYIKAN SCROLLBAR === */

/* Sembunyikan scrollbar untuk Chrome, Safari, Edge */
.card-tab-content::-webkit-scrollbar {
    display: none;
}

/* Sembunyikan scrollbar untuk Firefox */
.card-tab-content {
    scrollbar-width: none; /* Firefox */
}
</style>
</head>

<body>

<header class="app-header visible">
  <button id="trashToggleBtn" class="dark-mode-toggle" onclick="showTrash()" title="Buka Keranjang Sampah">‚ôªÔ∏è</button>
  
  <button id="darkModeToggle" class="dark-mode-toggle" title="Ganti Tema">üåô</button>

  <h1 class="title">
    <span class="title-pl">PL</span><span class="title-b">B</span> ShrimpCount
    <span class="version">V5.2</span>
    <span class="build-badge">Beta</span>
  </h1>
  <p class="subtitle">Alat Hitung & Simulasi Packing ‚Äî cepat, akurat, siap lapangan.</p>
  <p class="sponsor">This app has been built for internal use and restricted purpose only! ‚ìí 2025 All Right Reserved</p>
</header>

<div id="carouselWrapper" class="carousel-wrapper">
    <div id="slideTrack" class="slide-track">
        </div>
</div>

<div class="carousel-controls">
    </div>
<div id="calculatorContainer" class="calculator-container">
    <div class="calculator-card">
        <input type="text" id="calcDisplay" class="calc-display-input" value="0">
        <div class="calc-grid">
            <button class="calc-btn clear" onclick="calcClear()">AC</button>
            <button class="calc-btn clear" onclick="calcBackspace()">DEL</button>
            <button class="calc-btn clear" onclick="calcPercent()">%</button>
            <button class="calc-btn operator" onclick="calcOperator('/')">√∑</button>

            <button class="calc-btn" onclick="calcInput('7')">7</button>
            <button class="calc-btn" onclick="calcInput('8')">8</button>
            <button class="calc-btn" onclick="calcInput('9')">9</button>
            <button class="calc-btn operator" onclick="calcOperator('*')">√ó</button>

            <button class="calc-btn" onclick="calcInput('4')">4</button>
            <button class="calc-btn" onclick="calcInput('5')">5</button>
            <button class="calc-btn" onclick="calcInput('6')">6</button>
            <button class="calc-btn operator" onclick="calcOperator('-')">‚àí</button>

            <button class="calc-btn" onclick="calcInput('1')">1</button>
            <button class="calc-btn" onclick="calcInput('2')">2</button>
            <button class="calc-btn" onclick="calcInput('3')">3</button>
            <button class="calc-btn operator" onclick="calcOperator('+')">+</button>

            <button class="calc-btn zero" onclick="calcInput('0')">0</button>
            <button class="calc-btn" onclick="calcInput('.')">.</button>
            <button class="calc-btn operator" onclick="calcEquals()">=</button>
        </div>
    </div>
</div>

<button class="calc-toggle-btn" onclick="toggleCalculator()">üßÆ</button>


<template id="panen-template">
    <div class="slide-item">

        <div class="card-tab-nav">
            <button class="tab-link active" onclick="openCard(event, '{{INSTANCE_ID}}_data')">üìã Data</button>
            <button class="tab-link" onclick="openCard(event, '{{INSTANCE_ID}}_tester')">üî¨ Tester</button>
            <button class="tab-link" onclick="openCard(event, '{{INSTANCE_ID}}_hitung')">üî¢ Hitung</button>
            <button class="tab-link" onclick="openCard(event, '{{INSTANCE_ID}}_rekap')">üìä Rekap</button>
        </div>

        <div class="card-tab-content">

            <section id="{{INSTANCE_ID}}_data" class="card card-data tab-panel" style="display: block;">
                <h2 id="{{INSTANCE_ID}}_title">
                    üìã Data Panen {{ID}}
                    <div class="card-project-controls">
                        <button class="card-project-btn add-btn" onclick="addInstance()" title="Tambah Data Panen Baru">‚ûï</button>
                        <button class="card-project-btn reset-btn" onclick="resetCard1('{{INSTANCE_ID}}')" title="Reset Data Panen Ini">üîÑ</button>
                        <button id="{{INSTANCE_ID}}_removeBtn" class="card-project-btn remove-btn" onclick="removeInstance()" title="Hapus Data Panen Ini" disabled>‚ùå</button>
                    </div>
                </h2>

                <label>üìÖ Tanggal Panen</label><input id="{{INSTANCE_ID}}_line" type="date" placeholder="YYYY-MM-DD" oninput="updateRecap('{{INSTANCE_ID}}')">
                <label>üë§ Nama Customer</label><input id="{{INSTANCE_ID}}_customer" placeholder="Nama Customer" oninput="updateRecap('{{INSTANCE_ID}}')">
                <label>üéØ Tujuan</label><input id="{{INSTANCE_ID}}_tujuan" placeholder="Kota Tujuan" oninput="updateRecap('{{INSTANCE_ID}}')">
                <label>üìà Order Benur (Ekor)</label><input type="text" id="{{INSTANCE_ID}}_nominalOrder" placeholder="0" oninput="formatCurrency(this); recalcAllHitungan('{{INSTANCE_ID}}'); recalcAllTester('{{INSTANCE_ID}}')">

                <label>üöõ Jenis Truk</label>
                <select id="{{INSTANCE_ID}}_jenisTruk" onchange="updateTruckDetails('{{INSTANCE_ID}}'); recalcAllTester('{{INSTANCE_ID}}'); recalcAllHitungan('{{INSTANCE_ID}}')">
                    <option value="Euro2">Euro 2</option>
                    <option value="Euro4">Euro 4</option>
                    <option value="Bandara">Bandara</option>
                </select>

                <label>üì¶ Kapasitas Angkut (Box)</label>
                <input type="number" id="{{INSTANCE_ID}}_kapasitasAngkut" placeholder="Auto isi">

                <label>‚öñÔ∏è Isi Per Box (Kantong)</label>
                <input type="number" id="{{INSTANCE_ID}}_isiBox" placeholder="Auto isi dari jenis truk" readonly>

                <label>üöö Driver</label>
                <select id="{{INSTANCE_ID}}_driver" onchange="updateDriverDetails('{{INSTANCE_ID}}')">
                    </select>
                
                <label>üöó Plat Nomor</label>
                <input id="{{INSTANCE_ID}}_platNomor" placeholder="Plat Nomor (auto-fill)" oninput="updateRecap('{{INSTANCE_ID}}')">
            </section>

            <section id="{{INSTANCE_ID}}_tester" class="card card-tester tab-panel">
                <h2>üî¨ Hitungan Tester</h2>

                <div class="row">
                    <div class="col"><label>üíß Nomor Bak</label><input id="{{INSTANCE_ID}}_nomorBak" placeholder="Bak Scooring" oninput="updateRecap('{{INSTANCE_ID}}')"></div>
                </div>

                <div class="row">
                    <div class="col"><label>ü§ñ Tomota (ekor)</label><input id="{{INSTANCE_ID}}_tomota" type="number" placeholder="Tomota" oninput="updateRecap('{{INSTANCE_ID}}')"></div>
                </div>
                <div class="row">
                    <div class="col"><label>Hitungan Tester:</label></div>
                </div>

                <div id="{{INSTANCE_ID}}_hitGridTester" class="hit-grid"></div>
                
                <div class="summary-row">
                    <div class="sum-box"><div class="label">Œ£ Total</div><div id="{{INSTANCE_ID}}_testerSum" class="value">0</div></div>
                    <div class="density-box"><div class="label">Density (ekor/L)</div><div id="{{INSTANCE_ID}}_testerDensity" class="value">-</div></div>
                </div>

                <div class="allowance-tester-input-group">
                    <label>Allowance Tester (%)</label>
                    <input type="number" id="{{INSTANCE_ID}}_allowanceTester" value="0" min="0" max="100" oninput="recalcAllTester('{{INSTANCE_ID}}')">
                </div>

                <div class="tester-result-box split-layout">
                    <div class="result-box-split">
                        <div class="label">‚ú® Hasil Benur Tester (Dibulatkan)</div>
                        <div id="{{INSTANCE_ID}}_finalTesterResult" class="result-value">0</div>
                    </div>
                    <div class="result-box-split estimasi-box">
                        <div class="label">üì¶ Estimasi Box (Tester)</div>
                        <div id="{{INSTANCE_ID}}_estimasiBoxTester" class="result-value">0 Box</div>
                    </div>
                </div>
                <div class="actions-row">
                    <button class="btn" onclick="addCalcBox('{{INSTANCE_ID}}_hitGridTester')">‚ûï Tambah Kolom</button>
                    <button class="btn" onclick="removeCalcBox('{{INSTANCE_ID}}_hitGridTester')">‚ùå Hapus Kolom</button>
                    <button class="btn" onclick="resetTester('{{INSTANCE_ID}}')">üîÑ Reset Semua</button>
                </div>
                <div id="{{INSTANCE_ID}}_testerTimestamp" class="time-stamp">üïí Terakhir diperbarui: -</div>
            </section>

            <section id="{{INSTANCE_ID}}_hitung" class="card card-hitung tab-panel">
                <h2>üî¢ Hitungan</h2>

                <div class="order-nominal-display">
                    <div class="label">üéØ Order Benur (Ekor)</div>
                    <div id="{{INSTANCE_ID}}_orderDisplay" class="value">0</div>
                </div>

                <div id="{{INSTANCE_ID}}_multiSessionGrid">
                    </div>

                <div class="actions-row actions-row-small">
                    <button class="btn" onclick="addCalcBox('{{INSTANCE_ID}}_multiSessionGrid')">‚ûï Tambah Kolom</button>
                    <button class="btn primary" onclick="addHitunganSession('{{INSTANCE_ID}}')">‚ûï Tambah Baris</button>
                    <button class="btn" onclick="removeHitunganSession('{{INSTANCE_ID}}')">‚ùå Hapus Baris</button>
                    <button class="btn" onclick="resetHitungan('{{INSTANCE_ID}}')">üîÑ Reset Semua</button>
                </div>

                <div class="summary-and-result-grid">
                    
                    <div class="grey-summary-box">
                        
                        <div class="summary-item-row">
                            <div class="summary-label">Rata-rata (Aktual)</div>
                            <div id="{{INSTANCE_ID}}_avgValueDisplay" class="summary-value avg">0 ekor</div>
                        </div>
                        <div class="summary-item-row allowance-result-row">
                            <div class="summary-label">Allowance (%)</div>
                            <div class="allowance-inputs">
                                <input type="number" id="{{INSTANCE_ID}}_allowance1" value="0" min="0" max="100" oninput="recalcAllHitungan('{{INSTANCE_ID}}')" style="width: 70px;">
                                <span>-</span>
                                <input type="number" id="{{INSTANCE_ID}}_allowance2" value="0" min="0" max="100" oninput="recalcAllHitungan('{{INSTANCE_ID}}')" style="width: 70px;">
                            </div>
                        </div>
                        <div class="summary-item-row">
                            <div class="summary-label">üì¶ Kebutuhan Box</div>
                            <div id="{{INSTANCE_ID}}_kebutuhanBox" class="summary-value box">0 Box</div>
                        </div>
                        
                        <div id="{{INSTANCE_ID}}_limitKapasitasToggleContainer" class="simulasi-toggle-container" style="justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--color-border);">
                            <span class="simulasi-toggle-label" style="font-size: 0.9em; color: var(--color-accent);">Batasi ke Kapasitas Truk?</span>
                            <label class="switch">
                                <input type="checkbox" id="{{INSTANCE_ID}}_limitKapasitasToggle" onchange="recalcAllHitungan('{{INSTANCE_ID}}')" checked>
                                <span class="slider round"></span>
                            </label>
                        </div>

                        <div class="summary-item-row" id="{{INSTANCE_ID}}_simulasiBoxRow" style="display: none;">
                            <div class="summary-label" style="font-weight: 700; color: var(--color-alert-text);">‚ö† Simulasi Box Real (Over Capacity)</div>
                            <div id="{{INSTANCE_ID}}_simulasiBoxReal" class="summary-value simulation"></div>
                        </div>
                    </div>

                    <div class="green-result-box">

                        <div id="{{INSTANCE_ID}}_manualBenurToggleContainer" class="simulasi-toggle-container" style="justify-content: space-between; margin-bottom: 5px;">
                            <span class="simulasi-toggle-label" style="font-size: 0.9em; color: var(--color-alert-text);">Gunakan Override Manual?</span>
                            <label class="switch">
                                <input type="checkbox" id="{{INSTANCE_ID}}_manualBenurToggle" onchange="toggleManualBenurInput('{{INSTANCE_ID}}')">
                                <span class="slider round"></span>
                            </label>
                        </div>

                        <div class="summary-item-row" id="{{INSTANCE_ID}}_manualBenurInputRow" style="background: var(--color-card-recap); padding: 8px; border-radius: 6px; margin-top: 5px; display: none;">
                            <div class="summary-label" style="font-size: 0.85em; font-style: italic;">
                                Override Manual (Ekor):
                            </div>
                            <div class="allowance-inputs">
                                <input type="number" id="{{INSTANCE_ID}}_manualBenurOverride" oninput="recalcAllHitungan('{{INSTANCE_ID}}')" style="width: 100px; font-weight: 700; text-align: right; color: var(--color-alert-text);">
                                <button class="btn" onclick="clearManualBenur('{{INSTANCE_ID}}')" style="padding: 5px 8px; font-size: 0.7em; line-height: 1; min-width: 30px;" title="Reset Override">üîÑ</button>
                            </div>
                        </div>

                        <div class="tester-result-box split-layout" id="{{INSTANCE_ID}}_benurPerKantongWrapper" 
                             style="padding: 10px 5px; margin-top: 10px; border-top: 1px dashed var(--color-border); background: transparent; border: none; box-shadow: none;">
                            
                            <div class="result-box-split" id="{{INSTANCE_ID}}_benurPerKantongRealBox" style="background: var(--color-tester-result-bg); border-color: var(--color-card-hitung-border);">
                                <div class="label" id="{{INSTANCE_ID}}_benurPerKantongRealLabel" style="font-size: 0.7em; color: var(--color-tester-result-text);">
                                    Benur/Kantong (Real)
                                    <small class="text-muted" style="font-size: 0.9em; display: block; color: inherit; opacity: 0.7;">(Rata-rata - A1)</small>
                                </div>
                                <div id="{{INSTANCE_ID}}_benurPerKantongReal" class="result-value" style="font-size: 1.5em; color: var(--color-text-sum);">
                                    <span>0</span> <small>ekor/kantong</small>
                                </div>
                            </div>
                            
                            <div class="result-box-split estimasi-box" id="{{INSTANCE_ID}}_benurPerKantongSJBox" style="display: none; background: var(--color-card-bg); border-color: var(--color-accent);">
                                <div class="label" id="{{INSTANCE_ID}}_benurPerKantongSJLabel" style="font-size: 0.7em; color: var(--color-accent);">
                                    Benur/Kantong (SJ)
                                    <small class="text-muted" style="font-size: 0.9em; display: block; color: inherit; opacity: 0.7;">(Rata-rata - A1 - A2)</small>
                                </div>
                                <div id="{{INSTANCE_ID}}_benurPerKantongSJ" class="result-value" style="font-size: 1.5em; color: var(--color-accent);">
                                    <span>0</span> <small>ekor/kantong</small>
                                </div>
                            </div>
                        </div>
                        </div>

                    <section class="grey-summary-box" id="{{INSTANCE_ID}}_selisihBox" style="display: none; margin-top: 15px;">
                        <div class="summary-item-row" style="border-bottom: 1px solid var(--color-border);">
                            <div class="summary-label" style="font-weight: 700; color: var(--color-accent); font-size: 0.95em;">üê† Rekap Packing</div>
                        </div>

                        <div class="summary-item-row">
                            <span class="summary-label">Total Benur Packing</span>
                            <span class="summary-value real-sj" id="{{INSTANCE_ID}}_selisih_totalPacking">0</span>
                        </div>
                        <div class="summary-item-row">
                            <span class="summary-label">Selisih (vs Order)</span>
                            <span class="summary-value" id="{{INSTANCE_ID}}_selisih_selisihOrder">0</span>
                        </div>
                    
                        <div id="{{INSTANCE_ID}}_selisihWarningBox" style="display: none; margin-top: 15px; border-top: 1px dashed var(--color-recap-border); padding-top: 15px; text-align: center;">
                            <h3 style="font-size: 0.9em; color: var(--color-alert-text); margin: 0 0 8px 0;">‚ö† Peringatan Selisih! Cek Ulang:</h3>
                            <div class="simulasi-toggle-container" style="justify-content: center;">
                                <span class="simulasi-toggle-label">Gunakan Simulasi</span>
                                <label class="switch">
                                    <input type="checkbox" id="{{INSTANCE_ID}}_simulasiToggle" onchange="toggleSimulasiUsage('{{INSTANCE_ID}}')">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <div id="{{INSTANCE_ID}}_selisihFinalResult" style="font-size: 1.8em; font-weight: 700; color: var(--color-alert-text); text-align: center; background: var(--color-card-tester); padding: 10px; border-radius: 8px; margin-top: 10px;">
                                0 ekor/kantong
                            </div>
                            <div id="{{INSTANCE_ID}}_selisihSimulasiResult" style="font-size: 0.9em; font-weight: 700; color: var(--color-text-light); margin-top: 8px;">
                                Estimasi Selisih Baru: +0 ekor
                            </div>
                        </div>
                    </section>
                </div>
                        
                <div class="actions-row">
                    </div>

                <div id="{{INSTANCE_ID}}_hitunganTimestamp" class="time-stamp">üïí Terakhir diperbarui: -</div>
            </section>

            <section id="{{INSTANCE_ID}}_rekap" class="card card-recap tab-panel">
                <h2>üìä Rekap Panen {{ID}}</h2>

                <h3 class="recap-section-title">Data Panen</h3>
                <div class="recap-row"><span class="recap-label">Customer</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_customer">-</span></div>
                <div class="recap-row"><span class="recap-label">Tujuan</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_tujuan">-</span></div>
                <div class="recap-row"><span class="recap-label">Tanggal Panen</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_line">-</span></div>
                <div class="recap-row"><span class="recap-label">Driver</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_driver">-</span></div>
                <div class="recap-row"><span class="recap-label">Plat Nomor</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_platNomor">-</span></div>
                <div class="recap-row"><span class="recap-label">Order</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_orderBenur">0</span></div>
                <div class="recap-row"><span class="recap-label">Truk</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_jenisTruk">-</span></div>
                <div class="recap-row"><span class="recap-label">Kapasitas</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_kapasitasAngkut">0 Box</span></div>
                <div class="recap-row"><span class="recap-label">Isi/Box</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_isiBox">0 Kantong</span></div>

                <h3 class="recap-section-title">Data Tester</h3>
                <div class="recap-row"><span class="recap-label">No. Bak</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_nomorBak">-</span></div>
                <div class="recap-row"><span class="recap-label">Tomota</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_tomota">- ekor</span></div>
                <div class="recap-row"><span class="recap-label">Œ£ Total</span><span class="recap-value" id="{{INSTANCE_ID}}_testerSum">0</span></div>
                <div class="recap-row"><span class="recap-label">Density</span><span class="recap-value" id="{{INSTANCE_ID}}_testerDensity">-</span></div>
                <div class="recap-row"><span class="recap-label">Allowance</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_allowanceTester">0 %</span></div>
                <div class="recap-row"><span class="recap-label">Hasil Benur Tester</span><span class="recap-value final-result" id="{{INSTANCE_ID}}_recap_hasilTester">0</span></div>
                <div class="recap-row"><span class="recap-label">Estimasi Box</span><span class="recap-value final-result-alert" id="{{INSTANCE_ID}}_recap_estimasiBoxTester">0 Box</span></div>

                <h3 class="recap-section-title">Hasil Hitungan</h3>
                <div id="{{INSTANCE_ID}}_recap_sessionSummary">
                    </div>
                <div class="recap-row"><span class="recap-label">Rata-rata (Aktual)</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_avgValue">0 ekor</span></div>
                <div class="recap-row"><span class="recap-label">Allowance</span><span class="recap-value" id="{{INSTANCE_ID}}_recap_allowanceHitung">0% / 0%</span></div>
                <div class="recap-row"><span class="recap-label">Kebutuhan Box</span><span class="recap-value final-result-alert" id="{{INSTANCE_ID}}_recap_kebutuhanBox">0 Box</span></div>
                <div class="recap-row"><span class="recap-label">Benur/Kantong (Real)</span><span class="recap-value final-result" id="{{INSTANCE_ID}}_recap_benurReal">0 ekor/kantong</span></div>
                <div class="recap-row" id="{{INSTANCE_ID}}_recap_benurSJ_row" style="display: none;"><span class="recap-label">Benur/Kantong (SJ)</span><span class="recap-value final-result" id="{{INSTANCE_ID}}_recap_benurSJ">0 ekor/kantong</span></div>
                <div class="recap-row" id="{{INSTANCE_ID}}_recap_simulasi_row" style="display: none;"><span class="recap-label">‚ö† Simulasi Real</span><span class="recap-value final-result-alert" id="{{INSTANCE_ID}}_recap_simulasi">0 ekor/kantong</span></div>

                <div class="actions-row">
                    <button class="btn" onclick="saveData('{{INSTANCE_ID}}')" title="Simpan semua input data ke memori browser">üíæ Save</button>
                    <button class="btn" onclick="shareToCustomer('{{INSTANCE_ID}}')" title="Bagikan rincian panen ke Customer via Whatsapp">ü§≥üèª Bagikan ke Customer</button>
                    <button class="btn" onclick="shareAdmin('{{INSTANCE_ID}}')" title="Kirim rincian panen via WhatsApp">üöõ Kirim Rincian Panen</button>
                </div>

                <div id="{{INSTANCE_ID}}_recapTimestamp" class="time-stamp">üïí Terakhir diperbarui: -</div>
            </section>

        </div> </div> </template>

<div class="floating-nav-bar">
    
    <div class="floating-nav-group left">
        <button id="floatingSaveBtn" class="floating-nav-btn save-btn" title="Simpan Data Panen Ini">üíæ</button>
    </div>
    
    <div id="floatingNavCenter" class="floating-nav-group center">
        <button id="floatingPrevBtn" class="floating-nav-btn" title="Slide Sebelumnya" disabled>&lt;</button>
        <span id="floatingIndicator" class="floating-nav-indicator">1 / 1</span>
        <button id="floatingNextBtn" class="floating-nav-btn" title="Slide Berikutnya" disabled>&gt;</button>
    </div>
    
    <div class="floating-nav-group right">
        <button id="floatingCalcBtn" class="floating-nav-btn" onclick="toggleCalculator()" title="Buka Kalkulator">üßÆ</button>
    </div>

</div>

<div id="trashCardContainer" class="trash-popup-container" style="display: none;">
    <div class="slide-item" style="padding: 0 20px;">
        <section class="card card-trash">
            <h2 style="margin-bottom: 20px;">‚ôªÔ∏è Keranjang Sampah</h2>
            
            <div id="staticTrashList" class="trash-list">
                </div>
        </section>
    </div>
</div>

<script>

// ===================================
// [BARU] FUNGSI UNTUK DESAIN 1: TAB
// ===================================
/**
 * Mengganti kartu yang terlihat di dalam satu slide.
 * Dipanggil oleh tombol tab.
 */
function openCard(evt, cardIdToOpen) {
    // 1. Dapatkan elemen 'slide-item' terdekat
    const slideItem = evt.target.closest('.slide-item');
    if (!slideItem) return;

    // 2. Dapatkan semua panel tab di dalam slide-item ini
    const tabPanels = slideItem.querySelectorAll('.tab-panel');
    
    // 3. Sembunyikan semua panel
    tabPanels.forEach(panel => {
        panel.style.display = 'none';
        panel.classList.remove('active');
    });

    // 4. Hapus status 'active' dari semua tombol tab
    const tabLinks = slideItem.querySelectorAll('.tab-link');
    tabLinks.forEach(link => {
        link.classList.remove('active');
    });

    // 5. Tampilkan panel yang diklik
    const cardToShow = document.getElementById(cardIdToOpen);
    if (cardToShow) {
        cardToShow.style.display = 'block';
        cardToShow.classList.add('active');
    }

    // 5. Aktifkan tombol tab yang diklik
    evt.target.classList.add('active');
}

// ===================================
// GLOBAL VARIABLES & SETUP
// ===================================

let instanceCounter = 0;
let activeInstanceIndex = 0; // 0-based index
const slideTrack = document.getElementById('slideTrack');
const maxBox = 12; // Maksimal kolom hitungan per sesi
let autoSaveTimeout;
const LOCAL_STORAGE_KEY = 'shrimpCountData_v4';
// [PATCH] Kunci untuk keranjang sampah
const TRASH_STORAGE_KEY = 'shrimpCountData_v4_TRASH'; 

// Database Sopir
const sopirDB = {
  "Didi": { "nohp": "085351360595", "plat": "DK 8656 UE" },
  "Yandi": { "nohp": "081236248730", "plat": "DK 8252 UB" },
  "Suharsono": { "nohp": "081399102754", "plat": "DK 8250 UB" },
  "Rusdiana": { "nohp": "081287812738", "plat": "DK 8040 UD" },
  "Yana": { "nohp": "082146659061", "plat": "DK 8655 UE" },
  "Rizki": { "nohp": "081398994440", "plat": " DK 8995 UE" },
  "Ruksin": { "nohp": "081246101708", "plat": "DK 8079 UD" },
  "Dian": { "nohp": "082340074446", "plat": "DK 8079 UF" },
  "Anggi": { "nohp": "082169656871", "plat": "DK 8043 UD" },
  "Frendi": { "nohp": "082278912811", "plat": "DK 8078 UC" },
  "Asep Satria": { "nohp": "081337045654", "plat": "DK 8230 UB" },
  "M. Soleh": { "nohp": "082145810407", "plat": "DK 8996 UE" },
  "Awaludin": { "nohp": "085333533892", "plat": "DK 8580 VB" },
  "Yusup": { "nohp": "08881722094", "plat": "DK 8115 YU" },
  "Sidik": { "nohp": "082146807407", "plat": "DK 8745 VU" },
  "Romli": { "nohp": "082174445127", "plat": "DK 8945 VA" },
  "Anang": { "nohp": "085860259512", "plat": "DK 8349 VA" },
  "Sulaeman": { "nohp": "081337611536", "plat": "DK 8459 UZ" },
  "Jenal": { "nohp": "082127741992", "plat": "DK 8177 VU" }
};

/**
 * [PERBAIKAN ANDROID] Helper function untuk parsing angka yang aman.
 */
function safeParseFloat(value) {
    if (typeof value !== 'string') {
        value = String(value);
    }
    const cleanValue = value.replace(',', '.');
    return parseFloat(cleanValue) || 0;
}

// ===================================
// DARK MODE LOGIC
// ===================================
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDarkMode = document.body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isDarkMode);
    document.getElementById('darkModeToggle').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
}
function checkDarkModePreference() {
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeToggle').textContent = '‚òÄÔ∏è';
    } else {
        document.getElementById('darkModeToggle').textContent = 'üåô';
    }
}

// === Auto-Save Logic ===
function triggerAutoSave(instanceId) {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
        saveData(instanceId, true);
    }, 1500);
}

// ===================================
// TEMPLATE & CAROUSEL LOGIC
// ===================================
function createInstanceHTML(id) {
    const instanceId = `instance_${id}`;
    const templateHTML = document.getElementById('panen-template').innerHTML;
    const finalHTML = templateHTML
        .replace(/{{INSTANCE_ID}}/g, instanceId)
        .replace(/{{ID}}/g, id);
    return finalHTML;
}

function updateCarouselControls() {
    const total = slideTrack.children.length;
    const indicatorText = `${activeInstanceIndex + 1} / ${total}`;
    
    document.getElementById('floatingIndicator').textContent = indicatorText;
    document.getElementById('floatingPrevBtn').disabled = (activeInstanceIndex <= 0);
    document.getElementById('floatingNextBtn').disabled = (activeInstanceIndex >= total - 1);
    document.getElementById('floatingNavCenter').style.display = (total > 1) ? 'flex' : 'none';

    const currentInstance = slideTrack.children[activeInstanceIndex];
    if (currentInstance) {
        const removeBtn = currentInstance.querySelector('.remove-btn');
        if (removeBtn) {
            removeBtn.disabled = (total <= 1);
        }
    }
}

function goToSlide(index) {
    const total = slideTrack.children.length;
    if (index >= 0 && index < total) {
        activeInstanceIndex = index;
        const offset = -activeInstanceIndex * 100;
        slideTrack.style.transform = `translateX(${offset}%)`;
        updateCarouselControls();
    }
}

function addInstance() {
    instanceCounter++;
    const newInstanceHTML = createInstanceHTML(instanceCounter);
    slideTrack.insertAdjacentHTML('beforeend', newInstanceHTML);
    const instanceId = `instance_${instanceCounter}`;
    
    populateDriverOptions(instanceId);
    updateTruckDetails(instanceId);
    initBoxesTester(instanceId); 
    addHitunganSession(instanceId); 
    addHitunganSession(instanceId); 
    updateRecap(instanceId);

    if (arguments.length === 0) { // Hanya pindah slide jika ini adalah panggilan manual (bukan load)
        goToSlide(instanceCounter - 1);
    }
}

function removeInstance() {
    const total = slideTrack.children.length;
    if (total <= 1) {
        alert("Tidak bisa menghapus! Minimal harus ada 1 Data Panen.");
        return;
    }

    if (!confirm(`Hapus Data Panen ${activeInstanceIndex + 1}? Data akan dipindah ke Keranjang Sampah.`)) return;

    const slideToRemove = slideTrack.children[activeInstanceIndex];
    const removedInstanceId = slideToRemove.id;
    const removedStorageKey = `${LOCAL_STORAGE_KEY}_${removedInstanceId}`;

    // --- LOGIKA KERANJANG SAMPAH ---
    try {
        const dataString = localStorage.getItem(removedStorageKey);
        if (dataString) {
            const dataObject = JSON.parse(dataString);
            dataObject._trashInfo = {
                customer: dataObject.customer || "Tanpa Nama",
                deletedOn: new Date().toISOString()
            };
            const trashRaw = localStorage.getItem(TRASH_STORAGE_KEY);
            let trashArray = [];
            if (trashRaw) {
                try { trashArray = JSON.parse(trashRaw); } catch(e) { trashArray = []; }
            }
            trashArray.unshift(dataObject);
            localStorage.setItem(TRASH_STORAGE_KEY, JSON.stringify(trashArray));
        }
    } catch (e) {
        console.error("Gagal menyimpan data ke keranjang sampah:", e);
        alert("Peringatan: Gagal memindahkan data ke keranjang sampah. Data mungkin hilang permanen.");
    }
    // --- AKHIR LOGIKA ---

    slideTrack.removeChild(slideToRemove);
    try {
        localStorage.removeItem(removedStorageKey);
    } catch (e) {
        console.warn(`Gagal menghapus data localStorage untuk ${removedInstanceId}`, e);
    }

    if (activeInstanceIndex > 0) {
        activeInstanceIndex--;
    }

    // Re-ID semua instance
    for (let i = 0; i < slideTrack.children.length; i++) {
        const item = slideTrack.children[i];
        const newIdNumber = i + 1;
        const oldIdNumberText = item.id.split('_')[1];
        if (!oldIdNumberText) continue; // Safety check
        const oldIdNumber = parseInt(oldIdNumberText);
        
        if (oldIdNumber !== newIdNumber) {
            const newInstanceId = `instance_${newIdNumber}`;
            const oldInstanceId = `instance_${oldIdNumber}`;
            const oldStorageKey = `${LOCAL_STORAGE_KEY}_${oldInstanceId}`;
            const newStorageKey = `${LOCAL_STORAGE_KEY}_${newInstanceId}`;

            // Pindahkan data di localStorage
            try {
                const dataToMove = localStorage.getItem(oldStorageKey);
                if (dataToMove) {
                    localStorage.setItem(newStorageKey, dataToMove);
                    localStorage.removeItem(oldStorageKey);
                }
            } catch (e) {
                 console.warn(`Gagal me-rename localStorage dari ${oldStorageKey} ke ${newStorageKey}`, e);
            }

            // Update DOM id dan HTML
            item.id = newInstanceId;
            let newHTML = item.innerHTML.replace(new RegExp(oldInstanceId, 'g'), newInstanceId);
            newHTML = newHTML.replace(new RegExp(`Data Panen ${oldIdNumber}`, 'g'), `Data Panen ${newIdNumber}`);
            newHTML = newHTML.replace(new RegExp(`Rekap Panen ${oldIdNumber}`, 'g'), `Rekap Panen ${newIdNumber}`);
            item.innerHTML = newHTML;
            
            // PENTING: Muat ulang data ke DOM yang baru di-rename
            loadData(newInstanceId, true); // true = silent
            
            // Re-attach event listener (jika ada yang hilang)
            const oldRemoveBtn = item.querySelector(`[id^="${oldInstanceId}_removeBtn"]`);
            if(oldRemoveBtn) oldRemoveBtn.id = `${newInstanceId}_removeBtn`;
        }
    }
    
    instanceCounter = slideTrack.children.length;
    goToSlide(activeInstanceIndex); 
}
// ===================================
// GENERAL HELPER FUNCTIONS
// ===================================
function getEl(instanceId, id) {
    return document.getElementById(`${instanceId}_${id}`);
}

function populateDriverOptions(instanceId) {
    const selectEl = getEl(instanceId, 'driver');
    if (!selectEl) return;
    selectEl.innerHTML = '<option value="">--- Pilih Sopir ---</option>';
    const sortedDrivers = Object.keys(sopirDB).sort();
    sortedDrivers.forEach(driverName => {
        const option = document.createElement('option');
        option.value = driverName;
        option.textContent = driverName;
        selectEl.appendChild(option);
    });
}

function updateDriverDetails(instanceId) {
    const driverSelect = getEl(instanceId, 'driver');
    const platInput = getEl(instanceId, 'platNomor');
    if (!driverSelect || !platInput) return; // Safety check
    const driverName = driverSelect.value;
    if (driverName && sopirDB[driverName]) {
        platInput.value = sopirDB[driverName].plat.trim();
    } else {
        platInput.value = '';
    }
    updateRecap(instanceId);
}

function resetCard1(instanceId) {
    if (!confirm(`Reset semua DATA PANEN (Kartu 1) untuk slide ini?`)) return;
    getEl(instanceId, 'line').value = '';
    getEl(instanceId, 'customer').value = '';
    getEl(instanceId, 'tujuan').value = '';
    getEl(instanceId, 'nominalOrder').value = '0';
    getEl(instanceId, 'jenisTruk').value = 'Euro2';
    getEl(instanceId, 'driver').selectedIndex = 0;
    getEl(instanceId, 'platNomor').value = '';
    updateTruckDetails(instanceId);
    recalcAllHitungan(instanceId);
    recalcAllTester(instanceId);
}

function updateTruckDetails(instanceId){
  const j=getEl(instanceId, 'jenisTruk').value;
  const i=getEl(instanceId, 'isiBox');
  const k=getEl(instanceId, 'kapasitasAngkut');
  if(j.includes('Euro2')){i.value=2;k.value=240;}
  else if(j.includes('Euro4')){i.value=2;k.value=258;}
  else if(j.includes('Bandara')){i.value=6;k.value=120;}
  else {i.value='';k.value='';}
  updateRecap(instanceId);
}
function timestampNow(instanceId, elementId){
  const el = getEl(instanceId, elementId);
  if (!el) return;
  const d=new Date();
  const opt={day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'};
  el.textContent='üïí Terakhir diperbarui: '+d.toLocaleString('id-ID',opt);
}
function getDensityDivisor(instanceId) {
    const jenisTrukEl = getEl(instanceId, 'jenisTruk');
    if (!jenisTrukEl) return 5; // Default
    const jenis = jenisTrukEl.value.toLowerCase();
    return jenis.includes('bandara') ? 3 : 5;
}
function formatCurrency(input) {
    let value = input.value.replace(/\./g, '');
    if (value) { input.value = parseFloat(value).toLocaleString('id-ID'); }
}
function roundToNearestTen(num) {
    if (typeof num !== 'number') return 0;
    return Math.round(num / 10) * 10;
}

// ===================================
// CARD 2: TESTER LOGIC
// ===================================
function recalcAllTester(instanceId){
  const gridTester = getEl(instanceId, 'hitGridTester');
  const sumTesterEl = getEl(instanceId, 'testerSum');
  const densTesterEl = getEl(instanceId, 'testerDensity');
  const allowanceInput = getEl(instanceId, 'allowanceTester');
  const finalResultEl = getEl(instanceId, 'finalTesterResult');
  // Safety checks
  if (!gridTester || !sumTesterEl || !densTesterEl || !allowanceInput || !finalResultEl) return;
  
  const vals=[...gridTester.querySelectorAll('input')].map(i=>safeParseFloat(i.value));
  const s=vals.reduce((a,b)=>a+b,0);
  sumTesterEl.textContent=s.toLocaleString();
  let div=getDensityDivisor(instanceId);
  densTesterEl.textContent=(s?Math.round(s/div):'-').toLocaleString();
  const allowancePercent = safeParseFloat(allowanceInput.value) / 100;
  let finalBenurTester = 0;
  if (s > 0) {
      finalBenurTester = Math.round(s * (1 - allowancePercent));
  }
  finalResultEl.textContent = finalBenurTester.toLocaleString();
  const estimasiBoxEl = getEl(instanceId, 'estimasiBoxTester');
  const nominalOrderEl = getEl(instanceId, 'nominalOrder');
  const isiBoxEl = getEl(instanceId, 'isiBox');
  if (!estimasiBoxEl || !nominalOrderEl || !isiBoxEl) return;

  const nominalText = nominalOrderEl.value.replace(/\./g,'');
  const nominalOrderEkor = parseFloat(nominalText)||0;
  const isiBox = parseFloat(isiBoxEl.value)||0;
  let estimasiBox = 0;
  if (nominalOrderEkor > 0 && finalBenurTester > 0 && isiBox > 0) {
      estimasiBox = Math.ceil(nominalOrderEkor / finalBenurTester / isiBox);
  }
  estimasiBoxEl.textContent = estimasiBox.toLocaleString() + ' Box';
  timestampNow(instanceId, 'testerTimestamp');
  updateRecap(instanceId);
  triggerAutoSave(instanceId);
}
function initBoxesTester(instanceId){
    const gridTester = getEl(instanceId, 'hitGridTester');
    if (!gridTester) return; // Safety check
    gridTester.innerHTML=''; // Kosongkan dulu
    for(let i=0;i<8;i++){
        const box=document.createElement('div');box.className='calc-box';
        const input=document.createElement('input');input.type='number';input.placeholder='0';
        input.oninput=() => recalcAllTester(instanceId);
        box.appendChild(input);
        gridTester.appendChild(box);
    }
}
function resetTester(instanceId){
  if(!confirm('Reset semua input Hitungan Tester untuk Data Panen ini?'))return;
  getEl(instanceId, 'nomorBak').value='';
  getEl(instanceId, 'tomota').value='';
  getEl(instanceId, 'allowanceTester').value='0';
  initBoxesTester(instanceId);
  recalcAllTester(instanceId);
}

// ===================================
// CARD 3 & 4: HITUNGAN MULTI SESI LOGIC
// ===================================
let sessionCounter = {};
function recalcSession(instanceId, sessionId) {
    const grid = document.getElementById(`${instanceId}_sessionGrid${sessionId}`);
    const sumEl = document.getElementById(`${instanceId}_sessionSum${sessionId}`);
    if (!grid || !sumEl) return; // Safety check
    const vals = [...grid.querySelectorAll('input')].map(i => safeParseFloat(i.value));
    const s = vals.reduce((a,b)=>a+b,0);
    sumEl.innerHTML = s.toLocaleString('id-ID');
}

/**
 * [BARU] Menampilkan/menyembunyikan input override manual
 */
function toggleManualBenurInput(instanceId) {
    const toggle = getEl(instanceId, 'manualBenurToggle');
    const inputRow = getEl(instanceId, 'manualBenurInputRow');
    if (!toggle || !inputRow) return;
    
    if (toggle.checked) {
        inputRow.style.display = 'flex';
    } else {
        inputRow.style.display = 'none';
        // Jika toggle dimatikan, hapus nilainya dan hitung ulang
        clearManualBenur(instanceId, true); // true = silent (jangan panggil recalcDuaKali)
    }
    // Hitung ulang setelah UI diubah
    recalcAllHitungan(instanceId);
}

/**
 * [MODIFIKASI] Menghapus override manual benur/kantong
 */
function clearManualBenur(instanceId, silent = false) {
    const manualInput = getEl(instanceId, 'manualBenurOverride');
    if (manualInput) {
        manualInput.value = '';
    }
    
    // [BARU] Juga matikan toggle-nya
    const manualToggle = getEl(instanceId, 'manualBenurToggle');
    if (manualToggle) {
        manualToggle.checked = false;
    }
    
    // [BARU] Sembunyikan lagi input row
    const inputRow = getEl(instanceId, 'manualBenurInputRow');
     if (inputRow) {
        inputRow.style.display = 'none';
    }

    if (!silent) {
        recalcAllHitungan(instanceId); // Hitung ulang
    }
}

/**
 * [PEROMBAKAN TOTAL V5.2] Fungsi recalcAllHitungan dengan logika simulasi stabil
 */
function recalcAllHitungan(instanceId) {
    // --- Bagian 1: Kumpulkan Semua Data Input ---
    const multiSessionGrid = getEl(instanceId, 'multiSessionGrid');
    if (!multiSessionGrid) return; // Safety check utama
    
    const sessions = multiSessionGrid.querySelectorAll('.hit-session');
    let totalSum = 0;
    let validSessions = 0;
    sessions.forEach(session => {
        const sessionId = session.dataset.sessionId;
        recalcSession(instanceId, sessionId);
        const sumTextEl = document.getElementById(`${instanceId}_sessionSum${sessionId}`);
        if(sumTextEl) {
            const sumText = sumTextEl.textContent.replace(/\./g,'');
            const sumVal = parseFloat(sumText)||0;
            if (sumVal > 0) {
                totalSum += sumVal;
                validSessions++;
            }
        }
    });
    const averageSum = validSessions > 0 ? totalSum / validSessions : 0;
    const avgRounded = Math.round(averageSum);
    
    const nominalOrderEl = getEl(instanceId, 'nominalOrder');
    const isiBoxEl = getEl(instanceId, 'isiBox');
    const kapasitasAngkutEl = getEl(instanceId, 'kapasitasAngkut');
    const allowance1El = getEl(instanceId, 'allowance1');
    const allowance2El = getEl(instanceId, 'allowance2');
    const orderDisplayEl = getEl(instanceId, 'orderDisplay');
    const avgValueDisplayEl = getEl(instanceId, 'avgValueDisplay');

    if (!nominalOrderEl || !isiBoxEl || !kapasitasAngkutEl || !allowance1El || !allowance2El || !orderDisplayEl || !avgValueDisplayEl) {
        console.error(`[${instanceId}] Error: Elemen input dasar tidak ditemukan.`);
        return;
    }

    const nominalText = nominalOrderEl.value.replace(/\./g,'');
    const nominalOrderEkor = parseFloat(nominalText)||0;
    const isiBox = parseFloat(isiBoxEl.value)||0;
    const kapasitasAngkut = parseFloat(kapasitasAngkutEl.value)||0;
    const allowance1Input = safeParseFloat(allowance1El.value);
    const allowance2Input = safeParseFloat(allowance2El.value);
    const allowance1 = allowance1Input / 100;
    const allowance2 = allowance2Input / 100;
    
    orderDisplayEl.textContent = nominalOrderEkor.toLocaleString();
    avgValueDisplayEl.textContent = avgRounded.toLocaleString() + ' ekor';

    // --- Bagian 2: Tentukan Nilai Benur/Kantong MURNI (Tahap 1) ---
    const calculatedBenur_Real_Murni = roundToNearestTen(avgRounded * (1 - allowance1));
    
    let kebutuhanBox_Murni = 0;
    if (nominalOrderEkor > 0 && calculatedBenur_Real_Murni > 0 && isiBox > 0) {
        kebutuhanBox_Murni = Math.ceil(nominalOrderEkor / calculatedBenur_Real_Murni / isiBox);
    }

    const isOverCapacity = (kebutuhanBox_Murni > kapasitasAngkut) && (kapasitasAngkut > 0);
    const limitKapasitasToggle = getEl(instanceId, 'limitKapasitasToggle');
    const limitKapasitas = limitKapasitasToggle && limitKapasitasToggle.checked && isOverCapacity;
    
    let kebutuhanBox_Terbatas = kebutuhanBox_Murni;
    let benurPerKantong_SimulasiOverCapacity = 0;
    let simulationNeeded = false;

    if (limitKapasitas) {
        simulationNeeded = true;
        kebutuhanBox_Terbatas = kapasitasAngkut; 
        const simulasiTotalKantong = kapasitasAngkut * isiBox;
        if (simulasiTotalKantong > 0) {
            benurPerKantong_SimulasiOverCapacity = roundToNearestTen(nominalOrderEkor / simulasiTotalKantong);
        }
    }

    const kebutuhanBoxEl = getEl(instanceId, 'kebutuhanBox');
    if (kebutuhanBoxEl) {
        kebutuhanBoxEl.textContent = kebutuhanBox_Terbatas.toLocaleString() + (limitKapasitas ? ' Box (MAX)' : ' Box');
    }
    
    const simulasiBoxRow = getEl(instanceId, 'simulasiBoxRow');
    if (simulasiBoxRow) {
        if (simulationNeeded) {
            simulasiBoxRow.style.display = 'flex';
            getEl(instanceId, 'simulasiBoxReal').textContent = benurPerKantong_SimulasiOverCapacity.toLocaleString() + ' ekor/kantong';
        } else {
            simulasiBoxRow.style.display = 'none';
        }
    }
    
    const benurPerKantong_Real_Dasar = simulationNeeded ? benurPerKantong_SimulasiOverCapacity : calculatedBenur_Real_Murni;

    // --- Bagian 3: Tentukan Nilai Benur/Kantong FINAL (Tahap 2) ---
    const manualBenurToggle = getEl(instanceId, 'manualBenurToggle');
    const manualBenurInput = getEl(instanceId, 'manualBenurOverride');
    const manualBenurValue = manualBenurInput ? safeParseFloat(manualBenurInput.value) : 0;
    const useManualBenurToggle = manualBenurToggle && manualBenurToggle.checked;

    const simulasiSelisihToggle = getEl(instanceId, 'simulasiToggle');
    const useSimulasiSelisih = simulasiSelisihToggle && simulasiSelisihToggle.checked;
    
    let benurPerKantong_Real_Final = 0;
    let usingManualBenur = false;
    let usingSimulasiSelisih = false;
    let selisihSimulasiValue = 0; // Akan diisi nanti

    // Prioritas 1: Manual Override
    if (useManualBenurToggle && manualBenurValue > 0) {
        benurPerKantong_Real_Final = manualBenurValue;
        usingManualBenur = true;
    } else {
        // Prioritas 2 & 3: Simulasi atau Dasar (akan ditentukan di Bagian 4)
        benurPerKantong_Real_Final = benurPerKantong_Real_Dasar; // Default ke dasar
    }
    
    // --- Bagian 4: Hitung Selisih & Tentukan Nilai Simulasi (Tahap 3) ---
    // [PERBAIKAN V5.2] Logika ini sekarang berjalan SETELAH nilai dasar/manual ditentukan
    const selisihBoxEl = getEl(instanceId, 'selisihBox');
    const totalPackingEl = getEl(instanceId, 'selisih_totalPacking');
    const selisihOrderEl = getEl(instanceId, 'selisih_selisihOrder');
    const selisihWarningBox = getEl(instanceId, 'selisihWarningBox');
    const selisihFinalResultEl = getEl(instanceId, 'selisihFinalResult');

    if (selisihBoxEl && totalPackingEl && selisihOrderEl && kebutuhanBox_Terbatas > 0 && isiBox > 0) {
        
        // (A) Hitung selisih "murni" (tanpa toggle simulasi)
        const totalPacking_Murni = kebutuhanBox_Terbatas * isiBox * benurPerKantong_Real_Dasar;
        const selisihOrder_Murni = totalPacking_Murni - nominalOrderEkor;
        
        const batasWajar = nominalOrderEkor * 0.001; 

        // [PERBAIKAN LOGIKA V5.2] Hanya tampilkan box simulasi jika:
        // 1. TIDAK pakai manual override
        // 2. Selisihnya POSITIF
        // 3. Selisihnya > 0.1%
        if (selisihWarningBox && !usingManualBenur && selisihOrder_Murni > batasWajar && nominalOrderEkor > 0) {
            
            // Hitung nilai target simulasi
            const targetTotalPacking = nominalOrderEkor * 1.001; // Target +0.1%
            const newBenurPerKantong = targetTotalPacking / kebutuhanBox_Terbatas / isiBox;
            selisihSimulasiValue = roundToNearestTen(newBenurPerKantong); // Simpan nilai simulasi

            // [PERBAIKAN LOGIKA V5.2] Sembunyikan box jika nilainya sudah sama
            if (benurPerKantong_Real_Dasar === selisihSimulasiValue) {
                 selisihWarningBox.style.display = 'none';
                 if (simulasiSelisihToggle) simulasiSelisihToggle.checked = false;
            } else {
                selisihWarningBox.style.display = 'block';
                if(selisihFinalResultEl) selisihFinalResultEl.textContent = selisihSimulasiValue.toLocaleString('id-ID') + ' ekor/kantong';
            
                const newTotalPacking = kebutuhanBox_Terbatas * isiBox * selisihSimulasiValue;
                const newSelisih = newTotalPacking - nominalOrderEkor;
                const selisihSimulasiResultEl = getEl(instanceId, 'selisihSimulasiResult');
                if (selisihSimulasiResultEl) {
                    selisihSimulasiResultEl.textContent = 'Estimasi Selisih Baru: ' + (newSelisih >= 0 ? '+' : '') + newSelisih.toLocaleString('id-ID') + ' ekor';
                }
            }
            
            // (B) Cek apakah simulasi harus diterapkan
            if (useSimulasiSelisih && selisihSimulasiValue > 0) {
                 benurPerKantong_Real_Final = selisihSimulasiValue; // Terapkan nilai simulasi
                 usingSimulasiSelisih = true;
            }

        } else if (selisihWarningBox) {
            selisihWarningBox.style.display = 'none';
            if (simulasiSelisihToggle) simulasiSelisihToggle.checked = false;
        }

        // (C) Hitung Total Packing FINAL (berdasarkan nilai final)
        const totalPacking_Final = kebutuhanBox_Terbatas * isiBox * benurPerKantong_Real_Final;
        const selisihOrder_Final = totalPacking_Final - nominalOrderEkor;
        
        // [PERBAIKAN LOGIKA 1] Tampilkan Selisih FINAL
        totalPackingEl.textContent = totalPacking_Final.toLocaleString('id-ID') + ' ekor';
        selisihOrderEl.textContent = (selisihOrder_Final >= 0 ? '+' : '') + selisihOrder_Final.toLocaleString('id-ID') + ' ekor';
        selisihOrderEl.classList.toggle('positive', selisihOrder_Final >= 0);
        selisihOrderEl.classList.toggle('negative', selisihOrder_Final < 0);
        selisihBoxEl.style.display = 'block'; 

    } else if (selisihBoxEl) {
        selisihBoxEl.style.display = 'none'; 
        if (selisihWarningBox) selisihWarningBox.style.display = 'none';
        if (simulasiSelisihToggle) simulasiSelisihToggle.checked = false;
    }
    
    // --- Bagian 5: Hitung Nilai SJ FINAL & Tampilkan ---
    const sjAdjustment = benurPerKantong_Real_Final * allowance2;
    const benurPerKantong_SJ_Final = roundToNearestTen(benurPerKantong_Real_Final - sjAdjustment);
    
    const realDisplayEl = getEl(instanceId, 'benurPerKantongReal');
    const sjDisplayEl = getEl(instanceId, 'benurPerKantongSJ');
    
    if(realDisplayEl) {
        const span = realDisplayEl.querySelector('span');
        if (span) span.textContent = benurPerKantong_Real_Final.toLocaleString();
    }
    if(sjDisplayEl) {
        const span = sjDisplayEl.querySelector('span');
        if (span) span.textContent = benurPerKantong_SJ_Final.toLocaleString();
    }
    
    const sjRow = getEl(instanceId, 'benurPerKantongSJBox');
    if (allowance2Input > 0) {
        if(sjRow) sjRow.style.display = 'block';
    } else {
        if(sjRow) sjRow.style.display = 'none';
    }

    // --- Bagian 6: Styling Box Hasil ---
    const realDisplayBox = getEl(instanceId, 'benurPerKantongRealBox');
    const sjDisplayBox = getEl(instanceId, 'benurPerKantongSJBox');

    let highlightFont = usingManualBenur || simulationNeeded || usingSimulasiSelisih;
    let highlightBg = usingManualBenur || simulationNeeded;

    if (realDisplayBox && realDisplayEl) {
        realDisplayEl.style.color = highlightFont ? 'var(--color-alert-text)' : 'var(--color-text-sum)';
        realDisplayBox.style.background = highlightBg ? 'var(--color-card-tester)' : 'var(--color-tester-result-bg)';
        const realLabel = realDisplayBox.querySelector('.label');
        if(realLabel) realLabel.style.color = highlightFont ? 'var(--color-alert-text)' : 'var(--color-tester-result-text)';
    }
    if (sjDisplayBox && sjDisplayEl) {
        sjDisplayEl.style.color = highlightFont ? 'var(--color-alert-text)' : 'var(--color-accent)';
        sjDisplayBox.style.background = highlightBg ? 'var(--color-card-tester)' : 'var(--color-card-bg)';
        const sjLabel = sjDisplayBox.querySelector('.label');
        if(sjLabel) sjLabel.style.color = highlightFont ? 'var(--color-alert-text)' : 'var(--color-accent)';
    }
    
    timestampNow(instanceId, 'hitunganTimestamp');
    updateRecap(instanceId);
    triggerAutoSave(instanceId);
}
function toggleSimulasiUsage(instanceId) {
    recalcAllHitungan(instanceId);
}
function addHitunganSession(instanceId) {
    const multiSessionGrid = getEl(instanceId, 'multiSessionGrid');
    if (!multiSessionGrid) return; // Safety check
    if (!sessionCounter[instanceId]) {
        sessionCounter[instanceId] = 0;
    }
    sessionCounter[instanceId]++;
    const sessionId = sessionCounter[instanceId];
    const newSession = document.createElement('div');
    newSession.className = 'hit-session';
    newSession.dataset.sessionId = sessionId;
    newSession.innerHTML = `
        <div class="session-summary">
            <span class="session-label">Hitungan ${sessionId}:</span>
            <span class="results">
                Œ£ <span id="${instanceId}_sessionSum${sessionId}" class="sum-value">0</span>
            </span>
        </div>
        <div id="${instanceId}_sessionGrid${sessionId}" class="hit-grid"></div>
    `;
    multiSessionGrid.appendChild(newSession);
    
    // Buat grid untuk sesi baru
    const grid = document.getElementById(`${instanceId}_sessionGrid${sessionId}`);
    for (let i = 0; i < 8; i++) {
        const box = document.createElement('div');
        box.className = 'calc-box';
        const input = document.createElement('input');
        input.type = 'number';
        input.placeholder = '0';
        input.oninput = function() { recalcSession(instanceId, sessionId); recalcAllHitungan(instanceId); };
        box.appendChild(input);
        grid.appendChild(box);
    }
    recalcAllHitungan(instanceId);
}
function removeHitunganSession(instanceId) {
    const multiSessionGrid = getEl(instanceId, 'multiSessionGrid');
    if (!multiSessionGrid) return;
    const sessions = multiSessionGrid.querySelectorAll('.hit-session');
    if (sessions.length > 0) {
        sessions[sessions.length - 1].remove();
    }
    recalcAllHitungan(instanceId);
}
function resetHitungan(instanceId) {
    if (!confirm('Reset semua input Hitungan, Allowance, dan Override untuk Data Panen ini?')) return;
    const multiSessionGrid = getEl(instanceId, 'multiSessionGrid');
    if(multiSessionGrid) multiSessionGrid.innerHTML = '';
    sessionCounter[instanceId] = 0;
    addHitunganSession(instanceId);
    addHitunganSession(instanceId);
    getEl(instanceId, 'allowance1').value = '0';
    getEl(instanceId, 'allowance2').value = '0';
    
    const simulasiToggle = getEl(instanceId, 'simulasiToggle');
    if (simulasiToggle) simulasiToggle.checked = false;
    
    clearManualBenur(instanceId, true); // true = silent
    recalcAllHitungan(instanceId);
}
addCalcBox = (fullGridId) => {
    const parts = fullGridId.split('_');
    const instanceId = parts[0] + '_' + parts[1];
    const gridType = parts[2];
    const grid = document.getElementById(fullGridId);
    if (!grid) return; // Safety check
    
    const c=grid.querySelectorAll('.calc-box').length;
    if(gridType === 'hitGridTester' && c>=maxBox){alert('Maks '+maxBox+' kolom per sesi.');return;}

    if (gridType === 'hitGridTester') {
        const box=document.createElement('div');box.className='calc-box';
        const input=document.createElement('input');input.type='number';input.placeholder='0';
        input.oninput = () => recalcAllTester(instanceId);
        box.appendChild(input);
        grid.appendChild(box);
    } else if (gridType === 'multiSessionGrid') {
        const sessions = grid.querySelectorAll('.hit-session');
        if (sessions.length === 0) { alert('Tambahkan Baris Hitungan terlebih dahulu.'); return; }
        // Cek kolom di sesi pertama
        const firstSessionGrid = sessions[0].querySelector('.hit-grid');
        if (firstSessionGrid && firstSessionGrid.querySelectorAll('.calc-box').length >= maxBox) {
             alert('Maks '+maxBox+' kolom per sesi.');return;
        }
        
        sessions.forEach(session => {
            const sessionId = session.dataset.sessionId;
            const sessionGrid = document.getElementById(`${instanceId}_sessionGrid${sessionId}`);
            if (sessionGrid) {
                const newBox = document.createElement('div');
                newBox.className = 'calc-box';
                const newInput = document.createElement('input');
                newInput.type = 'number';
                newInput.placeholder = '0';
                newInput.oninput = () => { recalcSession(instanceId, sessionId); recalcAllHitungan(instanceId); };
                newBox.appendChild(newInput);
                sessionGrid.appendChild(newBox);
            }
        });
        recalcAllHitungan(instanceId); // Pindah ke sini
    }
};
removeCalcBox = (fullGridId) => {
    const parts = fullGridId.split('_');
    const instanceId = parts[0] + '_' + parts[1];
    const gridType = parts[2];
    const grid = document.getElementById(fullGridId);
    if (!grid) return; // Safety check
    
    let shouldRecalc = false;
    if (gridType === 'hitGridTester') {
        const b=grid.querySelectorAll('.calc-box');
        if(b.length){b[b.length-1].remove(); shouldRecalc = true;}
        if (shouldRecalc) recalcAllTester(instanceId);
    } else if (gridType === 'multiSessionGrid') {
        const sessions = grid.querySelectorAll('.hit-session');
        if (sessions.length === 0) return;
        sessions.forEach(session => {
            const sessionId = session.dataset.sessionId;
            const sessionGrid = document.getElementById(`${instanceId}_sessionGrid${sessionId}`);
            if (sessionGrid) {
                const b = sessionGrid.querySelectorAll('.calc-box');
                if (b.length > 0) {
                    b[b.length-1].remove();
                    recalcSession(instanceId, sessionId);
                    shouldRecalc = true;
                }
            }
        });
        if (shouldRecalc) {
            recalcAllHitungan(instanceId);
        }
    }
};


// ===================================
// CARD 5: REKAP LOGIC
// ===================================
function updateRecap(instanceId) {
    const setRecap = (targetId, sourceEl, isInput = true, fallback = '-', suffix = '') => {
        if (!sourceEl) {
             const elFallback = getEl(instanceId, targetId);
             if (elFallback) elFallback.textContent = fallback + suffix;
             return;
        }
        const val = isInput ? sourceEl.value : sourceEl.textContent;
        const el = getEl(instanceId, targetId);
        if (el) {
            el.textContent = (val || fallback) + suffix;
        }
    };
    setRecap('recap_customer', getEl(instanceId, 'customer'));
    setRecap('recap_tujuan', getEl(instanceId, 'tujuan'));
    setRecap('recap_line', getEl(instanceId, 'line'));
    setRecap('recap_driver', getEl(instanceId, 'driver'));
    setRecap('recap_platNomor', getEl(instanceId, 'platNomor'));
    setRecap('recap_orderBenur', getEl(instanceId, 'nominalOrder'), true, '0');
    setRecap('recap_jenisTruk', getEl(instanceId, 'jenisTruk'));
    setRecap('recap_kapasitasAngkut', getEl(instanceId, 'kapasitasAngkut'), true, '0', ' Box');
    setRecap('recap_isiBox', getEl(instanceId, 'isiBox'), true, '0', ' Kantong');
    setRecap('recap_nomorBak', getEl(instanceId, 'nomorBak'));
    setRecap('recap_tomota', getEl(instanceId, 'tomota'), true, '-', ' ekor');
    setRecap('recap_testerSum', getEl(instanceId, 'testerSum'), false, '0');
    setRecap('recap_testerDensity', getEl(instanceId, 'testerDensity'), false, '-');
    setRecap('recap_allowanceTester', getEl(instanceId, 'allowanceTester'), true, '0', ' %');
    setRecap('recap_hasilTester', getEl(instanceId, 'finalTesterResult'), false, '0');
    setRecap('recap_estimasiBoxTester', getEl(instanceId, 'estimasiBoxTester'), false, '0 Box');
    
    const multiSessionGrid = getEl(instanceId, 'multiSessionGrid');
    let sessionHtml = '';
    if (multiSessionGrid) {
        const sessions = multiSessionGrid.querySelectorAll('.hit-session');
        sessions.forEach(session => {
            const labelEl = session.querySelector('.session-label');
            const sumEl = document.getElementById(`${instanceId}_sessionSum${session.dataset.sessionId}`);
            if (labelEl && sumEl) {
                const label = labelEl.textContent.trim();
                const sum = sumEl.textContent.trim();
                sessionHtml += `<div class="recap-row-small"><span class="recap-label">${label}</span><span class="recap-value">Œ£ ${sum}</span></div>`;
            }
        });
    }
    const recapSessionSummaryEl = getEl(instanceId, 'recap_sessionSummary');
    if (recapSessionSummaryEl) {
        recapSessionSummaryEl.innerHTML = sessionHtml || '<div class="recap-row-small"><span class="recap-label">Tidak ada data</span></div>';
    }

    setRecap('recap_avgValue', getEl(instanceId, 'avgValueDisplay'), false);
    const a1El = getEl(instanceId, 'allowance1');
    const a2El = getEl(instanceId, 'allowance2');
    const a1 = a1El ? (a1El.value || '0') : '0';
    const a2 = a2El ? (a2El.value || '0') : '0';
    const recapAllowanceEl = getEl(instanceId, 'recap_allowanceHitung');
    if (recapAllowanceEl) recapAllowanceEl.textContent = `${a1}% / ${a2}%`;
    
    setRecap('recap_kebutuhanBox', getEl(instanceId, 'kebutuhanBox'), false);
    
    // Ambil nilai dari span di dalam div
    const benurRealEl = getEl(instanceId, 'benurPerKantongReal');
    const recapBenurRealEl = getEl(instanceId, 'recap_benurReal');
    if (benurRealEl && recapBenurRealEl) {
        const span = benurRealEl.querySelector('span');
        if (span) {
            recapBenurRealEl.textContent = span.textContent.trim() + ' ekor/kantong';
        }
    }
    
    const sjRow = getEl(instanceId, 'benurPerKantongSJBox');
    const sjRowRecap = getEl(instanceId, 'recap_benurSJ_row');
    if (sjRow && sjRowRecap) {
        if (sjRow.style.display === 'block') {
            const benurSJEl = getEl(instanceId, 'benurPerKantongSJ');
            if (benurSJEl) {
                const span = benurSJEl.querySelector('span');
                if (span) {
                    getEl(instanceId, 'recap_benurSJ').textContent = span.textContent.trim() + ' ekor/kantong';
                }
            }
            sjRowRecap.style.display = 'flex';
        } else {
            sjRowRecap.style.display = 'none';
        }
    }

    const simRow = getEl(instanceId, 'simulasiBoxRow');
    const simRowRecap = getEl(instanceId, 'recap_simulasi_row');
    if (simRow && simRowRecap) {
        if (simRow.style.display === 'flex') {
            setRecap('recap_simulasi', getEl(instanceId, 'simulasiBoxReal'), false);
            simRowRecap.style.display = 'flex';
        } else {
            simRowRecap.style.display = 'none';
        }
    }
    timestampNow(instanceId, 'recapTimestamp');
    triggerAutoSave(instanceId);
}


// ===================================
// CARD 5: SAVE, LOAD, SHARE LOGIC
// ===================================

function saveData(instanceId, silent = false) {
    try {
        const dataToSave = {};
        dataToSave.customer = getEl(instanceId, 'customer').value;
        dataToSave.tujuan = getEl(instanceId, 'tujuan').value;
        dataToSave.line = getEl(instanceId, 'line').value;
        dataToSave.nominalOrder = getEl(instanceId, 'nominalOrder').value;
        dataToSave.jenisTruk = getEl(instanceId, 'jenisTruk').value;
        dataToSave.kapasitasAngkut = getEl(instanceId, 'kapasitasAngkut').value;
        dataToSave.driver = getEl(instanceId, 'driver').value;
        dataToSave.platNomor = getEl(instanceId, 'platNomor').value;
        dataToSave.nomorBak = getEl(instanceId, 'nomorBak').value;
        dataToSave.tomota = getEl(instanceId, 'tomota').value;
        dataToSave.allowanceTester = getEl(instanceId, 'allowanceTester').value;
        
        const testerGridEl = getEl(instanceId, 'hitGridTester');
        if (testerGridEl) {
            dataToSave.testerGrid = [...testerGridEl.querySelectorAll('input')].map(inp => inp.value);
        }
        
        dataToSave.allowance1 = getEl(instanceId, 'allowance1').value;
        dataToSave.allowance2 = getEl(instanceId, 'allowance2').value;
        dataToSave.sessionsGrid = [];
        
        const multiSessionGridEl = getEl(instanceId, 'multiSessionGrid');
        if (multiSessionGridEl) {
            const sessions = multiSessionGridEl.querySelectorAll('.hit-session');
            sessions.forEach(session => {
                const sessionId = session.dataset.sessionId;
                const gridEl = document.getElementById(`${instanceId}_sessionGrid${sessionId}`);
                if (gridEl) {
                    const inputs = [...gridEl.querySelectorAll('input')].map(inp => inp.value);
                    dataToSave.sessionsGrid.push(inputs);
                }
            });
        }
        
        // Simpan juga data toggle/override
        dataToSave.limitKapasitasToggle = getEl(instanceId, 'limitKapasitasToggle').checked;
        dataToSave.manualBenurToggle = getEl(instanceId, 'manualBenurToggle').checked;
        dataToSave.manualBenurOverride = getEl(instanceId, 'manualBenurOverride').value;
        dataToSave.simulasiToggle = getEl(instanceId, 'simulasiToggle').checked;
        
        const storageKey = `${LOCAL_STORAGE_KEY}_${instanceId}`;
        localStorage.setItem(storageKey, JSON.stringify(dataToSave));
        
        if (!silent) {
            alert(`Data Panen ${instanceId.split('_')[1]} disimpan! ‚úÖ`);
        }
    } catch (e) {
        console.error("Gagal menyimpan data:", e);
        if (!silent) {
            alert(`Gagal menyimpan data Panen ${instanceId.split('_')[1]}.`);
        }
    }
}
function loadData(instanceId, silent = false) {
    const storageKey = `${LOCAL_STORAGE_KEY}_${instanceId}`;
    const savedData = localStorage.getItem(storageKey);
    if (!savedData) {
        if (!silent) alert(`Tidak ada data tersimpan untuk Panen ${instanceId.split('_')[1]}. üìÇ`);
        return;
    }
    try {
        const data = JSON.parse(savedData);
        loadDataFromObject(instanceId, data); // Panggil helper
        if (!silent) alert(`Data Panen ${instanceId.split('_')[1]} berhasil dimuat! ‚úÖ`);
    } catch (e) {
        console.error("Gagal memuat data:", e);
        if (!silent) alert(`Gagal memuat data Panen ${instanceId.split('_')[1]}. Data tersimpan mungkin rusak.`);
    }
}

function formatWithDots(num) {
    if (typeof num !== 'number' || isNaN(num)) {
        num = 0;
    }
    return Math.round(num).toLocaleString('id-ID');
}
function reformatDate(dateString) {
    if (!dateString) return '-';
    try {
        const parts = dateString.split('-'); // YYYY-MM-DD
        if (parts.length !== 3) return dateString;
        return `${parts[2]}/${parts[1]}/${parts[0]}`; // DD/MM/YYYY
    } catch (e) {
        return dateString;
    }
}

/**
 * [REVISI] Bagikan rincian ke Customer
 */
function shareToCustomer(instanceId) {
    // 1. Ambil Data Panen
    const customer = getEl(instanceId, 'customer').value || 'Customer';
    const tanggal = reformatDate(getEl(instanceId, 'line').value);
    const tujuan = getEl(instanceId, 'tujuan').value || 'Tujuan';
    const nomorBak = getEl(instanceId, 'nomorBak').value || '-';
    
    // 2. Ambil Data Driver (dari DB dan input)
    const driverName = getEl(instanceId, 'driver').value;
    const driverData = sopirDB[driverName] || { nohp: '-', plat: '-' };
    const driverHP = driverData.nohp;
    const driverPlat = getEl(instanceId, 'platNomor').value || driverData.plat; // Ambil dari input, fallback ke DB

    // 3. Ambil Data Hitungan
    const kebutuhanBoxEl = getEl(instanceId, 'kebutuhanBox');
    const isiBoxEl = getEl(instanceId, 'isiBox');
    const allowance2El = getEl(instanceId, 'allowance2');
    const benurRealEl = getEl(instanceId, 'benurPerKantongReal');
    const benurSJEl = getEl(instanceId, 'benurPerKantongSJ');

    // Safety check jika elemen tidak ada
    if (!kebutuhanBoxEl || !isiBoxEl || !allowance2El || !benurRealEl || !benurSJEl) {
        alert("Error: Elemen hitungan tidak ditemukan. Tidak bisa membagikan data.");
        return;
    }

    const boxText = kebutuhanBoxEl.textContent.split(' ')[0];
    const kebutuhanBox = parseFloat(boxText.replace(/[\.,]/g, '')) || 0;
    const isiBox = parseFloat(isiBoxEl.value) || 0;
    const totalKantong = kebutuhanBox * isiBox;
    
    const a2 = parseFloat(allowance2El.value) || 0;
    
    // Ambil nilai dari span
    const benurRealSpan = benurRealEl.querySelector('span');
    const benurSJSpan = benurSJEl.querySelector('span');
    
    if (!benurRealSpan || !benurSJSpan) {
        alert("Error: Elemen nilai <span> tidak ditemukan. Tidak bisa membagikan data.");
        return;
    }
    
    const benurRealText = benurRealSpan.textContent.split(' ')[0];
    const benurReal_Value = parseFloat(benurRealText.replace(/[\.,]/g, '')) || 0;
    
    const benurSJText = benurSJSpan.textContent.split(' ')[0];
    const benurSJ_Value = parseFloat(benurSJText.replace(/[\.,]/g, '')) || 0;

    let text = "Assalamu'alaikum Wr. Wb.\n";
    text += "Berikut kami kirimkan rincian benur kepada:\n";
    text += `${customer}\n`;
    text += `(${tanggal}, ${tujuan})\n\n`;

    if (a2 > 0) {
        // --- [PERBAIKAN LOGIKA] FORMAT JIKA A2 > 0 ---
        const bruto_SJ = totalKantong * benurSJ_Value; 
        const netto_SJ = Math.round(bruto_SJ * 0.9);
        const totalReal = totalKantong * benurReal_Value; 

        text += `${formatWithDots(kebutuhanBox)} Box, ${formatWithDots(totalKantong)} Kantong @${formatWithDots(benurSJ_Value)} Ekor\n`;
        text += `Bruto = ${formatWithDots(bruto_SJ)} (Bak ${nomorBak})\n`;
        text += `Netto = ${formatWithDots(netto_SJ)}\n\n`;
        text += `Hitungan Real:\n`;
        text += `${formatWithDots(kebutuhanBox)} Box, ${formatWithDots(totalKantong)} Kantong @${formatWithDots(benurReal_Value)} ekor = ${formatWithDots(totalReal)}\n\n`;
        
    } else {
        // --- FORMAT STANDAR (A2 = 0) ---
        const bruto = totalKantong * benurReal_Value;
        const netto = Math.round(bruto * 0.9);
        
        text += `${formatWithDots(kebutuhanBox)} Box, ${formatWithDots(totalKantong)} Kantong @${formatWithDots(benurReal_Value)} Ekor\n`;
        text += `Bruto = ${formatWithDots(bruto)} (Bak ${nomorBak})\n`;
        text += `Netto = ${formatWithDots(netto)}\n\n`;
    }

    // 4. Tambah Info Sopir (Sama untuk kedua format)
    text += `Dengan Sopir Bp. ${driverName || '-'}\n`;
    text += `No. Hp = ${driverHP}\n`;
    text += `Plat Mobil = ${driverPlat}\n\n`;
    text += `Terimakasih, Sukses Bersama PLB ü§ù`;

    // 5. Buka WhatsApp
    const encodedText = encodeURIComponent(text);
    window.open(`https://wa.me/?text=${encodedText}`, '_blank');
}

function shareAdmin(instanceId) {
    const customer = getEl(instanceId, 'customer').value || '-';
    const driver = getEl(instanceId, 'driver').value || '-';
    const tujuan = getEl(instanceId, 'tujuan').value || '-';
    const avgAktualEl = getEl(instanceId, 'avgValueDisplay');
    const kebutuhanBoxEl = getEl(instanceId, 'kebutuhanBox');
    const isiBoxEl = getEl(instanceId, 'isiBox');
    const benurRealEl = getEl(instanceId, 'benurPerKantongReal');
    const benurSJEl = getEl(instanceId, 'benurPerKantongSJ');
    const allowance2El = getEl(instanceId, 'allowance2');

    // Safety check
    if (!avgAktualEl || !kebutuhanBoxEl || !isiBoxEl || !benurRealEl || !benurSJEl || !allowance2El) {
        alert("Error: Elemen hitungan tidak ditemukan. Tidak bisa mengirim rincian.");
        return;
    }

    const avgAktualText = avgAktualEl.textContent.replace(' ekor', '').trim();
    const boxText = kebutuhanBoxEl.textContent;
    const boxNumberString = boxText.split(' Box')[0];
    const boxValue = parseFloat(boxNumberString.replace(/\./g, '')) || 0;
    const isiBox = parseFloat(isiBoxEl.value) || 0;
    const totalKantong = (boxValue * isiBox).toLocaleString('id-ID');
    
    // Ambil nilai dari span
    const benurRealSpan = benurRealEl.querySelector('span');
    const benurSJSpan = benurSJEl.querySelector('span');
    
    if (!benurRealSpan || !benurSJSpan) {
        alert("Error: Elemen nilai <span> tidak ditemukan. Tidak bisa mengirim rincian.");
        return;
    }
    
    const benurReal = benurRealSpan.textContent.trim();
    const benurSJ = benurSJSpan.textContent.trim();
    
    const a2 = parseFloat(allowance2El.value) || 0;
    const line1 = `${customer}/${tujuan}`;
    const line2 = `${driver}/Act ${avgAktualText}`;
    const lineReal = `Real: ${boxValue} Box, ${totalKantong} Kantong @${benurReal} Ekor (+1)`;
    const lineRealSimple = `${boxValue} Box, ${totalKantong} Kantong @${benurReal} Ekor (+1)`;
    let text = `${line1}\n${line2}\n\n`;
    if (a2 > 0) {
        const lineSJ = `SJ: ${boxValue} Box, ${totalKantong} Kantong @${benurSJ} Ekor (+1)`;
        text += `${lineReal}\n${lineSJ}`;
    } else {
        text += lineRealSimple;
    }
    const encodedText = encodeURIComponent(text);
    window.open(`https://wa.me/?text=${encodedText}`, '_blank');
}

// ===================================
// IMPORT/EXPORT JSON LOGIC
// ===================================
function loadDataFromObject(instanceId, data) {
    try {
        getEl(instanceId, 'customer').value = data.customer || '';
        getEl(instanceId, 'tujuan').value = data.tujuan || '';
        getEl(instanceId, 'line').value = data.line || '';
        getEl(instanceId, 'nominalOrder').value = data.nominalOrder || '0';
        getEl(instanceId, 'jenisTruk').value = data.jenisTruk || 'Euro2';
        getEl(instanceId, 'kapasitasAngkut').value = data.kapasitasAngkut || '';
        getEl(instanceId, 'driver').value = data.driver || '';
        getEl(instanceId, 'platNomor').value = data.platNomor || '';
        getEl(instanceId, 'nomorBak').value = data.nomorBak || '';
        getEl(instanceId, 'tomota').value = data.tomota || '';
        getEl(instanceId, 'allowanceTester').value = data.allowanceTester || '0';
        
        // Load Grid Tester
        const testerGridEl = getEl(instanceId, 'hitGridTester');
        if (testerGridEl && data.testerGrid) {
            // Hapus grid default (8)
            testerGridEl.innerHTML = ''; 
            // Buat ulang kolom sesuai data
            data.testerGrid.forEach(val => {
                const box = document.createElement('div');
                box.className = 'calc-box';
                const input = document.createElement('input');
                input.type = 'number';
                input.placeholder = '0';
                input.value = val || '';
                input.oninput = () => recalcAllTester(instanceId);
                box.appendChild(input);
                testerGridEl.appendChild(box);
            });
            // Jika data tersimpan < 8, tambahkan sisanya
            const diff = 8 - data.testerGrid.length;
            if (diff > 0) {
                for (let i = 0; i < diff; i++) {
                   addCalcBox(`${instanceId}_hitGridTester`);
                }
            }
        } else {
            initBoxesTester(instanceId); // Fallback jika tidak ada data grid
        }

        getEl(instanceId, 'allowance1').value = data.allowance1 || '0';
        getEl(instanceId, 'allowance2').value = data.allowance2 || '0'; 

        // Load Grid Sesi Hitungan
        const multiSessionGridEl = getEl(instanceId, 'multiSessionGrid');
        if (multiSessionGridEl) {
            multiSessionGridEl.innerHTML = ''; // Kosongkan
            sessionCounter[instanceId] = 0; // Reset counter
            
            if (data.sessionsGrid && data.sessionsGrid.length > 0) {
                data.sessionsGrid.forEach(sessionData => {
                    // 1. Buat sesi (baris) baru
                    sessionCounter[instanceId]++;
                    const sessionId = sessionCounter[instanceId];
                    const newSession = document.createElement('div');
                    newSession.className = 'hit-session';
                    newSession.dataset.sessionId = sessionId;
                    newSession.innerHTML = `
                        <div class="session-summary">
                            <span class="session-label">Hitungan ${sessionId}:</span>
                            <span class="results">
                                Œ£ <span id="${instanceId}_sessionSum${sessionId}" class="sum-value">0</span>
                            </span>
                        </div>
                        <div id="${instanceId}_sessionGrid${sessionId}" class="hit-grid"></div>
                    `;
                    multiSessionGridEl.appendChild(newSession);
                    
                    // 2. Isi grid (kolom) untuk sesi itu
                    const grid = document.getElementById(`${instanceId}_sessionGrid${sessionId}`);
                    if (grid && sessionData) {
                         sessionData.forEach(val => {
                            const box = document.createElement('div');
                            box.className = 'calc-box';
                            const input = document.createElement('input');
                            input.type = 'number';
                            input.placeholder = '0';
                            input.value = val || '';
                            input.oninput = function() { recalcSession(instanceId, sessionId); recalcAllHitungan(instanceId); };
                            box.appendChild(input);
                            grid.appendChild(box);
                        });
                        // Jika data tersimpan < 8, tambahkan sisanya
                        const diff = 8 - sessionData.length;
                        if (diff > 0) {
                            for (let i = 0; i < diff; i++) {
                                addCalcBox(`${instanceId}_multiSessionGrid`);
                            }
                        }
                    }
                });
            } else {
                // Fallback jika tidak ada data sesi tersimpan
                addHitunganSession(instanceId);
                addHitunganSession(instanceId);
            }
        }
        
        // Load data toggle/override
        const limitToggle = getEl(instanceId, 'limitKapasitasToggle');
        if (limitToggle) limitToggle.checked = data.limitKapasitasToggle !== undefined ? data.limitKapasitasToggle : true; // Default 'true'
        
        const manualToggle = getEl(instanceId, 'manualBenurToggle');
        if (manualToggle) manualToggle.checked = data.manualBenurToggle || false;
        
        const manualInput = getEl(instanceId, 'manualBenurOverride');
        if (manualInput) manualInput.value = data.manualBenurOverride || '';
        
        const simulasiToggle = getEl(instanceId, 'simulasiToggle');
        if (simulasiToggle) simulasiToggle.checked = data.simulasiToggle || false;
        
        // Update UI berdasarkan data toggle yang dimuat
        toggleManualBenurInput(instanceId); // Ini akan show/hide input override

        // Panggil semua fungsi kalkulasi ulang
        updateTruckDetails(instanceId);
        recalcAllTester(instanceId);
        recalcAllHitungan(instanceId);
        formatCurrency(getEl(instanceId, 'nominalOrder'));
        updateRecap(instanceId);
        
    } catch (e) {
        console.error(`Gagal memuat data ke ${instanceId}:`, e);
    }
}

// ===================================
// FLOATING CALCULATOR LOGIC
// ===================================

const calcContainer = document.getElementById('calculatorContainer');
const calcDisplay = document.getElementById('calcDisplay');
let currentInput = '0';
let previousValue = null;
let operator = null;
let waitingForNewInput = true;
function toggleCalculator() { calcContainer.classList.toggle('visible'); }
function calcClear() {
    currentInput = '0'; previousValue = null; operator = null; waitingForNewInput = true;
    updateCalcDisplay();
}
function updateCalcDisplay() {
    let displayValue = currentInput.includes('.') ? currentInput : parseFloat(currentInput).toLocaleString('id-ID', {maximumFractionDigits: 10});
    if (displayValue === 'NaN' || displayValue === 'Infinity' || !isFinite(currentInput)) {
         calcDisplay.value = 'Error';
    }
    else { calcDisplay.value = displayValue; }
}
function calcInput(value) {
    if (calcDisplay.value === 'Error') return;
    if (waitingForNewInput) {
        if (value === '.') { currentInput = '0.'; }
        else { currentInput = value; }
        waitingForNewInput = false;
    } else {
        if (value === '0' && currentInput === '0') return;
        if (value === '.' && currentInput.includes('.')) return;
        if (currentInput.length >= 15) return;
        if (currentInput === '0' && value !== '.') { currentInput = value; }
        else { currentInput += value; }
    }
    updateCalcDisplay();
}
function calcBackspace() {
    if (calcDisplay.value === 'Error') return;
    if (waitingForNewInput) return;
    if (currentInput.length > 1) {
        currentInput = currentInput.slice(0, -1);
    } else {
        currentInput = '0';
        waitingForNewInput = true;
    }
    updateCalcDisplay();
}
function calcPercent() {
    if (calcDisplay.value === 'Error') return;
    let currentValue = parseFloat(currentInput);
    if (previousValue !== null && operator !== null) {
        currentValue = (parseFloat(previousValue) / 100) * currentValue;
    } else {
        currentValue = currentValue / 100;
    }
    currentInput = currentValue.toString();
    updateCalcDisplay();
    waitingForNewInput = true;
}
function performCalculation(prev, current, op) {
    const prevNum = parseFloat(prev);
    const currNum = parseFloat(current);
    if (op === '/' && currNum === 0) return 'Error';
    let result;
    if (op === '+') result = (prevNum + currNum);
    else if (op === '-') result = (prevNum - currNum);
    else if (op === '*') result = (prevNum * currNum);
    else if (op === '/') result = (prevNum / currNum);
    else result = currNum;
    if (!isFinite(result)) return 'Error';
    result = parseFloat(result.toPrecision(15));
    return result.toString();
}
function calcOperator(nextOperator) {
     if (calcDisplay.value === 'Error') return;
    const inputValue = parseFloat(currentInput);
    if (operator && waitingForNewInput) {
        operator = nextOperator;
        return;
    }
    if (previousValue === null) {
        previousValue = inputValue;
    } else if (!waitingForNewInput) {
        const result = performCalculation(previousValue, currentInput, operator);
         if (result === 'Error') {
             currentInput = 'Error';
             updateCalcDisplay();
             previousValue = null;
             operator = null;
             waitingForNewInput = true;
             currentInput = '0';
             return;
         }
        currentInput = result;
        previousValue = parseFloat(result);
	updateCalcDisplay();
    }
    waitingForNewInput = true;
    operator = nextOperator;
}
function calcEquals() {
     if (calcDisplay.value === 'Error' || previousValue === null || operator === null) return;
    const result = performCalculation(previousValue, currentInput, operator);
     if (result === 'Error') {
         currentInput = 'Error';
         updateCalcDisplay();
         previousValue = null;
         operator = null;
         waitingForNewInput = true;
         currentInput = '0';
     } else {
         currentInput = result;
         updateCalcDisplay();
         previousValue = null;
         operator = null;
         waitingForNewInput = true;
     }
}


// ===================================
// [REVISI] FUNGSI KERANJANG SAMPAH (Menjadi Card)
// ===================================

function getTrashData() {
    const trashRaw = localStorage.getItem(TRASH_STORAGE_KEY);
    if (!trashRaw) { return []; }
    try {
        return JSON.parse(trashRaw);
    } catch (e) {
        console.error("Data keranjang sampah rusak:", e);
        return [];
    }
}

function saveTrashData(trashArray) {
    try {
        localStorage.setItem(TRASH_STORAGE_KEY, JSON.stringify(trashArray));
    } catch (e) {
        console.error("Gagal menyimpan keranjang sampah:", e);
        alert("Error saat menyimpan keranjang sampah.");
    }
}

function populateTrashList() {
    const trashArray = getTrashData();
    const listEls = document.querySelectorAll('#staticTrashList'); 
    
    if (listEls.length === 0) return;

    listEls.forEach(listEl => {
        listEl.innerHTML = ''; // Kosongkan daftar

        if (trashArray.length === 0) {
            listEl.innerHTML = '<p style="text-align: center; color: var(--color-text-light);">Keranjang sampah kosong.</p>';
        } else {
            trashArray.forEach((item, index) => {
                const info = item._trashInfo || { customer: (item.customer || 'Data Lama'), deletedOn: new Date().toISOString() };
                const customerName = info.customer || 'Tanpa Nama';
                const date = new Date(info.deletedOn).toLocaleString('id-ID', {
                    day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
                });

                const itemHTML = `
                    <div class="trash-modal-list-item">
                        <div class="trash-item-info">
                            <strong>${customerName}</strong>
                            <span>Dihapus: ${date}</span>
                        </div>
                        <div class="trash-item-actions">
                            <button class="btn restore" onclick="restoreFromTrash(${index})">‚Ü©Ô∏è Pulihkan</button>
                            <button class="btn delete" onclick="deleteFromTrash(${index})">‚ùå Hapus</button>
                        </div>
                    </div>
                `;
                listEl.insertAdjacentHTML('beforeend', itemHTML);
            });
        }
    });
}

function showTrash() {
    const cardEls = document.querySelectorAll('#trashCardContainer');
    if (cardEls.length === 0) return;
    const cardEl = cardEls[0];
    
    if (cardEl.style.display === 'none') {
        populateTrashList();
        cardEls.forEach(el => {
            el.style.display = 'block';
            el.scrollIntoView({ behavior: 'smooth', block: 'end' });
        });
    } else {
        cardEls.forEach(el => el.style.display = 'none');
    }
}

function restoreFromTrash(index) {
    if (!confirm("Pulihkan data ini? Data akan ditambahkan sebagai slide baru di akhir.")) return;

    let trashArray = getTrashData();
    if (!trashArray[index]) return;

    const [restoredData] = trashArray.splice(index, 1);
    delete restoredData._trashInfo;
    saveTrashData(trashArray);
    
    addInstance();
    const newInstanceId = `instance_${instanceCounter}`;
    loadDataFromObject(newInstanceId, restoredData);
    goToSlide(instanceCounter - 1);
    
    populateTrashList(); 
    alert("Data berhasil dipulihkan!");
}

function deleteFromTrash(index) {
    if (!confirm("Yakin ingin MENGHAPUS PERMANEN data ini? Tindakan ini tidak dapat dibatalkan.")) return;

    let trashArray = getTrashData();
    if (!trashArray[index]) return;

    trashArray.splice(index, 1);
    saveTrashData(trashArray);
    
    populateTrashList(); 
}
// === [AKHIR] FUNGSI KERANJANG SAMPAH ===


// ===================================
// [PERBAIKAN] INITIALIZATION
// ===================================

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('darkModeToggle').onclick = toggleDarkMode;

    // === Event listener untuk tombol navigasi melayang ===
    const floatingSaveBtn = document.getElementById('floatingSaveBtn');
    if (floatingSaveBtn) {
        floatingSaveBtn.onclick = () => {
            const track = document.getElementById('slideTrack');
            if (!track || !track.children[activeInstanceIndex]) {
                console.error('Tidak bisa menemukan slide yang aktif!');
                return;
            }
            const currentInstanceId = track.children[activeInstanceIndex].id;
            if (currentInstanceId) {
                saveData(currentInstanceId, false);
            } else {
                alert('Error: Tidak dapat menemukan ID slide saat ini untuk disimpan.');
            }
        };
    }
    const floatingPrevBtn = document.getElementById('floatingPrevBtn');
    if (floatingPrevBtn) {
        floatingPrevBtn.onclick = () => goToSlide(activeInstanceIndex - 1);
    }
    const floatingNextBtn = document.getElementById('floatingNextBtn');
    if (floatingNextBtn) {
        floatingNextBtn.onclick = () => goToSlide(activeInstanceIndex + 1);
    }
    // === Akhir listener navigasi melayang ===

    checkDarkModePreference();

    // === Logika Load Data Saat Membuka Halaman ===
    let savedInstanceCount = 0;
    try {
        const allKeys = Object.keys(localStorage);
        const instanceKeys = allKeys.filter(key => 
            key.startsWith(LOCAL_STORAGE_KEY) && key.includes('_instance_')
        );
        savedInstanceCount = instanceKeys.length;
    } catch (e) {
        console.warn("Gagal mengakses localStorage untuk load data:", e);
        savedInstanceCount = 0;
    }

    if (savedInstanceCount === 0) {
        addInstance(); // Buat 1 instance default
    } 
    else {
        // Loop untuk memuat data yang ada
        for (let i = 0; i < savedInstanceCount; i++) {
            const instanceIdToLoad = `instance_${i + 1}`;
            // 1. Buat DOM-nya dulu
            addInstance(); 
            // 2. Muat data ke DOM tersebut
            loadData(instanceIdToLoad, true); // Muat data (silent)
        }
    }
    
    goToSlide(0);
    calcClear();
});
</script>
</body>
</html>